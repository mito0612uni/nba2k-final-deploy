{% extends "layout.html" %}
{% block content %}
<style>
    /* --- „Éô„Éº„Çπ„Ç´„É©„ÉºÂÆöÁæ© --- */
    :root {
        --gold-primary: #e0c386;
        --gold-secondary: #bfa367;
        --dark-bg: #1a1a1a;
        --card-bg: #222;
        --text-color: #eee;
    }

    /* --- 1. ÈÅ∏Êâã„Éò„ÉÉ„ÉÄ„Éº --- */
    .player-header {
        display: flex; align-items: center; gap: 25px; margin-bottom: 30px;
        background: linear-gradient(135deg, #ffffff 0%, #f8f9fa 100%);
        padding: 30px; border-radius: 12px;
        box-shadow: 0 5px 20px rgba(0,0,0,0.05);
        border: 1px solid #e9ecef;
    }
    .player-header h1 { margin: 0; color: #333; font-size: 2.5rem; font-weight: 800; letter-spacing: -1px; }
    .player-header .team-logo { 
        height: 100px; width: 100px; object-fit: contain; 
        padding: 10px; background: white; border-radius: 50%;
        box-shadow: 0 4px 10px rgba(0,0,0,0.1);
    }
    .team-link { 
        display: inline-block; color: #666; font-weight: 600;
        font-size: 1.1rem; text-decoration: none; margin-top: 5px; 
        transition: color 0.2s;
    }
    .team-link:hover { color: #007bff; text-decoration: none; }

    /* --- 2. ÂèóË≥ûÊ≠¥„Çª„ÇØ„Ç∑„Éß„É≥ („É™„ÉÉ„ÉÅ„Éá„Ç∂„Ç§„É≥) --- */
    .awards-section {
        margin-bottom: 40px;
    }
    .awards-title {
        font-size: 1.3rem; font-weight: 800; color: #333;
        margin-bottom: 15px; display: flex; align-items: center; gap: 10px;
    }
    .awards-title::before { content: 'üèÜ'; font-size: 1.5rem; }
    
    .awards-grid {
        display: grid; grid-template-columns: repeat(auto-fill, minmax(200px, 1fr)); gap: 15px;
    }
    .award-card {
        background: linear-gradient(135deg, #fff 0%, #fdfdfd 100%);
        border: 1px solid #e0e0e0; border-radius: 10px;
        padding: 15px; display: flex; align-items: center; gap: 12px;
        box-shadow: 0 3px 8px rgba(0,0,0,0.03);
        transition: transform 0.2s, box-shadow 0.2s;
        position: relative; overflow: hidden;
    }
    .award-card:hover { transform: translateY(-3px); box-shadow: 0 6px 15px rgba(0,0,0,0.08); }
    
    /* ÈáëËâ≤„ÅÆ„Ç¢„ÇØ„Çª„É≥„Éà„É©„Ç§„É≥ */
    .award-card::before {
        content: ''; position: absolute; left: 0; top: 0; bottom: 0; width: 4px;
        background: linear-gradient(to bottom, var(--gold-primary), var(--gold-secondary));
    }
    
    .award-icon-box {
        width: 40px; height: 40px; border-radius: 50%;
        background: #fff8e1; color: #d4a017;
        display: flex; align-items: center; justify-content: center;
        font-size: 1.2rem; flex-shrink: 0;
    }
    /* „Çπ„Çø„ÉÉ„ÉÑ„É™„Éº„ÉÄ„ÉºÁî®„ÅÆ„Ç¢„Ç§„Ç≥„É≥Ëâ≤ (ÈùíÁ≥ª) */
    .award-icon-box.stat-leader {
        background: #e3f2fd; color: #1976d2;
    }

    .award-info { display: flex; flex-direction: column; }
    .award-name { font-weight: 700; color: #333; font-size: 0.95rem; line-height: 1.2; }
    .award-date { font-size: 0.75rem; color: #888; margin-top: 3px; }

    /* --- 3. „Çπ„Çø„ÉÉ„ÉÑ„Çª„ÇØ„Ç∑„Éß„É≥ --- */
    .stats-section-title { font-size: 1.2rem; font-weight: 700; color: #555; margin-bottom: 15px; border-left: 4px solid #333; padding-left: 10px; }
    
    .stats-grid {
        display: grid; grid-template-columns: repeat(auto-fit, minmax(110px, 1fr)); gap: 12px; margin-bottom: 40px;
    }
    .stat-box {
        background: #fff; border: 1px solid #eee; border-radius: 8px; padding: 15px 10px;
        text-align: center; box-shadow: 0 2px 5px rgba(0,0,0,0.02);
    }
    .stat-label { font-size: 0.8rem; color: #777; text-transform: uppercase; letter-spacing: 0.5px; margin-bottom: 5px; }
    .stat-val { font-size: 1.6rem; font-weight: 800; color: #222; line-height: 1; }
    .stat-rank { 
        font-size: 0.75rem; color: #fff; background: #999; 
        padding: 2px 8px; border-radius: 10px; display: inline-block; margin-top: 5px; 
    }
    
    /* „É©„É≥„ÇØÂà•Ëâ≤ÂàÜ„Åë */
    .stat-box.top .stat-val { color: #dc3545; }
    .stat-box.top .stat-rank { background: #dc3545; }
    .stat-box.good .stat-val { color: #d39e00; }
    .stat-box.good .stat-rank { background: #ffc107; color: #333; }

    /* --- 4. „Ç∞„É©„Éï & „É≠„Ç∞ --- */
    .chart-wrapper { background: #fff; padding: 20px; border-radius: 12px; border: 1px solid #eee; margin-bottom: 40px; }
    
    .log-table { width: 100%; border-collapse: collapse; font-size: 0.9rem; }
    .log-table th { background: #343a40; color: #fff; padding: 10px; text-align: center; }
    .log-table td { padding: 10px; border-bottom: 1px solid #eee; text-align: center; color: #333; }
    .log-table tr:hover { background: #f8f9fa; }
    .log-table .text-left { text-align: left; }

    /* --- 5. „Ç´„Éº„Éâ„Ç∏„Çß„Éç„É¨„Éº„Çø„Éº --- */
    .generator-wrapper {
        background: #111; color: #eee; padding: 40px 20px; border-radius: 16px;
        box-shadow: 0 10px 30px rgba(0,0,0,0.5); margin-top: 60px;
        border: 1px solid #333;
    }
    .gen-title { text-align: center; color: var(--gold-primary); font-size: 1.5rem; font-weight: bold; margin-bottom: 30px; letter-spacing: 1px; }
    
    .gen-container { display: flex; gap: 40px; justify-content: center; flex-wrap: wrap; }
    .gen-controls { flex: 1; min-width: 300px; max-width: 350px; }
    .gen-preview { flex: 1; min-width: 450px; display: flex; justify-content: center; }

    /* „ÉÅ„Çß„ÉÉ„ÇØ„Éú„ÉÉ„ÇØ„Çπ */
    .stat-selector { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-bottom: 25px; }
    .custom-check {
        display: flex; align-items: center; cursor: pointer; padding: 8px 12px;
        background: #2a2a2a; border-radius: 6px; transition: 0.2s; border: 1px solid #333;
    }
    .custom-check:hover { background: #333; }
    .custom-check input { margin-right: 10px; accent-color: var(--gold-primary); }
    
    .dl-btn {
        background: linear-gradient(135deg, var(--gold-secondary) 0%, var(--gold-primary) 100%);
        color: #000; font-weight: 800; border: none; padding: 15px 0; width: 100%;
        border-radius: 30px; font-size: 1rem; cursor: pointer; transition: transform 0.2s;
        box-shadow: 0 4px 15px rgba(224, 195, 134, 0.3);
    }
    .dl-btn:hover { transform: translateY(-2px); box-shadow: 0 6px 20px rgba(224, 195, 134, 0.5); }
    .dl-btn:disabled { opacity: 0.7; cursor: not-allowed; }

    /* === „Ç´„Éº„Éâ„Ç≠„É£„É≥„Éê„Çπ (ÈáçË¶Å) === */
    #player-card-canvas {
        width: 600px; height: 350px; /* „Çµ„Ç§„Ç∫Âõ∫ÂÆö */
        background: radial-gradient(circle at center, #2a2a2a 0%, #000 100%);
        position: relative; border-radius: 16px; overflow: hidden;
        border: 2px solid var(--gold-primary);
        box-shadow: 0 15px 40px rgba(0,0,0,0.6);
        font-family: 'Arial', sans-serif;
    }
    
    /* ËÉåÊôØ„Ç®„Éï„Çß„ÇØ„Éà */
    .card-bg-effect {
        position: absolute; top: 0; left: 0; right: 0; bottom: 0;
        background-image: url('https://www.transparenttextures.com/patterns/carbon-fibre.png'); /* „Éë„Çø„Éº„É≥ */
        opacity: 0.3; z-index: 1;
    }
    
    /* È£æ„ÇäÊû† */
    .card-border-inner {
        position: absolute; top: 12px; left: 12px; right: 12px; bottom: 12px;
        border: 1px solid rgba(224, 195, 134, 0.4);
        border-radius: 10px; z-index: 2; pointer-events: none;
    }

    /* Â∑¶ÂÅ¥: „É°„Ç§„É≥ÁîªÂÉè */
    .card-left {
        position: absolute; top: 0; left: 0; width: 55%; height: 100%;
        display: flex; justify-content: center; align-items: center; z-index: 5;
    }
    .card-team-logo {
        max-width: 85%; max-height: 85%; object-fit: contain;
        filter: drop-shadow(0 10px 20px rgba(0,0,0,0.5));
    }

    /* ÂèóË≥û„Éê„ÉÉ„Ç∏ („Ç´„Éº„ÉâÂÜÖ) */
    .card-award-badge {
        position: absolute; top: 25px; left: 25px; z-index: 10;
        background: linear-gradient(90deg, #d4af37, #f2d06b);
        color: #000; font-weight: 900; font-size: 0.8rem;
        padding: 6px 15px; border-radius: 4px;
        box-shadow: 0 4px 10px rgba(0,0,0,0.4);
        text-transform: uppercase; letter-spacing: 1px;
        display: flex; align-items: center; gap: 6px;
    }

    /* ÈÅ∏ÊâãÂêç */
    .card-player-name {
        position: absolute; bottom: 25px; left: 25px; z-index: 10;
        text-align: left;
    }
    .card-name-main {
        font-size: 2.2rem; font-weight: 900; color: #fff;
        line-height: 0.9; text-transform: uppercase;
        text-shadow: 2px 2px 0px #000;
        font-style: italic;
    }
    .card-team-sub {
        font-size: 0.9rem; color: var(--gold-primary); font-weight: 600;
        margin-top: 5px; text-shadow: 1px 1px 2px #000;
    }

    /* Âè≥ÂÅ¥: „Çπ„Çø„ÉÉ„ÉÑ„Éë„Éç„É´ */
    .card-right {
        position: absolute; top: 0; right: 0; width: 45%; height: 100%;
        background: rgba(20, 20, 20, 0.85);
        backdrop-filter: blur(4px);
        border-left: 2px solid var(--gold-primary);
        z-index: 6; display: flex; flex-direction: column; justify-content: center;
        padding: 0 30px; box-sizing: border-box;
    }
    
    .card-stat-row {
        display: flex; justify-content: space-between; align-items: baseline;
        padding: 10px 0; border-bottom: 1px solid rgba(255,255,255,0.1);
    }
    .card-stat-row:last-child { border-bottom: none; }
    
    .c-label { color: #aaa; font-weight: 700; font-size: 1.1rem; }
    .c-val { color: #fff; font-weight: 900; font-size: 1.8rem; text-shadow: 0 2px 4px rgba(0,0,0,0.5); }

    /* „É¨„Çπ„Éù„É≥„Ç∑„Éñ */
    @media (max-width: 768px) {
        .gen-container { flex-direction: column; }
        .gen-preview { width: 100%; overflow: hidden; }
        #player-card-canvas { transform: scale(0.65); transform-origin: top center; margin-bottom: -120px; }
    }
</style>

<div class="container mt-4">
    <div class="player-header">
        {% if player.team.logo_image %}
        <img src="{{ player.team.logo_image }}" alt="{{ player.team.name }}" class="team-logo">
        {% endif %}
        <div>
            <h1 style="margin-bottom: 5px;">{{ player.name }}</h1>
            <a href="{{ url_for('team_detail', team_id=player.team.id) }}" class="team-link">
                {{ player.team.name }}
            </a>
        </div>
    </div>

    {% if awards %}
    <div class="awards-section">
        <div class="awards-title">HONORS & AWARDS</div>
        <div class="awards-grid">
            {% for award in awards %}
            <div class="award-card">
                <div class="award-icon-box {% if award.type == 'stat_leader' %}stat-leader{% endif %}">
                    {% if award.type == 'weekly' %}üî•
                    {% elif award.type == 'all_star' %}‚≠ê
                    {% elif award.type == 'stat_leader' %}üìä
                    {% else %}üèÜ{% endif %}
                </div>
                <div class="award-info">
                    <div class="award-name">{{ award.title }}</div>
                    <div class="award-date">{{ award.date }}</div>
                </div>
            </div>
            {% endfor %}
        </div>
    </div>
    {% endif %}

    {% if stats %}
    <div class="stats-section-title">SEASON STATS (Avg)</div>
    <div class="stats-grid">
        {% for key in ['avg_pts', 'fg_pct', 'three_p_pct', 'ft_pct', 'avg_reb', 'avg_ast', 'avg_stl', 'avg_blk', 'avg_turnover', 'avg_foul'] %}
            {% set item = stats[key] %}
            <div class="stat-box {% if 'top' in item.color_class %}top{% elif 'good' in item.color_class %}good{% endif %}">
                <div class="stat-label">{{ item.label }}</div>
                <div class="stat-val">{{ "%.1f"|format(item.value) }}{% if 'pct' in key %}<span style="font-size:0.6em">%</span>{% endif %}</div>
                <div class="stat-rank">{{ item.rank }}‰Ωç</div>
            </div>
        {% endfor %}
    </div>

    <div class="chart-wrapper">
        <h5 style="margin-bottom:20px; color:#555; font-weight:bold;">Game Log Chart</h5>
        <canvas id="playerLineChart" height="80"></canvas>
    </div>
    
    {% else %}
        <p class="text-muted">No stats available for this season.</p>
    {% endif %}

    <h4 style="margin-top:40px; margin-bottom:15px; font-weight:bold; color:#333;">Game Logs</h4>
    <div class="table-responsive" style="background:#fff; border-radius:8px; border:1px solid #ddd; overflow:hidden;">
        <table class="log-table">
            <thead>
                <tr>
                    <th>Date</th><th>Opponent</th><th>Result</th>
                    <th>PTS</th><th>REB</th><th>AST</th><th>STL</th><th>BLK</th><th>TO</th>
                    <th>FG</th><th>3P</th><th>FT</th>
                </tr>
            </thead>
            <tbody>
                {% for stat_entry in game_stats %}
                    {% set stat = stat_entry[0] %}
                    {% set g = stat_entry %} 
                    {% set is_home = (player.team_id == g[2]) %}
                    {% set opp_name = g[5] if is_home else g[4] %}
                    {% set opp_id = g[3] if is_home else g[2] %}
                    {% set prefix = "vs" if not is_home else "@" %} 
                    
                    {% set my_score = g[6] if is_home else g[7] %}
                    {% set opp_score = g[7] if is_home else g[6] %}
                    {% set res_char = "W" if my_score > opp_score else "L" %}
                    {% set res_color = "#28a745" if res_char == "W" else "#dc3545" %}

                <tr>
                    <td>{{ g[1] }}</td>
                    <td class="text-left">
                        <span style="color:#999; font-size:0.8em; margin-right:5px;">{{ prefix }}</span>
                        <a href="{{ url_for('team_detail', team_id=opp_id) }}" style="font-weight:bold; text-decoration:none; color:#333;">
                            {{ opp_name }}
                        </a>
                    </td>
                    <td>
                        <span style="color:{{ res_color }}; font-weight:bold;">{{ res_char }}</span>
                        <span style="font-size:0.85em; color:#666;"> {{ my_score }}-{{ opp_score }}</span>
                    </td>
                    <td><strong>{{ stat.pts }}</strong></td>
                    <td>{{ stat.reb }}</td><td>{{ stat.ast }}</td><td>{{ stat.stl }}</td><td>{{ stat.blk }}</td><td>{{ stat.turnover }}</td>
                    <td>{{ stat.fgm }}/{{ stat.fga }}</td><td>{{ stat.three_pm }}/{{ stat.three_pa }}</td><td>{{ stat.ftm }}/{{ stat.fta }}</td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>

    <div class="generator-wrapper">
        <div class="gen-title">PLAYER CARD GENERATOR</div>
        
        <div class="gen-container">
            <div class="gen-controls">
                <p style="color:#aaa; font-size:0.9rem; margin-bottom:15px;">Ë°®Á§∫„Åô„Çã„Çπ„Çø„ÉÉ„ÉÑ„ÇíÈÅ∏Êäû (ÊúÄÂ§ß6„Å§)</p>
                <div class="stat-selector">
                    {% set available_stats = [
                        ('PTS', avg_stats.avg_pts, 'ÂæóÁÇπ'), ('REB', avg_stats.avg_reb, '„É™„Éê„Ç¶„É≥„Éâ'),
                        ('AST', avg_stats.avg_ast, '„Ç¢„Ç∑„Çπ„Éà'), ('STL', avg_stats.avg_stl, '„Çπ„ÉÜ„Ç£„Éº„É´'),
                        ('BLK', avg_stats.avg_blk, '„Éñ„É≠„ÉÉ„ÇØ'), ('FG%', avg_stats.fg_pct, 'FG%'),
                        ('3P%', avg_stats.three_p_pct, '3P%'), ('FT%', avg_stats.ft_pct, 'FT%'),
                        ('TO', avg_stats.avg_turnover, 'TO')
                    ] %}
                    
                    {% for label, value, jp in available_stats %}
                    <label class="custom-check">
                        <input type="checkbox" name="card_stats" value="{{ label }}" data-val="{{ value|round(1) }}" {% if loop.index <= 6 %}checked{% endif %}>
                        <span>{{ label }}</span>
                    </label>
                    {% endfor %}
                </div>
                <button id="download-btn" class="dl-btn">DOWNLOAD CARD IMAGE</button>
            </div>

            <div class="gen-preview">
                <div id="player-card-canvas">
                    <div class="card-bg-effect"></div>
                    <div class="card-border-inner"></div>

                    {% if awards %}
                    <div class="card-award-badge">
                        <span>üèÜ</span> {{ awards[0].title }}
                    </div>
                    {% endif %}

                    <div class="card-left">
                        {% if player.team.logo_image %}
                        <img src="{{ player.team.logo_image }}" class="card-team-logo" crossorigin="anonymous">
                        {% endif %}
                        
                        <div class="card-player-name">
                            <div class="card-name-main">{{ player.name }}</div>
                            <div class="card-team-sub">{{ player.team.name }} | {{ player.team.league }}</div>
                        </div>
                    </div>

                    <div class="card-right">
                        {% for i in range(1, 7) %}
                        <div class="card-stat-row" id="slot-{{ i }}">
                            <span class="c-label">PTS</span>
                            <span class="c-val">0.0</span>
                        </div>
                        {% endfor %}
                    </div>
                </div>
            </div>
        </div>
    </div>

</div>
{% endblock %}

{% block scripts %}
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="https://html2canvas.hertzen.com/dist/html2canvas.min.js"></script>
<script>
document.addEventListener('DOMContentLoaded', function() {
    // --- 1. „Ç∞„É©„ÉïÊèèÁîª ---
    {% if stats %}
    const logs = [
        {% for s in game_stats %}
        { 
            date: "{{ s[1] }}", 
            pts: {{ s[0].pts }}, 
            reb: {{ s[0].reb }}, 
            ast: {{ s[0].ast }},
            stl: {{ s[0].stl }}, 
            blk: {{ s[0].blk }}  
        },
        {% endfor %}
    ].reverse();

    new Chart(document.getElementById('playerLineChart'), {
        type: 'line',
        data: {
            labels: logs.map(d => d.date),
            datasets: [
                { label: 'PTS', data: logs.map(d => d.pts), borderColor: '#dc3545', tension: 0.3, fill: false },
                { label: 'REB', data: logs.map(d => d.reb), borderColor: '#007bff', tension: 0.3, hidden: true },
                { label: 'AST', data: logs.map(d => d.ast), borderColor: '#28a745', tension: 0.3, hidden: true },
                { label: 'STL', data: logs.map(d => d.stl), borderColor: '#6f42c1', tension: 0.3, hidden: true },
                { label: 'BLK', data: logs.map(d => d.blk), borderColor: '#fd7e14', tension: 0.3, hidden: true }
            ]
        },
        options: { responsive: true, interaction: { mode: 'index', intersect: false } }
    });
    {% endif %}

    // --- 2. „Ç´„Éº„ÉâÁîüÊàê„É≠„Ç∏„ÉÉ„ÇØ ---
    const checks = document.querySelectorAll('input[name="card_stats"]');
    const slots = [];
    for(let i=1; i<=6; i++) slots.push(document.getElementById(`slot-${i}`));

    function updateCard() {
        let active = [];
        checks.forEach(c => {
            if(c.checked) active.push({ label: c.value, val: c.dataset.val });
        });

        // Âà∂Èôê
        checks.forEach(c => {
            if(!c.checked) c.disabled = (active.length >= 6);
            else c.disabled = false;
        });

        // ÊèèÁîª
        slots.forEach((el, idx) => {
            if(active[idx]) {
                el.style.display = 'flex';
                el.querySelector('.c-label').innerText = active[idx].label;
                let v = active[idx].val;
                if(active[idx].label.includes('%')) v += '%';
                el.querySelector('.c-val').innerText = v;
            } else {
                el.style.display = 'none';
            }
        });
    }

    checks.forEach(c => c.addEventListener('change', updateCard));
    updateCard(); // init

    // „ÉÄ„Ç¶„É≥„É≠„Éº„Éâ
    document.getElementById('download-btn').addEventListener('click', function() {
        const btn = this;
        btn.innerText = 'GENERATING...';
        btn.disabled = true;
        
        const node = document.getElementById('player-card-canvas');
        
        html2canvas(node, {
            scale: 2, 
            useCORS: true,
            backgroundColor: null
        }).then(canvas => {
            const link = document.createElement('a');
            link.download = `{{ player.name }}_Card.png`;
            link.href = canvas.toDataURL('image/png');
            link.click();
            btn.innerText = 'DOWNLOAD CARD IMAGE';
            btn.disabled = false;
        }).catch(e => {
            alert('Error generating image');
            console.error(e);
            btn.innerText = 'DOWNLOAD CARD IMAGE';
            btn.disabled = false;
        });
    });
});
</script>
{% endblock %}