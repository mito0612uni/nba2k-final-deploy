{% extends "layout.html" %}
{% block content %}
<link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;700;900&family=Teko:wght@300;500;700&display=swap" rel="stylesheet">

<style>
    /* --- „Éô„Éº„ÇπÂ§âÊï∞ --- */
    :root {
        --gold-light: #f5dba3;
        --gold-main: #d4af37;
        --gold-dark: #aa8420;
        --card-bg-dark: #0f0f0f;
    }

    /* --- 1. ÈÅ∏Êâã„Éò„ÉÉ„ÉÄ„Éº --- */
    .player-header {
        display: flex; align-items: center; gap: 25px; margin-bottom: 30px;
        background: linear-gradient(135deg, #ffffff 0%, #f8f9fa 100%);
        padding: 30px; border-radius: 12px;
        box-shadow: 0 5px 20px rgba(0,0,0,0.05);
        border: 1px solid #e9ecef;
    }
    .player-header h1 { margin: 0; color: #333; font-size: 2.5rem; font-weight: 800; font-family: 'Roboto', sans-serif; }
    .player-header .team-logo { 
        height: 100px; width: 100px; object-fit: contain; 
        padding: 10px; background: white; border-radius: 50%;
        box-shadow: 0 4px 10px rgba(0,0,0,0.1);
    }
    .team-link { 
        display: inline-block; color: #666; font-weight: 600;
        font-size: 1.1rem; text-decoration: none; margin-top: 5px; 
    }
    .team-link:hover { color: #007bff; }

    /* --- 2. ÂèóË≥ûÊ≠¥„Çª„ÇØ„Ç∑„Éß„É≥ --- */
    .awards-section { margin-bottom: 40px; }
    .awards-title { font-size: 1.3rem; font-weight: 800; color: #333; margin-bottom: 15px; }
    .awards-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(220px, 1fr)); gap: 15px; }
    
    .award-card {
        background: #fff; border: 1px solid #eee; border-radius: 8px; padding: 12px;
        display: flex; align-items: center; gap: 10px; box-shadow: 0 2px 5px rgba(0,0,0,0.05);
        transition: transform 0.2s;
    }
    .award-card:hover { transform: translateY(-2px); border-color: var(--gold-main); }
    .award-icon-box {
        width: 35px; height: 35px; background: #fff8e1; color: var(--gold-dark);
        border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 1.2rem;
    }
    .award-icon-box.stat-leader { background: #e3f2fd; color: #1976d2; }
    .award-name { font-weight: 700; font-size: 0.9rem; line-height: 1.2; color: #333; }
    .award-date { font-size: 0.75rem; color: #888; }

    /* --- 3. „Çπ„Çø„ÉÉ„ÉÑ„Çª„ÇØ„Ç∑„Éß„É≥ --- */
    .stats-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(100px, 1fr)); gap: 10px; margin-bottom: 30px; }
    .stat-box { background: #fff; border: 1px solid #eee; border-radius: 6px; padding: 10px; text-align: center; }
    .stat-label { font-size: 0.75rem; color: #777; font-weight: bold; }
    .stat-val { font-size: 1.4rem; font-weight: 800; color: #222; font-family: 'Teko', sans-serif; }
    .stat-rank { font-size: 0.7rem; background: #eee; padding: 2px 6px; border-radius: 4px; display: inline-block; }
    
    .stat-box.top .stat-val { color: #dc3545; }
    .stat-box.good .stat-val { color: #d39e00; }

    /* --- 4. „Ç∞„É©„Éï & „É≠„Ç∞ --- */
    .chart-wrapper { background: #fff; padding: 15px; border-radius: 8px; border: 1px solid #eee; margin-bottom: 30px; }
    .log-table { width: 100%; border-collapse: collapse; font-size: 0.85rem; }
    .log-table th { background: #333; color: #fff; padding: 8px; text-align: center; }
    .log-table td { padding: 8px; border-bottom: 1px solid #eee; text-align: center; }
    .log-table .text-left { text-align: left; }

    /* --- 5. „Ç´„Éº„Éâ„Ç∏„Çß„Éç„É¨„Éº„Çø„Éº --- */
    .generator-wrapper {
        background: #111; color: #eee; padding: 40px 20px; border-radius: 16px;
        box-shadow: 0 10px 30px rgba(0,0,0,0.8); margin-top: 60px; border: 1px solid #333;
        background-image: radial-gradient(circle at 50% 0%, #222 0%, #111 70%);
    }
    .gen-title { 
        text-align: center; color: var(--gold-light); font-size: 1.8rem; 
        font-family: 'Teko', sans-serif; letter-spacing: 2px; margin-bottom: 30px; 
        text-shadow: 0 0 10px rgba(212, 175, 55, 0.3);
    }
    
    .gen-container { display: flex; gap: 40px; justify-content: center; flex-wrap: wrap; }
    .gen-controls { flex: 1; min-width: 300px; max-width: 350px; }
    .gen-preview { flex: 1; min-width: 550px; display: flex; justify-content: center; }

    /* „ÉÅ„Çß„ÉÉ„ÇØ„Éú„ÉÉ„ÇØ„Çπ */
    .stat-selector { display: grid; grid-template-columns: 1fr 1fr; gap: 8px; margin-bottom: 20px; }
    .custom-check {
        display: flex; align-items: center; cursor: pointer; padding: 10px;
        background: #1f1f1f; border-radius: 4px; border: 1px solid #333; transition: 0.2s;
    }
    .custom-check:hover { border-color: var(--gold-main); }
    .custom-check input { margin-right: 10px; accent-color: var(--gold-main); }
    .custom-check span { font-family: 'Roboto', sans-serif; font-size: 0.9rem; }

    .dl-btn {
        background: linear-gradient(135deg, var(--gold-main) 0%, var(--gold-dark) 100%);
        color: #fff; font-weight: 800; border: none; padding: 15px 0; width: 100%;
        border-radius: 4px; font-size: 1.1rem; cursor: pointer; transition: transform 0.2s;
        font-family: 'Teko', sans-serif; letter-spacing: 1px;
        box-shadow: 0 4px 15px rgba(0,0,0,0.3);
        border: 1px solid var(--gold-light);
    }
    .dl-btn:hover { transform: translateY(-2px); box-shadow: 0 6px 20px rgba(212, 175, 55, 0.4); }
    .dl-btn:disabled { opacity: 0.6; cursor: not-allowed; }

    /* ========================================= */
    /* === „Ç´„Éº„Éâ„Ç≠„É£„É≥„Éê„Çπ (Visual Update) === */
    /* ========================================= */
    #player-card-canvas {
        width: 600px; height: 380px;
        background: #000;
        position: relative; border-radius: 20px; overflow: hidden;
        border: 3px solid var(--gold-main);
        box-shadow: 0 20px 50px rgba(0,0,0,0.8);
        font-family: 'Roboto', sans-serif;
        background: radial-gradient(circle at 30% 50%, #2a2a2a 0%, #000 80%);
    }

    .card-bg-pattern {
        position: absolute; top: 0; left: 0; width: 100%; height: 100%;
        background-image: linear-gradient(45deg, #111 25%, transparent 25%, transparent 75%, #111 75%, #111), 
                          linear-gradient(45deg, #111 25%, transparent 25%, transparent 75%, #111 75%, #111);
        background-size: 20px 20px;
        background-position: 0 0, 10px 10px;
        opacity: 0.2; z-index: 1;
    }

    .card-frame-outer {
        position: absolute; top: 8px; left: 8px; right: 8px; bottom: 8px;
        border: 2px solid var(--gold-dark); border-radius: 14px; z-index: 2; pointer-events: none;
    }
    .card-frame-inner {
        position: absolute; top: 14px; left: 14px; right: 14px; bottom: 14px;
        border: 1px solid var(--gold-light); border-radius: 10px; z-index: 2; pointer-events: none;
        opacity: 0.5;
    }

    /* Â∑¶ÂÅ¥: „É°„Ç§„É≥„Éì„Ç∏„É•„Ç¢„É´ */
    .card-main-visual {
        position: absolute; top: 20px; left: 20px; width: 340px; height: 340px;
        display: flex; justify-content: center; align-items: center; z-index: 5;
    }
    .card-team-logo {
        max-width: 90%; max-height: 90%; object-fit: contain;
        filter: drop-shadow(0 15px 30px rgba(0,0,0,0.8));
    }

    /* Ë§áÊï∞ÂèóË≥ûÊ≠¥ (Â∑¶‰∏ä„Çπ„Çø„ÉÉ„ÇØ) */
    .card-awards-stack {
        position: absolute; top: 25px; left: 25px; z-index: 20;
        display: flex; flex-direction: column; gap: 6px; align-items: flex-start;
    }
    .card-award-pill {
        background: linear-gradient(90deg, rgba(212, 175, 55, 0.9), rgba(170, 132, 32, 0.8));
        color: #000; font-family: 'Teko', sans-serif; font-weight: 600; font-size: 1rem;
        padding: 2px 12px 0 8px; border-radius: 4px;
        box-shadow: 2px 2px 5px rgba(0,0,0,0.5);
        text-transform: uppercase; letter-spacing: 0.5px;
        display: flex; align-items: center; gap: 5px;
        border-left: 3px solid #fff;
        max-width: 250px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis;
    }
    .ca-icon { font-size: 0.9em; }

    /* ‚òÖ‚òÖ‚òÖ ‰∏ãÈÉ®: ÈÅ∏ÊâãÊÉÖÂ†± („Éá„Ç∂„Ç§„É≥‰øÆÊ≠£) ‚òÖ‚òÖ‚òÖ */
    .card-player-info {
        position: absolute; bottom: 25px; left: 30px; z-index: 30; /* z-index„Çí‰∏ä„Åí„Å¶„É≠„Ç¥„Çà„ÇäÊâãÂâç„Å´ */
    }
    .card-p-name {
        color: #ffffff; /* ÂÆåÂÖ®„Å™ÁôΩ */
        font-family: 'Teko', sans-serif; font-weight: 700;
        font-size: 3.8rem; /* „Çµ„Ç§„Ç∫Êã°Â§ß */
        line-height: 0.85; 
        text-transform: uppercase;
        /* ÁôΩÊñáÂ≠ó + Èªí„ÅÑÁ∏ÅÂèñ„Çä(Âº∑„ÇÅ) + ÈáëËâ≤„ÅÆÂÖâÂΩ© */
        text-shadow: 
            3px 3px 0 #000000, 
            -1px -1px 0 #000000,
            1px -1px 0 #000000,
            -1px 1px 0 #000000,
            1px 1px 0 #000000,
            0 0 20px rgba(212, 175, 55, 0.8);
        margin-bottom: 5px;
    }
    .card-t-name {
        color: var(--gold-main); 
        font-family: 'Roboto', sans-serif; font-weight: 900;
        font-size: 1.3rem; /* „Çµ„Ç§„Ç∫Êã°Â§ß */
        text-transform: uppercase; 
        margin-left: 2px;
        text-shadow: 2px 2px 0 #000000; /* Èªí„ÅÑÂΩ± */
        letter-spacing: 1px;
    }

    /* Âè≥ÂÅ¥: „Çπ„Çø„ÉÉ„ÉÑ„Éë„Éç„É´ */
    .card-stats-sidebar {
        position: absolute; top: 0; right: 0; width: 220px; height: 100%;
        background: rgba(15, 15, 15, 0.9); /* ËÉåÊôØ„ÇíÂ∞ë„ÅóÊøÉ„Åè */
        border-left: 3px solid var(--gold-main);
        z-index: 15; display: flex; flex-direction: column; justify-content: center;
        padding: 0 25px; box-sizing: border-box;
        box-shadow: -10px 0 30px rgba(0,0,0,0.8);
    }
    
    .card-stats-sidebar::before {
        content: ''; position: absolute; top: 0; left: 0; width: 100%; height: 100%;
        background: repeating-linear-gradient(45deg, transparent, transparent 10px, rgba(255,255,255,0.03) 10px, rgba(255,255,255,0.03) 20px);
        pointer-events: none;
    }

    .card-ovr-box {
        text-align: right; margin-bottom: 15px; border-bottom: 2px solid var(--gold-dark);
        padding-bottom: 5px;
    }
    .card-ovr-label { color: var(--gold-light); font-size: 0.9rem; font-weight: bold; letter-spacing: 2px; }
    .card-ovr-val { 
        color: #fff; font-family: 'Teko', sans-serif; font-size: 3.5rem; line-height: 0.8; font-weight: 700; 
        text-shadow: 0 0 10px rgba(255,255,255,0.5);
    }

    .card-stat-row {
        display: flex; justify-content: space-between; align-items: baseline;
        padding: 6px 0; border-bottom: 1px solid rgba(255,255,255,0.15);
    }
    .card-stat-row:last-child { border-bottom: none; }
    
    .cs-label { 
        color: var(--gold-light); font-family: 'Roboto', sans-serif; font-weight: 900; 
        font-size: 1.2rem; text-transform: uppercase; 
    }
    .cs-val { 
        color: #fff; font-family: 'Teko', sans-serif; font-weight: 500; 
        font-size: 2.2rem; line-height: 1; text-shadow: 2px 2px 0 rgba(0,0,0,0.5);
    }

    @media (max-width: 768px) {
        .gen-container { flex-direction: column; align-items: center; }
        .gen-preview { width: 100%; min-width: auto; overflow: hidden; display: flex; justify-content: center; }
        #player-card-canvas { transform: scale(0.65); transform-origin: top center; margin-bottom: -130px; }
    }
</style>

<div class="container mt-4">
    <div class="player-header">
        {% if player.team.logo_image %}
        <img src="{{ player.team.logo_image }}" alt="{{ player.team.name }}" class="team-logo">
        {% endif %}
        <div>
            <h1>{{ player.name }}</h1>
            <a href="{{ url_for('team_detail', team_id=player.team.id) }}" class="team-link">
                {{ player.team.name }}
            </a>
        </div>
    </div>

    {% if awards %}
    <div class="awards-section">
        <div class="awards-title">üèÜ HONORS & AWARDS</div>
        <div class="awards-grid">
            {% for award in awards %}
            <div class="award-card">
                <div class="award-icon-box {% if award.type == 'stat_leader' %}stat-leader{% endif %}">
                    {% if award.type == 'weekly' %}üî•
                    {% elif award.type == 'monthly' %}üåô
                    {% elif award.type == 'all_star' %}‚≠ê
                    {% elif award.type == 'stat_leader' %}üìä
                    {% else %}üèÜ{% endif %}
                </div>
                <div>
                    <div class="award-name">{{ award.title }}</div>
                    <div class="award-date">{{ award.date }}</div>
                </div>
            </div>
            {% endfor %}
        </div>
    </div>
    {% endif %}

    {% if stats %}
    <h4 style="margin-bottom:15px; font-weight:bold; color:#555;">SEASON STATS</h4>
    <div class="stats-grid">
        {% for key in ['avg_pts', 'fg_pct', 'three_p_pct', 'ft_pct', 'avg_reb', 'avg_ast', 'avg_stl', 'avg_blk', 'avg_turnover', 'avg_foul'] %}
            {% set item = stats[key] %}
            <div class="stat-box {% if 'top' in item.color_class %}top{% elif 'good' in item.color_class %}good{% endif %}">
                <div class="stat-label">{{ item.label }}</div>
                <div class="stat-val">{{ "%.1f"|format(item.value) }}{% if 'pct' in key %}<span style="font-size:0.6em">%</span>{% endif %}</div>
                <div class="stat-rank">{{ item.rank }}‰Ωç</div>
            </div>
        {% endfor %}
    </div>

    <div class="chart-wrapper">
        <h5 style="margin-bottom:20px; font-weight:bold;">Game Log Chart</h5>
        <canvas id="playerLineChart" height="80"></canvas>
    </div>
    {% else %}
        <p class="text-muted">No stats available.</p>
    {% endif %}

    <h4 style="margin-top:40px; margin-bottom:15px; font-weight:bold;">Game Logs</h4>
    <div class="table-responsive" style="background:#fff; border:1px solid #ddd; overflow:hidden;">
        <table class="log-table">
            <thead>
                <tr>
                    <th>Date</th><th>Opponent</th><th>Result</th>
                    <th>PTS</th><th>REB</th><th>AST</th><th>STL</th><th>BLK</th><th>TO</th>
                    <th>FG</th><th>3P</th><th>FT</th>
                </tr>
            </thead>
            <tbody>
                {% for stat_entry in game_stats %}
                    {% set stat = stat_entry[0] %}
                    {% set g = stat_entry %} 
                    {% set is_home = (player.team_id == g[2]) %}
                    {% set opp_name = g[5] if is_home else g[4] %}
                    {% set opp_id = g[3] if is_home else g[2] %}
                    {% set prefix = "vs" if not is_home else "@" %} 
                    {% set my_score = g[6] if is_home else g[7] %}
                    {% set opp_score = g[7] if is_home else g[6] %}
                    {% set res_char = "W" if my_score > opp_score else "L" %}
                    {% set res_color = "#28a745" if res_char == "W" else "#dc3545" %}
                <tr>
                    <td>{{ g[1] }}</td>
                    <td class="text-left">
                        <span style="color:#999; margin-right:5px;">{{ prefix }}</span>
                        <a href="{{ url_for('team_detail', team_id=opp_id) }}" style="color:#333; text-decoration:none; font-weight:bold;">{{ opp_name }}</a>
                    </td>
                    <td>
                        <span style="color:{{ res_color }}; font-weight:bold;">{{ res_char }}</span>
                        <span style="font-size:0.85em; color:#666;"> {{ my_score }}-{{ opp_score }}</span>
                    </td>
                    <td><strong>{{ stat.pts }}</strong></td>
                    <td>{{ stat.reb }}</td><td>{{ stat.ast }}</td><td>{{ stat.stl }}</td><td>{{ stat.blk }}</td><td>{{ stat.turnover }}</td>
                    <td>{{ stat.fgm }}/{{ stat.fga }}</td><td>{{ stat.three_pm }}/{{ stat.three_pa }}</td><td>{{ stat.ftm }}/{{ stat.fta }}</td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>

    <div class="generator-wrapper">
        <div class="gen-title">PLAYER CARD GENERATOR</div>
        
        <div class="gen-container">
            <div class="gen-controls">
                <p style="color:#ccc; font-size:0.9rem; margin-bottom:15px;">Ë°®Á§∫„Åô„Çã„Çπ„Çø„ÉÉ„ÉÑ„ÇíÈÅ∏Êäû (ÊúÄÂ§ß6„Å§)</p>
                <div class="stat-selector">
                    {% set available_stats = [
                        ('PTS', avg_stats.avg_pts, 'ÂæóÁÇπ'), ('REB', avg_stats.avg_reb, '„É™„Éê„Ç¶„É≥„Éâ'),
                        ('AST', avg_stats.avg_ast, '„Ç¢„Ç∑„Çπ„Éà'), ('STL', avg_stats.avg_stl, '„Çπ„ÉÜ„Ç£„Éº„É´'),
                        ('BLK', avg_stats.avg_blk, '„Éñ„É≠„ÉÉ„ÇØ'), ('FG%', avg_stats.fg_pct, 'FG%'),
                        ('3P%', avg_stats.three_p_pct, '3P%'), ('FT%', avg_stats.ft_pct, 'FT%'),
                        ('TO', avg_stats.avg_turnover, 'TO')
                    ] %}
                    
                    {% for label, value, jp in available_stats %}
                    <label class="custom-check">
                        <input type="checkbox" name="card_stats" value="{{ label }}" data-val="{{ value|round(1) }}" {% if loop.index <= 6 %}checked{% endif %}>
                        <span>{{ label }}</span>
                    </label>
                    {% endfor %}
                </div>
                <div style="display:flex; gap:10px; width:100%;">
                    <button id="download-btn" class="dl-btn" style="flex:1;">DOWNLOAD ‚¨á</button>
                    <button id="share-btn" class="dl-btn" style="flex:1; background: #000; border-color: #333;">SHARE ùïè</button>
                </div>
            </div>

            <div class="gen-preview">
                <div id="player-card-canvas">
                    <div class="card-bg-pattern"></div>
                    <div class="card-frame-outer"></div>
                    <div class="card-frame-inner"></div>

                    {% if awards %}
                    <div class="card-awards-stack">
                        {% for award in awards %}
                        <div class="card-award-pill">
                            <span class="ca-icon">
                                {% if award.type == 'weekly' %}üî•
                                {% elif award.type == 'monthly' %}üåô
                                {% elif award.type == 'all_star' %}‚≠ê
                                {% elif award.type == 'stat_leader' %}üëë
                                {% else %}üèÜ{% endif %}
                            </span>
                            <span class="ca-text">{{ award.title }}</span>
                        </div>
                        {% endfor %}
                    </div>
                    {% endif %}

                    <div class="card-main-visual">
                        {% if player.team.logo_image %}
                        <img src="{{ player.team.logo_image }}" class="card-team-logo" crossorigin="anonymous">
                        {% endif %}
                    </div>
                    
                    <div class="card-player-info">
                        <div class="card-p-name">{{ player.name }}</div>
                        <div class="card-t-name">{{ player.team.name }} | {{ player.team.league }}</div>
                    </div>

                    <div class="card-stats-sidebar">
                        <div class="card-ovr-box">
                            <div class="card-ovr-label">SEASON</div>
                            <div class="card-ovr-val">2K26</div>
                        </div>

                        <div id="card-stats-container">
                            {% for i in range(1, 7) %}
                            <div class="card-stat-row" id="slot-{{ i }}">
                                <span class="cs-label">PTS</span>
                                <span class="cs-val">0.0</span>
                            </div>
                            {% endfor %}
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

</div>
{% endblock %}

{% block scripts %}
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="https://html2canvas.hertzen.com/dist/html2canvas.min.js"></script>
<script>
document.addEventListener('DOMContentLoaded', function() {
    // --- 1. „Ç∞„É©„ÉïÊèèÁîª ---
    {% if stats %}
    const logs = [
        {% for s in game_stats %}
        { 
            date: "{{ s[1] }}", 
            pts: {{ s[0].pts }}, reb: {{ s[0].reb }}, ast: {{ s[0].ast }},
            stl: {{ s[0].stl }}, blk: {{ s[0].blk }}
        },
        {% endfor %}
    ].reverse();

    new Chart(document.getElementById('playerLineChart'), {
        type: 'line',
        data: {
            labels: logs.map(d => d.date),
            datasets: [
                { label: 'PTS', data: logs.map(d => d.pts), borderColor: '#dc3545', tension: 0.3, fill: false },
                { label: 'REB', data: logs.map(d => d.reb), borderColor: '#007bff', tension: 0.3, hidden: true },
                { label: 'AST', data: logs.map(d => d.ast), borderColor: '#28a745', tension: 0.3, hidden: true },
                { label: 'STL', data: logs.map(d => d.stl), borderColor: '#6f42c1', tension: 0.3, hidden: true },
                { label: 'BLK', data: logs.map(d => d.blk), borderColor: '#fd7e14', tension: 0.3, hidden: true }
            ]
        },
        options: { responsive: true, interaction: { mode: 'index', intersect: false } }
    });
    {% endif %}

    // --- 2. „Ç´„Éº„ÉâÁîüÊàê„É≠„Ç∏„ÉÉ„ÇØ ---
    const checks = document.querySelectorAll('input[name="card_stats"]');
    const slots = [];
    for(let i=1; i<=6; i++) slots.push(document.getElementById(`slot-${i}`));

    function updateCard() {
        let active = [];
        checks.forEach(c => {
            if(c.checked) active.push({ label: c.value, val: c.dataset.val });
        });

        checks.forEach(c => {
            if(!c.checked) c.disabled = (active.length >= 6);
            else c.disabled = false;
        });

        slots.forEach((el, idx) => {
            if(active[idx]) {
                el.style.display = 'flex';
                el.querySelector('.cs-label').innerText = active[idx].label;
                let v = active[idx].val;
                if(active[idx].label.includes('%')) v += '%';
                el.querySelector('.cs-val').innerText = v;
            } else {
                el.style.display = 'none';
            }
        });
    }

    checks.forEach(c => c.addEventListener('change', updateCard));
    updateCard(); // init

    // „ÉÄ„Ç¶„É≥„É≠„Éº„Éâ
    document.getElementById('download-btn').addEventListener('click', function() {
        const btn = this;
        btn.innerText = 'GENERATING...';
        btn.disabled = true;
        
        const node = document.getElementById('player-card-canvas');
        
        html2canvas(node, {
            scale: 2, 
            useCORS: true,
            backgroundColor: null
        }).then(canvas => {
            const link = document.createElement('a');
            link.download = `{{ player.name }}_Card.png`;
            link.href = canvas.toDataURL('image/png');
            link.click();
            btn.innerText = 'DOWNLOAD ‚¨á';
            btn.disabled = false;
        }).catch(e => {
            alert('Error generating image');
            console.error(e);
            btn.innerText = 'DOWNLOAD ‚¨á';
            btn.disabled = false;
        });
    });

    // X„Ç∑„Çß„Ç¢
    document.getElementById('share-btn').addEventListener('click', function() {
        const btn = this;
        const originalText = btn.innerText;
        btn.innerText = 'UPLOADING...';
        btn.disabled = true;

        const node = document.getElementById('player-card-canvas');

        html2canvas(node, {
            scale: 2,
            useCORS: true,
            backgroundColor: null
        }).then(canvas => {
            const imageData = canvas.toDataURL("image/png");

            fetch('/api/upload_card', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ image: imageData })
            })
            .then(response => response.json())
            .then(data => {
                if (data.url) {
                    const text = `üèÄ {{ player.name }} - {{ player.team.name }}\n„Ç∑„Éº„Ç∫„É≥„Çπ„Çø„ÉÉ„ÉÑ„Ç´„Éº„Éâ„Çí‰ΩúÊàê„Åó„Åæ„Åó„ÅüÔºÅ\n#NBA2KJPL #NBA2K26`;
                    const shareUrl = `https://twitter.com/intent/tweet?text=${encodeURIComponent(text)}&url=${encodeURIComponent(data.url)}`;
                    window.open(shareUrl, '_blank');
                } else {
                    alert('„Ç¢„ÉÉ„Éó„É≠„Éº„Éâ„Å´Â§±Êïó„Åó„Åæ„Åó„Åü„ÄÇ');
                }
            })
            .catch(err => {
                console.error(err);
                alert('„Ç®„É©„Éº„ÅåÁô∫Áîü„Åó„Åæ„Åó„Åü„ÄÇ');
            })
            .finally(() => {
                btn.innerText = originalText;
                btn.disabled = false;
            });
        });
    });
});
</script>
{% endblock %}