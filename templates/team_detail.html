{% extends "layout.html" %}
{% block content %}
<style>
    /* ... (CSSは前回と同じ) ... */
    
    /* 赤色にするクラス (5位以内) */
    .stat-top .rank-badge { background-color: #dc3545; }
    .stat-top .stat-value { color: #dc3545; }
    
    /* 黄色にするクラス */
    .stat-good .rank-badge { background-color: #ffc107; color: #333; }
    .stat-good .stat-value { color: #e0a800; }
    
    /* グレーにするクラス */
    .stat-avg .rank-badge { background-color: #6c757d; }
    .stat-avg .stat-value { color: #6c757d; }

    /* グラフ幅 500px */
    .bar-chart-container {
        background-color: #f8f9fa; padding: 20px; border-radius: 8px;
        margin-bottom: 30px; 
        max-width: 500px;
        margin-left: auto; margin-right: auto;
    }
</style>

<div class="container mt-4">
    <div class="team-header-card" style="--bg-image: url('{{ team.logo_image if team.logo_image else '' }}');">
        {% if team.logo_image %}
            <img src="{{ team.logo_image }}" alt="{{ team.name }}" class="team-logo-large">
        {% endif %}
        <div class="team-title">
            <h1>{{ team.name }}</h1>
            <span class="team-league-badge">{{ team.league }}</span>
        </div>
    </div>

    {% if team_stats %}
    <div class="main-stats-row">
        <div class="main-stat-item">
            <div class="label">勝敗</div>
            <div class="value">{{ team_stats.wins }}<span style="font-size:0.6em">勝</span> - {{ team_stats.losses }}<span style="font-size:0.6em">敗</span></div>
        </div>
        <div class="main-stat-item">
            <div class="label">勝ち点</div>
            <div class="value">{{ team_stats.points }}</div>
        </div>
        
        {% if stats.get('avg_pf') %}
        {% set item = stats['avg_pf'] %}
        <div class="main-stat-item" style="border-top-color: {% if item.color_class == 'stat-top' %}#dc3545{% elif item.color_class == 'stat-good' %}#ffc107{% else %}#004a99{% endif %};">
            <div class="label">平均得点</div>
            <div class="value">{{ "%.1f"|format(item.value) }}</div>
            <div class="rank-badge {{ item.color_class }}">{{ item.rank }}位</div>
        </div>
        {% endif %}

        {% if stats.get('avg_pa') %}
        {% set item = stats['avg_pa'] %}
        <div class="main-stat-item" style="border-top-color: {% if item.color_class == 'stat-top' %}#dc3545{% elif item.color_class == 'stat-good' %}#ffc107{% else %}#004a99{% endif %};">
            <div class="label">平均失点</div>
            <div class="value">{{ "%.1f"|format(item.value) }}</div>
            <div class="rank-badge {{ item.color_class }}">{{ item.rank }}位</div>
        </div>
        {% endif %}

        {% if stats.get('diff') %}
        {% set item = stats['diff'] %}
        <div class="main-stat-item" style="border-top-color: {% if item.color_class == 'stat-top' %}#dc3545{% elif item.color_class == 'stat-good' %}#ffc107{% else %}#004a99{% endif %};">
            <div class="label">得失点差</div>
            <div class="value" style="color: {% if item.value > 0 %}#28a745{% else %}#dc3545{% endif %};">
                {{ item.value }}
            </div>
            <div class="rank-badge {{ item.color_class }}">{{ item.rank }}位</div>
        </div>
        {% endif %}
    </div>

    <div class="tab-nav-container">
        <div class="tab-btn active" data-tab="tab-stats">詳細スタッツ</div>
        <div class="tab-btn" data-tab="tab-roster">ロスター</div>
        <div class="tab-btn" data-tab="tab-schedule">試合日程</div>
    </div>

    <div id="tab-stats" class="tab-content active">
        <div class="detail-stats-grid">
            {% for key in ['fg_pct', 'three_p_pct', 'ft_pct', 'avg_reb', 'avg_ast', 'avg_stl', 'avg_blk', 'avg_turnover', 'avg_foul'] %}
                {% if stats.get(key) %}
                    {% set item = stats[key] %}
                    <div class="detail-stat-card {{ item.color_class }}">
                        <div class="label">{{ item.label }}</div>
                        <div class="value">{{ "%.1f"|format(item.value) }}<span style="font-size:0.6em">{% if 'pct' in key %}%{% endif %}</span></div>
                        <div class="rank-badge">{{ item.rank }}位</div>
                        <div style="font-size: 0.7em; color: #999; margin-top: 3px;">リーグ平均: {{ "%.1f"|format(item.avg) }}</div>
                    </div>
                {% endif %}
            {% endfor %}
        </div>
        
        <div class="bar-chart-container">
            <canvas id="teamBarChart"></canvas>
        </div>
    </div>

    <div id="tab-roster" class="tab-content">
        <div class="roster-container">
            <div class="roster-table-wrapper">
                <table class="roster-table">
                    <thead>
                        <tr>
                            <th class="player-name">選手名</th>
                            <th>G</th><th>PTS</th><th>REB</th><th>AST</th><th>STL</th><th>BLK</th><th>FG%</th><th>3P%</th><th>FT%</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for row in player_stats_list %}
                        <tr>
                            <td class="player-name">
                                <a href="{{ url_for('player_detail', player_id=row.Player.id) }}">{{ row.Player.name }}</a>
                            </td>
                            <td>{{ row.games_played }}</td>
                            <td>{{ "%.1f"|format(row.avg_pts or 0) }}</td>
                            <td>{{ "%.1f"|format(row.avg_reb or 0) }}</td>
                            <td>{{ "%.1f"|format(row.avg_ast or 0) }}</td>
                            <td>{{ "%.1f"|format(row.avg_stl or 0) }}</td>
                            <td>{{ "%.1f"|format(row.avg_blk or 0) }}</td>
                            <td>{{ "%.1f"|format(row.fg_pct or 0) }}%</td>
                            <td>{{ "%.1f"|format(row.three_p_pct or 0) }}%</td>
                            <td>{{ "%.1f"|format(row.ft_pct or 0) }}%</td>
                        </tr>
                        {% else %}
                        <tr><td colspan="10" style="padding:30px;">まだ選手が登録されていません。</td></tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <div id="tab-schedule" class="tab-content">
        {% for game in team_games %}
        <div class="game-card">
            <div class="game-date">{{ game.game_date }} {% if game.start_time %}{{ game.start_time }}{% endif %}</div>
            <div class="matchup">
                <div class="match-team home">
                    <span>{{ game.home_team.name }}</span>
                    {% if game.home_team.logo_image %}<img src="{{ game.home_team.logo_image }}">{% endif %}
                </div>
                <div class="match-score">
                    <a href="{{ url_for('game_result', game_id=game.id) }}">
                        {% if game.is_finished %}
                            {% if game.home_score > game.away_score %}
                                <span class="win">{{ game.home_score }}</span> - <span class="lose">{{ game.away_score }}</span>
                            {% elif game.away_score > game.home_score %}
                                <span class="lose">{{ game.home_score }}</span> - <span class="win">{{ game.away_score }}</span>
                            {% else %}
                                <span>{{ game.home_score }}</span> - <span>{{ game.away_score }}</span>
                            {% endif %}
                        {% else %}
                            <span class="vs">VS</span>
                        {% endif %}
                    </a>
                </div>
                <div class="match-team away">
                    {% if game.away_team.logo_image %}<img src="{{ game.away_team.logo_image }}">{% endif %}
                    <span>{{ game.away_team.name }}</span>
                </div>
            </div>
        </div>
        {% else %}
        <p style="text-align: center; color: #777;">まだ試合がありません。</p>
        {% endfor %}
    </div>
    {% endif %}
</div>
{% endblock %}

{% block scripts %}
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
document.addEventListener('DOMContentLoaded', function() {
    const tabButtons = document.querySelectorAll('.tab-btn');
    const tabContents = document.querySelectorAll('.tab-content');
    tabButtons.forEach(button => {
        button.addEventListener('click', function() {
            tabButtons.forEach(btn => btn.classList.remove('active'));
            tabContents.forEach(content => content.classList.remove('active'));
            this.classList.add('active');
            const tabId = this.getAttribute('data-tab');
            document.getElementById(tabId).classList.add('active');
        });
    });

    {% if stats and stats.get('avg_pf') %}
    const ctx = document.getElementById('teamBarChart');
    if (ctx) {
        new Chart(ctx.getContext('2d'), {
            type: 'bar',
            data: {
                labels: ['得点', '失点', 'AST', 'REB', 'STL', 'BLK'],
                datasets: [{
                    label: 'チーム平均',
                    data: [
                        {{ stats['avg_pf'].value|default(0) }}, {{ stats['avg_pa'].value|default(0) }}, 
                        {{ stats['avg_ast'].value|default(0) }}, {{ stats['avg_reb'].value|default(0) }}, 
                        {{ stats['avg_stl'].value|default(0) }}, {{ stats['avg_blk'].value|default(0) }}
                    ],
                    backgroundColor: ['rgba(75,192,192,0.7)', 'rgba(255,99,132,0.7)', 'rgba(54,162,235,0.7)', 'rgba(255,206,86,0.7)', 'rgba(153,102,255,0.7)', 'rgba(255,159,64,0.7)'],
                    borderWidth: 1
                }]
            },
            options: {
                indexAxis: 'y', responsive: true,
                scales: { x: { beginAtZero: true }, y: { display: true } },
                plugins: { legend: { display: false } }
            }
        });
    }
    {% endif %}
});
</script>
{% endblock %}