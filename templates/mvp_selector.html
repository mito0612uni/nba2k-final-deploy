{% extends "layout.html" %}
{% block content %}
<style>
    .mvp-container { max-width: 1000px; margin: 0 auto; }
    
    /* フォームコンテナ */
    .form-card {
        background-color: #fff; padding: 25px; border-radius: 10px;
        box-shadow: 0 2px 5px rgba(0,0,0,0.05); margin-bottom: 20px;
        border: 1px solid #eee;
    }
    .form-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; }
    .form-header h3 { margin: 0; color: #333; }
    
    .date-range-form {
        display: flex; flex-wrap: wrap; gap: 15px; align-items: end; justify-content: center;
    }
    .form-group { display: flex; flex-direction: column; }
    .form-group label { font-weight: bold; font-size: 0.9em; color: #555; margin-bottom: 5px; }
    .form-group input { padding: 10px; border: 1px solid #ddd; border-radius: 5px; }
    
    .btn {
        padding: 10px 20px; border-radius: 5px; cursor: pointer; font-weight: bold; border: none; color: white;
    }
    .btn-primary { background-color: #004a99; }
    .btn-success { background-color: #28a745; }
    .btn-danger { background-color: #dc3545; }
    .btn-secondary { background-color: #6c757d; }
    
    /* 結果表示エリア */
    .results-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(350px, 1fr));
        gap: 30px;
        margin-top: 30px;
    }
    .league-column h3 {
        text-align: center; color: #fff; padding: 10px; border-radius: 8px; margin-bottom: 20px;
    }
    .league-column.league-a h3 { background-color: #c62828; }
    .league-column.league-b h3 { background-color: #1565c0; }

    /* 選手カード */
    .ranking-card {
        background-color: #fff; border-radius: 12px; overflow: hidden;
        box-shadow: 0 4px 8px rgba(0,0,0,0.05); margin-bottom: 15px;
        display: flex; align-items: center; padding: 15px; border: 1px solid #eee;
    }
    .rank-number {
        font-size: 2em; font-weight: 900; margin-right: 15px; width: 40px; text-align: center; color: #ccc;
    }
    .rank-1 { color: #FFD700; } .rank-2 { color: #C0C0C0; } .rank-3 { color: #CD7F32; }
    
    .player-img { width: 60px; height: 60px; border-radius: 50%; object-fit: cover; margin-right: 15px; border: 2px solid #eee; }
    .player-info { flex-grow: 1; }
    .player-name { font-size: 1.2em; font-weight: bold; margin: 0; color: #333; }
    .team-name { font-size: 0.8em; color: #777; display: block; margin-bottom: 5px;}
    
    .stats-row { display: flex; gap: 10px; font-size: 0.85em; color: #555; flex-wrap: wrap; }
    .main-stat { font-size: 1.1em; font-weight: 800; color: #004a99; }
    .score-badge {
        background-color: #f0f0f0; padding: 2px 6px; border-radius: 4px;
        font-size: 0.8em; color: #333; font-weight: bold; margin-top: 5px; display: inline-block;
    }
</style>

<div class="mvp-container">
    <h2 style="text-align: center; margin-bottom: 30px;">週間MVP選出管理</h2>

    <div class="form-card">
        <div class="form-header">
            <h3>現在のステータス: 
                {% if is_mvp_visible %}
                    <span style="color: #28a745;">公開中 (ON)</span>
                {% else %}
                    <span style="color: #dc3545;">非公開 (OFF)</span>
                {% endif %}
            </h3>
            <form method="post" style="margin:0;">
                <input type="hidden" name="action" value="toggle_visibility">
                <input type="hidden" name="current_visibility" value="{{ 'true' if is_mvp_visible else 'false' }}">
                {% if is_mvp_visible %}
                    <button type="submit" class="btn btn-danger">トップページから非表示にする</button>
                {% else %}
                    <button type="submit" class="btn btn-success">トップページに表示する</button>
                {% endif %}
            </form>
        </div>
        <p style="color: #666; font-size: 0.9em;">※「公開中」にすると、前回保存されたMVP候補がトップページに表示されます。</p>
    </div>

    <div class="form-card">
        <h3>新規選出 (期間指定)</h3>
        <form method="post" class="date-range-form">
            <input type="hidden" name="action" value="calculate">
            <div class="form-group">
                <label>開始日</label>
                <input type="date" name="start_date" value="{{ start_date }}" required>
            </div>
            <div class="form-group">
                <label>終了日</label>
                <input type="date" name="end_date" value="{{ end_date }}" required>
            </div>
            <button type="submit" class="btn btn-primary">候補を計算する</button>
        </form>
    </div>

    {% if top_players_a or top_players_b %}
        <div style="text-align: center; margin-top: 40px; border-top: 2px dashed #ccc; padding-top: 20px;">
            <h2>選出プレビュー</h2>
            <p>以下の内容でよろしければ「この結果を公開する」ボタンを押してください。</p>
            
            <form method="post">
                <input type="hidden" name="action" value="publish">
                <input type="hidden" name="start_date" value="{{ start_date }}">
                <input type="hidden" name="end_date" value="{{ end_date }}">
                <button type="submit" class="btn btn-success" style="font-size: 1.2em; padding: 15px 40px;">この結果を公開・保存する</button>
            </form>
        </div>

        <div class="results-grid">
            <div class="league-column league-a">
                <h3>Aリーグ TOP 5</h3>
                {% for row in top_players_a %}
                    {{ render_player_card(row, loop.index) }}
                {% else %}
                    <p style="text-align:center; color:#777;">対象データなし</p>
                {% endfor %}
            </div>

            <div class="league-column league-b">
                <h3>Bリーグ TOP 5</h3>
                {% for row in top_players_b %}
                    {{ render_player_card(row, loop.index) }}
                {% else %}
                    <p style="text-align:center; color:#777;">対象データなし</p>
                {% endfor %}
            </div>
        </div>
    {% endif %}
</div>

{% macro render_player_card(row, rank) %}
<div class="ranking-card">
    <div class="rank-number rank-{{ rank }}">{{ rank }}</div>
    {% if row.Team.logo_image %}
        <img src="{{ row.Team.logo_image }}" class="player-img">
    {% else %}
        <div class="player-img" style="display:flex; align-items:center; justify-content:center; font-size:0.8em;">No img</div>
    {% endif %}
    <div class="player-info">
        <div class="player-name">{{ row.Player.name }}</div>
        <span class="team-name">{{ row.Team.name }}</span>
        <div class="stats-row">
            <span class="stat-item main-stat">{{ "%.1f"|format(row.avg_pts) }} <small>PTS</small></span>
            <span class="stat-item">{{ "%.1f"|format(row.avg_reb) }} REB</span>
            <span class="stat-item">{{ "%.1f"|format(row.avg_ast) }} AST</span>
            <span class="stat-item">{{ "%.1f"|format(row.avg_stl) }} STL</span>
            <span class="stat-item">{{ "%.1f"|format(row.avg_blk) }} BLK</span>
        </div>
        <div class="score-badge">Score: {{ "%.1f"|format(row.score) }}</div>
    </div>
</div>
{% endmacro %}
{% endblock %}