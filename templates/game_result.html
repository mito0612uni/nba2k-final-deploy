{% extends "layout.html" %}
{% block content %}
<style>
  /* --- タブ切り替え --- */
  .tab-navigation {
    display: flex;
    border-bottom: 1px solid #ddd;
    margin-bottom: 20px;
  }
  .tab-btn {
    padding: 10px 20px;
    cursor: pointer;
    background-color: #f1f1f1;
    border: 1px solid #ddd;
    border-bottom: none;
    margin-bottom: -1px;
    border-radius: 5px 5px 0 0;
  }
  .tab-btn.active {
    background-color: #fff;
    border-bottom: 1px solid #fff;
    font-weight: bold;
  }
  .tab-content {
    display: none;
  }
  .tab-content.active {
    display: block;
  }

  /* --- 最終スコア表示 --- */
  .final-score {
    text-align: center;
    margin: 20px 0;
    font-weight: bold;
  }
  .final-score .team-name {
    font-size: 1.5em;
    display: inline-block;
    padding: 0 15px;
    color: #555;
  }
  .final-score .team-name a { color: inherit; text-decoration: none; }
  .final-score .team-name a:hover { color: #007bff; }
  
  .final-score .score {
    font-size: 2.5em;
    display: inline-block;
  }
  .final-score .score.winner {
    color: #000;
  }
  .final-score .score.loser {
    color: #888;
  }

  /* --- チーム比較グラフ (game_edit.htmlからコピー) --- */
  .comparison-container { max-width: 600px; margin: 20px auto; font-family: Arial, sans-serif; }
  .comparison-row { margin-bottom: 15px; }
  .comparison-row .label { text-align: center; font-size: 14px; color: #555; margin-bottom: 5px; }
  .comparison-grid { display: grid; grid-template-columns: 50px 1fr 50px; align-items: center; gap: 10px; }
  .value-home { font-size: 1.1em; font-weight: bold; text-align: right; color: #888; }
  .value-away { font-size: 1.1em; font-weight: bold; text-align: left; color: #888; }
  .value-home.winner { color: #000; }
  .value-away.winner { color: #000; }
  .bar-track { height: 12px; background-color: #e0e0e0; border-radius: 6px; overflow: hidden; }
  .bar-fill { height: 100%; width: 50%; background-color: #007bff; border-radius: 6px 0 0 6px; transition: width 0.3s ease; }
  .bar-track.home-wins .bar-fill { background-color: #007bff; }
  .bar-track.away-wins .bar-fill { background-color: #a0cfff; }
  .bar-track.tie .bar-fill { background-color: #888; }

  /* --- ボックススコア用テーブル --- */
  .stats-table { width: 100%; border-collapse: collapse; margin-bottom: 20px; }
  .stats-table th, .stats-table td { border: 1px solid #ddd; padding: 8px; text-align: center; }
  .stats-table th { background-color: #f4f4f4; }
  .stats-table .player-name { text-align: left; }
  .stats-table .player-name a { color: inherit; font-weight: bold; text-decoration: none; }
  .stats-table .player-name a:hover { color: #007bff; }
  .stats-table tfoot { font-weight: bold; background-color: #f9f9f9; }

</style>

<h2>試合結果: {{ game.home_team.name }} vs {{ game.away_team.name }}</h2>
<p>{{ game.game_date }} {% if game.start_time %}{{ game.start_time }}{% endif %}</p>

<div class="final-score">
  <span class="team-name {% if game.home_score > game.away_score %}winner{% endif %}">
    <a href="{{ url_for('team_detail', team_id=game.home_team.id) }}">{{ game.home_team.name }}</a>
  </span>
  <span class="score {% if game.home_score > game.away_score %}winner{% else %}loser{% endif %}">{{ game.home_score }}</span>
  -
  <span class="score {% if game.away_score > game.home_score %}winner{% else %}loser{% endif %}">{{ game.away_score }}</span>
  <span class="team-name {% if game.away_score > game.home_score %}winner{% endif %}">
    <a href="{{ url_for('team_detail', team_id=game.away_team.id) }}">{{ game.away_team.name }}</a>
  </span>
</div>

{% if current_user.is_authenticated and current_user.is_admin %}
<div style="text-align: center; margin-bottom: 20px;">
  <a href="{{ url_for('edit_game', game_id=game.id) }}" style="padding: 10px 15px; background-color: #ffc107; color: black; text-decoration: none; border-radius: 5px; font-weight: bold;">
    この試合のスタッツを編集する
  </a>
</div>
{% endif %}


<div class="tab-navigation">
  <div class="tab-btn active" data-tab="tab-compare">チーム比較</div>
  <div class="tab-btn" data-tab="tab-box-score">ボックススコア</div>
</div>

<div id="tab-compare" class="tab-content active">
  <div class="comparison-container">
    <div class="comparison-row"><div class="label">得点</div><div class="comparison-grid"><div class="value-home" id="compare-pts-home">0</div><div class="bar-track" id="compare-pts-track"><div class="bar-fill" id="compare-pts-bar"></div></div><div class="value-away" id="compare-pts-away">0</div></div></div>
    <div class="comparison-row"><div class="label">フィールドゴール</div><div class="comparison-grid"><div class="value-home" id="compare-fgp-home">0.0%</div><div class="bar-track" id="compare-fgp-track"><div class="bar-fill" id="compare-fgp-bar"></div></div><div class="value-away" id="compare-fgp-away">0.0%</div></div></div>
    <div class="comparison-row"><div class="label">3ポイント</div><div class="comparison-grid"><div class="value-home" id="compare-3pp-home">0.0%</div><div class="bar-track" id="compare-3pp-track"><div class="bar-fill" id="compare-3pp-bar"></div></div><div class="value-away" id="compare-3pp-away">0.0%</div></div></div>
    <div class="comparison-row"><div class="label">フリースロー</div><div class="comparison-grid"><div class="value-home" id="compare-ftp-home">0.0%</div><div class="bar-track" id="compare-ftp-track"><div class="bar-fill" id="compare-ftp-bar"></div></div><div class="value-away" id="compare-ftp-away">0.0%</div></div></div>
    <div class="comparison-row"><div class="label">リバウンド</div><div class="comparison-grid"><div class="value-home" id="compare-reb-home">0</div><div class="bar-track" id="compare-reb-track"><div class="bar-fill" id="compare-reb-bar"></div></div><div class="value-away" id="compare-reb-away">0</div></div></div>
    <div class="comparison-row"><div class="label">アシスト</div><div class="comparison-grid"><div class="value-home" id="compare-ast-home">0</div><div class="bar-track" id="compare-ast-track"><div class="bar-fill" id="compare-ast-bar"></div></div><div class="value-away" id="compare-ast-away">0</div></div></div>
    <div class="comparison-row"><div class="label">スティール</div><div class="comparison-grid"><div class="value-home" id="compare-stl-home">0</div><div class="bar-track" id="compare-stl-track"><div class="bar-fill" id="compare-stl-bar"></div></div><div class="value-away" id="compare-stl-away">0</div></div></div>
    <div class="comparison-row"><div class="label">ブロック</div><div class="comparison-grid"><div class="value-home" id="compare-blk-home">0</div><div class="bar-track" id="compare-blk-track"><div class="bar-fill" id="compare-blk-bar"></div></div><div class="value-away" id="compare-blk-away">0</div></div></div>
    <div class="comparison-row"><div class="label">ターンオーバー</div><div class="comparison-grid"><div class="value-home" id="compare-to-home">0</div><div class="bar-track" id="compare-to-track"><div class="bar-fill" id="compare-to-bar"></div></div><div class="value-away" id="compare-to-away">0</div></div></div>
    <div class="comparison-row"><div class="label">ファウル</div><div class="comparison-grid"><div class="value-home" id="compare-foul-home">0</div><div class="bar-track" id="compare-foul-track"><div class="bar-fill" id="compare-foul-bar"></div></div><div class="value-away" id="compare-foul-away">0</div></div></div>
  </div>
</div>

<div id="tab-box-score" class="tab-content">
  <h3>
    <a href="{{ url_for('team_detail', team_id=game.home_team.id) }}" style="color: inherit; text-decoration: none;">
      {{ game.home_team.name }}
    </a>
  </h3>
  <table class="stats-table" id="box-score-home">
    <thead>
      <tr>
        <th>選手名</th><th>PTS</th><th>AST</th><th>REB</th><th>STL</th><th>BLK</th><th>FOUL</th><th>TO</th><th>FGM/A</th><th>3PM/A</th><th>FTM/A</th>
      </tr>
    </thead>
    <tbody>
      </tbody>
    <tfoot>
      <tr>
        <td>合計</td>
        <td id="box-total-pts-home">0</td><td id="box-total-ast-home">0</td><td id="box-total-reb-home">0</td>
        <td id="box-total-stl-home">0</td><td id="box-total-blk-home">0</td><td id="box-total-foul-home">0</td>
        <td id="box-total-to-home">0</td><td id="box-total-fg-home">0/0</td><td id="box-total-3p-home">0/0</td>
        <td id="box-total-ft-home">0/0</td>
      </tr>
    </tfoot>
  </table>

  <h3>
    <a href="{{ url_for('team_detail', team_id=game.away_team.id) }}" style="color: inherit; text-decoration: none;">
      {{ game.away_team.name }}
    </a>
  </h3>
  <table class="stats-table" id="box-score-away">
    <thead>
      <tr>
        <th>選手名</th><th>PTS</th><th>AST</th><th>REB</th><th>STL</th><th>BLK</th><th>FOUL</th><th>TO</th><th>FGM/A</th><th>3PM/A</th><th>FTM/A</th>
      </tr>
    </thead>
    <tbody>
      </tbody>
    <tfoot>
      <tr>
        <td>合計</td>
        <td id="box-total-pts-away">0</td><td id="box-total-ast-away">0</td><td id="box-total-reb-away">0</td>
        <td id="box-total-stl-away">0</td><td id="box-total-blk-away">0</td><td id="box-total-foul-away">0</td>
        <td id="box-total-to-away">0</td><td id="box-total-fg-away">0/0</td><td id="box-total-3p-away">0/0</td>
        <td id="box-total-ft-away">0/0</td>
      </tr>
    </tfoot>
  </table>

  <div style="margin-top: 20px;">
    <strong>DNP (Did Not Play):</strong>
    <p id="dnp-home" style="color: #555;"></p>
    <p id="dnp-away" style="color: #555;"></p>
  </div>

</div>
{% endblock %}


{% block scripts %}
<script>
// Flaskから渡された生データ
const existingStats = {{ stats | tojson }};
const allHomePlayers = [
  {% for player in game.home_team.players %}
    { id: {{ player.id }}, name: "{{ player.name }}" },
  {% endfor %}
];
const allAwayPlayers = [
  {% for player in game.away_team.players %}
    { id: {{ player.id }}, name: "{{ player.name }}" },
  {% endfor %}
];

document.addEventListener('DOMContentLoaded', function() {
  
  // --- 1. タブ切り替えロジック ---
  const tabButtons = document.querySelectorAll('.tab-btn');
  const tabContents = document.querySelectorAll('.tab-content');
  tabButtons.forEach(button => {
    button.addEventListener('click', function() {
      tabButtons.forEach(btn => btn.classList.remove('active'));
      tabContents.forEach(content => content.classList.remove('active'));
      this.classList.add('active');
      document.getElementById(this.dataset.tab).classList.add('active');
    });
  });

  // --- 2. チーム比較グラフのロジック (game_edit.htmlからコピー) ---
  
  // チーム全体の合計スタッツを計算
  const homeStats = { pts: 0, reb: 0, ast: 0, stl: 0, blk: 0, to: 0, foul: 0, fgm: 0, fga: 0, '3pm': 0, '3pa': 0, ftm: 0, fta: 0 };
  const awayStats = { pts: 0, reb: 0, ast: 0, stl: 0, blk: 0, to: 0, foul: 0, fgm: 0, fga: 0, '3pm': 0, '3pa': 0, ftm: 0, fta: 0 };
  
  // existingStats (DBからのデータ) から合計を計算
  allHomePlayers.forEach(p => {
      const s = existingStats[String(p.id)];
      if (s) {
          homeStats.pts += s.pts || 0; homeStats.reb += s.reb || 0; homeStats.ast += s.ast || 0;
          homeStats.stl += s.stl || 0; homeStats.blk += s.blk || 0; homeStats.to += s.turnover || 0;
          homeStats.foul += s.foul || 0; homeStats.fgm += s.fgm || 0; homeStats.fga += s.fga || 0;
          homeStats['3pm'] += s.three_pm || 0; homeStats['3pa'] += s.three_pa || 0;
          homeStats.ftm += s.ftm || 0; homeStats.fta += s.fta || 0;
      }
  });
  allAwayPlayers.forEach(p => {
      const s = existingStats[String(p.id)];
      if (s) {
          awayStats.pts += s.pts || 0; awayStats.reb += s.reb || 0; awayStats.ast += s.ast || 0;
          awayStats.stl += s.stl || 0; awayStats.blk += s.blk || 0; awayStats.to += s.turnover || 0;
          awayStats.foul += s.foul || 0; awayStats.fgm += s.fgm || 0; awayStats.fga += s.fga || 0;
          awayStats['3pm'] += s.three_pm || 0; awayStats['3pa'] += s.three_pa || 0;
          awayStats.ftm += s.ftm || 0; awayStats.fta += s.fta || 0;
      }
  });

  // パーセンテージを計算
  const homeFGP = homeStats.fga > 0 ? (homeStats.fgm / homeStats.fga * 100) : 0;
  const awayFGP = awayStats.fga > 0 ? (awayStats.fgm / awayStats.fga * 100) : 0;
  const home3PP = homeStats['3pa'] > 0 ? (homeStats['3pm'] / homeStats['3pa'] * 100) : 0;
  const away3PP = awayStats['3pa'] > 0 ? (awayStats['3pm'] / awayStats['3pa'] * 100) : 0;
  const homeFTP = homeStats.fta > 0 ? (homeStats.ftm / homeStats.fta * 100) : 0;
  const awayFTP = awayStats.fta > 0 ? (awayStats.ftm / awayStats.fta * 100) : 0;

  // 比較UIのDOMを更新
  updateStatRow('pts', homeStats.pts, awayStats.pts, 'integer');
  updateStatRow('reb', homeStats.reb, awayStats.reb, 'integer');
  updateStatRow('ast', homeStats.ast, awayStats.ast, 'integer');
  updateStatRow('stl', homeStats.stl, awayStats.stl, 'integer');
  updateStatRow('blk', homeStats.blk, awayStats.blk, 'integer');
  updateStatRow('to', homeStats.to, awayStats.to, 'integer', true);
  updateStatRow('foul', homeStats.foul, awayStats.foul, 'integer', true);
  updateStatRow('fgp', homeFGP, awayFGP, 'percent');
  updateStatRow('3pp', home3PP, away3PP, 'percent');
  updateStatRow('ftp', homeFTP, awayFTP, 'percent');
  
  // 比較グラフの1行を更新するヘルパー関数 (game_edit.htmlからコピー)
  function updateStatRow(id, homeVal, awayVal, format = 'integer', lessIsBetter = false) {
    const homeEl = document.getElementById(`compare-${id}-home`);
    const awayEl = document.getElementById(`compare-${id}-away`);
    const barEl = document.getElementById(`compare-${id}-bar`);
    const trackEl = document.getElementById(`compare-${id}-track`);
    if (!homeEl || !awayEl || !barEl || !trackEl) return;
    if (format === 'percent') {
      homeEl.textContent = homeVal.toFixed(1) + '%';
      awayEl.textContent = awayVal.toFixed(1) + '%';
    } else {
      homeEl.textContent = homeVal;
      awayEl.textContent = awayVal;
    }
    const total = homeVal + awayVal;
    let homeWidth = 50;
    if (total > 0) {
      homeWidth = (homeVal / total) * 100;
    }
    barEl.style.width = homeWidth + '%';
    homeEl.classList.remove('winner');
    awayEl.classList.remove('winner');
    trackEl.classList.remove('home-wins', 'away-wins', 'tie');
    if (homeVal === awayVal) {
      trackEl.classList.add('tie');
    } else if ((!lessIsBetter && homeVal > awayVal) || (lessIsBetter && homeVal < awayVal)) {
      homeEl.classList.add('winner');
      trackEl.classList.add('home-wins');
    } else {
      awayEl.classList.add('winner');
      trackEl.classList.add('away-wins');
    }
  }

  // --- 3. ボックススコアタブのロジック ---
  const homeTbody = document.getElementById('box-score-home').querySelector('tbody');
  const awayTbody = document.getElementById('box-score-away').querySelector('tbody');
  let dnpHome = [];
  let dnpAway = [];

  // ホーム選手のボックススコアを生成
  allHomePlayers.forEach(player => {
    const stat = existingStats[String(player.id)];
    if (stat) { // スタッツがある (試合に出た)
      const row = `
        <tr>
          <td class="player-name"><a href="/player/${player.id}">${player.name}</a></td>
          <td>${stat.pts}</td><td>${stat.ast}</td><td>${stat.reb}</td>
          <td>${stat.stl}</td><td>${stat.blk}</td><td>${stat.foul}</td>
          <td>${stat.turnover}</td><td>${stat.fgm}/${stat.fga}</td>
          <td>${stat.three_pm}/${stat.three_pa}</td><td>${stat.ftm}/${stat.fta}</td>
        </tr>`;
      homeTbody.insertAdjacentHTML('beforeend', row);
    } else { // スタッツがない (DNP)
      dnpHome.push(player.name);
    }
  });

  // アウェイ選手のボックススコアを生成
  allAwayPlayers.forEach(player => {
    const stat = existingStats[String(player.id)];
    if (stat) {
      const row = `
        <tr>
          <td class="player-name"><a href="/player/${player.id}">${player.name}</a></td>
          <td>${stat.pts}</td><td>${stat.ast}</td><td>${stat.reb}</td>
          <td>${stat.stl}</td><td>${stat.blk}</td><td>${stat.foul}</td>
          <td>${stat.turnover}</td><td>${stat.fgm}/${stat.fga}</td>
          <td>${stat.three_pm}/${stat.three_pa}</td><td>${stat.ftm}/${stat.fta}</td>
        </tr>`;
      awayTbody.insertAdjacentHTML('beforeend', row);
    } else {
      dnpAway.push(player.name);
    }
  });
  
  // DNP リストの表示
  if (dnpHome.length > 0) document.getElementById('dnp-home').textContent = `{{ game.home_team.name }}: ${dnpHome.join(', ')}`;
  if (dnpAway.length > 0) document.getElementById('dnp-away').textContent = `{{ game.away_team.name }}: ${dnpAway.join(', ')}`;

  // 合計スタッツの表示
  document.getElementById('box-total-pts-home').textContent = homeStats.pts;
  document.getElementById('box-total-ast-home').textContent = homeStats.ast;
  document.getElementById('box-total-reb-home').textContent = homeStats.reb;
  document.getElementById('box-total-stl-home').textContent = homeStats.stl;
  document.getElementById('box-total-blk-home').textContent = homeStats.blk;
  document.getElementById('box-total-foul-home').textContent = homeStats.foul;
  document.getElementById('box-total-to-home').textContent = homeStats.to;
  document.getElementById('box-total-fg-home').textContent = `${homeStats.fgm}/${homeStats.fga}`;
  document.getElementById('box-total-3p-home').textContent = `${homeStats['3pm']}/${homeStats['3pa']}`;
  document.getElementById('box-total-ft-home').textContent = `${homeStats.ftm}/${homeStats.fta}`;

  document.getElementById('box-total-pts-away').textContent = awayStats.pts;
  document.getElementById('box-total-ast-away').textContent = awayStats.ast;
  document.getElementById('box-total-reb-away').textContent = awayStats.reb;
  document.getElementById('box-total-stl-away').textContent = awayStats.stl;
  document.getElementById('box-total-blk-away').textContent = awayStats.blk;
  document.getElementById('box-total-foul-away').textContent = awayStats.foul;
  document.getElementById('box-total-to-away').textContent = awayStats.to;
  document.getElementById('box-total-fg-away').textContent = `${awayStats.fgm}/${awayStats.fga}`;
  document.getElementById('box-total-3p-away').textContent = `${awayStats['3pm']}/${awayStats['3pa']}`;
  document.getElementById('box-total-ft-away').textContent = `${awayStats.ftm}/${awayStats.fta}`;

});
</script>
{% endblock %}