{% extends "layout.html" %}

{% block content %}
<script type="text/javascript" src="https://cdn.jsdelivr.net/npm/browser-image-compression@2.0.2/dist/browser-image-compression.js"></script>
<style>
  /* æ—¢å­˜ã®ã‚¹ã‚¿ã‚¤ãƒ« */
  .bench { border: 1px solid #ddd; padding: 10px; margin-bottom: 15px; border-radius: 5px; }
  .bench-player { background-color: #f0f0f0; border: 1px solid #ccc; padding: 5px 10px; border-radius: 15px; cursor: pointer; display: inline-block; margin: 5px; }
  .bench-player:hover { background-color: #e0e0e0; }
  .bench-player.selected { background-color: #a0a0a0; color: white; cursor: not-allowed; }
  .stats-table input { width: 50px; text-align: right; }
  
  /* ãƒãƒ¼ãƒ ã‚»ã‚¯ã‚·ãƒ§ãƒ³ã®ãƒªãƒ³ã‚¯ */
  .team-section h3 a,
  .stats-table td a {
      color: inherit;
      text-decoration: none;
  }
  .team-section h3 a:hover,
  .stats-table td a:hover {
      color: #004a99;
      text-decoration: underline;
  }

  /* --- ã‚¿ãƒ–åˆ‡ã‚Šæ›¿ãˆ --- */
  .tab-navigation {
    display: flex;
    border-bottom: 1px solid #ddd;
    margin-bottom: 20px;
  }
  .tab-btn {
    padding: 10px 20px;
    cursor: pointer;
    background-color: #f1f1f1;
    border: 1px solid #ddd;
    border-bottom: none;
    margin-bottom: -1px;
    border-radius: 5px 5px 0 0;
    font-family: 'Montserrat', sans-serif;
    font-weight: 700;
  }
  .tab-btn.active {
    background-color: #fff;
    border-bottom: 1px solid #fff;
    color: #004a99;
  }
  .tab-content { display: none; }
  .tab-content.active { display: block; }

  /* --- â˜…â˜…â˜… ãƒãƒ¼ãƒ æ¯”è¼ƒã‚°ãƒ©ãƒ• (ã‚»ãƒ³ã‚¿ãƒ¼åˆ†å‰²å‹) â˜…â˜…â˜… --- */
  .comparison-container {
    max-width: 700px;
    margin: 20px auto;
    font-family: 'Roboto', sans-serif;
  }
  .comparison-row {
    margin-bottom: 12px;
  }
  .comparison-row .label {
    text-align: center;
    font-size: 13px;
    color: #666;
    margin-bottom: 4px;
    font-weight: bold;
  }
  .comparison-grid {
    display: grid;
    /* æ•°å€¤ | ãƒ›ãƒ¼ãƒ ãƒãƒ¼ | åŒºåˆ‡ã‚Šç·š | ã‚¢ã‚¦ã‚§ã‚¤ãƒãƒ¼ | æ•°å€¤ */
    grid-template-columns: 60px 1fr 1px 1fr 60px;
    align-items: center;
    gap: 5px;
    height: 24px;
  }
  
  .value-home { text-align: right; font-weight: bold; color: #999; }
  .value-away { text-align: left; font-weight: bold; color: #999; }
  .value-home.winner, .value-away.winner { color: #333; font-size: 1.1em; }

  .center-line {
    width: 100%;
    height: 100%;
    background-color: #ddd;
  }

  .bar-area {
    width: 100%;
    height: 100%;
    background-color: #f0f0f0;
    position: relative;
    border-radius: 4px;
  }
  
  .bar-fill {
    height: 100%;
    width: 0%;
    transition: width 0.4s ease;
    position: absolute;
    top: 0;
  }

  .bar-area-home .bar-fill {
    right: 0;
    background-color: #ccc;
    border-radius: 4px 0 0 4px;
  }
  .bar-area-home .bar-fill.winner {
    background-color: #004a99;
  }

  .bar-area-away .bar-fill {
    left: 0;
    background-color: #ccc;
    border-radius: 0 4px 4px 0;
  }
  .bar-area-away .bar-fill.winner {
    background-color: #004a99;
  }

  /* --- â˜…è¿½åŠ : AIè§£æã‚¨ãƒªã‚¢ã®ã‚¹ã‚¿ã‚¤ãƒ« --- */
  .ai-scan-area {
      background: #e8f4ff;
      border: 2px dashed #004a99;
      padding: 20px;
      border-radius: 10px;
      margin-bottom: 30px;
      text-align: center;
  }
  .ai-scan-title {
      font-weight: bold;
      color: #004a99;
      margin-bottom: 10px;
      display: block;
      font-size: 1.1em;
  }
  .ai-btn {
      background: #004a99;
      color: white;
      border: none;
      padding: 10px 20px;
      border-radius: 5px;
      font-weight: bold;
      cursor: pointer;
      margin-top: 10px;
  }
  .ai-btn:disabled {
      background: #ccc;
      cursor: not-allowed;
  }
  .loading-msg {
      color: #004a99;
      font-weight: bold;
      margin-top: 10px;
      display: none;
  }
  #image-preview {
      max-width: 100%;
      max-height: 250px;
      margin-top: 10px;
      border-radius: 5px;
      border: 1px solid #ccc;
      display: none;
  }
</style>

<h2>
  çµæœå…¥åŠ›: {{ game.home_team.name }} vs {{ game.away_team.name }}
</h2>

<p style="margin-bottom: 15px;">
  ãƒãƒ¼ãƒ å¾—ç‚¹ã¯è‡ªå‹•è¨ˆç®—ã•ã‚Œã¾ã™ã€‚
  ãƒ™ãƒ³ãƒã‹ã‚‰5åé¸ã‚“ã§ã‚¹ã‚¿ãƒƒãƒ„ã‚’æ‰‹å‹•å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚
</p>

<div class="ai-scan-area">
    <span class="ai-scan-title">ğŸ¤– AIè‡ªå‹•å…¥åŠ› (Beta)</span>
    <p style="font-size:0.9em; margin-bottom:10px;">ãƒªã‚¶ãƒ«ãƒˆç”»é¢ã®ã‚¹ã‚¯ã‚·ãƒ§ã‚’ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã™ã‚‹ã¨ã€AIãŒæ•°å€¤ã‚’èª­ã¿å–ã£ã¦è‡ªå‹•å…¥åŠ›ã—ã¾ã™ã€‚</p>
    
    <input type="file" id="score-image-input" accept="image/*" style="display:none;" onchange="previewImage(this)">
    <button type="button" onclick="document.getElementById('score-image-input').click()" style="padding:5px 10px; cursor:pointer;">ğŸ“· ç”»åƒã‚’é¸æŠ / è²¼ã‚Šä»˜ã‘</button>
    
    <div style="margin-top:10px;">
        <img id="image-preview">
    </div>
    
    <button id="analyze-btn" class="ai-btn" onclick="analyzeImage()" style="display:none;">âœ¨ ã“ã®ç”»åƒã‚’AIã§èª­ã¿å–ã‚‹</button>
    <div id="loading-msg" class="loading-msg">AIãŒè§£æä¸­... (10ç§’ã»ã©ã‹ã‹ã‚Šã¾ã™)</div>
</div>

{% if current_user.is_admin %}
<div style="background-color: #f8d3da; border: 1px solid #f5c6cb; padding: 15px; border-radius: 5px; margin-bottom: 20px;">
    <h4>ç®¡ç†è€…ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ï¼šä¸æˆ¦å‹å‡¦ç†</h4>
    <div style="display: flex; gap: 20px;">
      <form action="{{ url_for('forfeit_game', game_id=game.id) }}" method="post" onsubmit="return confirm('{{ game.home_team.name }} ã®ä¸æˆ¦å‹ã¨ã—ã¦è¨˜éŒ²ã—ã¾ã™ã‹ï¼Ÿ');">
          <input type="hidden" name="winning_team_id" value="{{ game.home_team_id }}">
          <button type="submit" style="background-color: #28a745; color: white;">{{ game.home_team.name }} ã®ä¸æˆ¦å‹</button>
      </form>
      <form action="{{ url_for('forfeit_game', game_id=game.id) }}" method="post" onsubmit="return confirm('{{ game.away_team.name }} ã®ä¸æˆ¦å‹ã¨ã—ã¦è¨˜éŒ²ã—ã¾ã™ã‹ï¼Ÿ');">
          <input type="hidden" name="winning_team_id" value="{{ game.away_team_id }}">
          <button type="submit" style="background-color: #28a745; color: white;">{{ game.away_team.name }} ã®ä¸æˆ¦å‹</button>
      </form>
    </div>
</div>
{% endif %}

<div class="tab-navigation">
  <div class="tab-btn active" data-tab="tab-input">ã‚¹ã‚¿ãƒƒãƒ„å…¥åŠ›</div>
  <div class="tab-btn" data-tab="tab-compare">ãƒãƒ¼ãƒ æ¯”è¼ƒ</div>
</div>

<div id="tab-input" class="tab-content active">
  <form method="post">

    {# --- ã‚¢ã‚¦ã‚§ã‚¤ãƒãƒ¼ãƒ  (ä¸Šéƒ¨) --- #}
    <div class="team-section">
      <h3>
        <a href="{{ url_for('team_detail', team_id=game.away_team.id) }}" target="_blank">
          {{ game.away_team.name }} (ã‚¢ã‚¦ã‚§ã‚¤)
        </a>
      </h3>
      
      <div class="bench" id="bench-away">
          <strong>ãƒ™ãƒ³ãƒ:</strong>
        {% for player in game.away_team.players %}
          <span class="bench-player" data-team-id="away" data-player-id="{{ player.id }}" data-player-name="{{ player.name }}">
            {{ player.name }}
          </span>
        {% endfor %}
      </div>

      <table class="stats-table">
        <thead id="stats-header-away"></thead>
        <tbody id="stats-body-away"></tbody>
      </table>
      <button type="button" class="reset-btn" data-team-id="away">é¸æŠã‚’ãƒªã‚»ãƒƒãƒˆ</button>
    </div>

    <hr style="margin: 30px 0;">

    {# --- ãƒ›ãƒ¼ãƒ ãƒãƒ¼ãƒ  (ä¸‹éƒ¨) --- #}
    <div class="team-section">
      <h3>
        <a href="{{ url_for('team_detail', team_id=game.home_team.id) }}" target="_blank">
          {{ game.home_team.name }} (ãƒ›ãƒ¼ãƒ )
        </a>
      </h3>
      
      <div class="bench" id="bench-home">
          <strong>ãƒ™ãƒ³ãƒ:</strong>
        {% for player in game.home_team.players %}
          <span class="bench-player" data-team-id="home" data-player-id="{{ player.id }}" data-player-name="{{ player.name }}">
            {{ player.name }}
          </span>
        {% endfor %}
      </div>

      <table class="stats-table">
        <thead id="stats-header-home"></thead>
        <tbody id="stats-body-home"></tbody>
      </table>
      <button type="button" class="reset-btn" data-team-id="home">é¸æŠã‚’ãƒªã‚»ãƒƒãƒˆ</button>
    </div>

    <hr style="margin: 30px 0;">

    <div>
      <h3>è©¦åˆã®å‹•ç”»ãƒªãƒ³ã‚¯</h3>
      <div style="margin-bottom: 10px;">
        <label for="youtube_url_away">{{ game.away_team.name }}å´ URL:</label>
        <input type="url" id="youtube_url_away" name="youtube_url_away" value="{{ game.youtube_url_away or '' }}" placeholder="https://..." style="width: 100%; max-width: 500px; padding: 5px;">
      </div>
      <div>
        <label for="youtube_url_home">{{ game.home_team.name }}å´ URL:</label>
        <input type="url" id="youtube_url_home" name="youtube_url_home" value="{{ game.youtube_url_home or '' }}" placeholder="https://..." style="width: 100%; max-width: 500px; padding: 5px;">
      </div>
    </div>
    
    <button type="submit" style="margin-top: 20px; padding: 10px 20px; font-size: 16px;">çµæœã‚’ä¿å­˜</button>
  </form>
</div>

<div id="tab-compare" class="tab-content">
  <div class="comparison-container">
    {% for item in [
        ('pts', 'å¾—ç‚¹'),
        ('fgp', 'ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã‚´ãƒ¼ãƒ«'),
        ('3pp', '3ãƒã‚¤ãƒ³ãƒˆ'),
        ('ftp', 'ãƒ•ãƒªãƒ¼ã‚¹ãƒ­ãƒ¼'),
        ('reb', 'ãƒªãƒã‚¦ãƒ³ãƒ‰'),
        ('ast', 'ã‚¢ã‚·ã‚¹ãƒˆ'),
        ('stl', 'ã‚¹ãƒ†ã‚£ãƒ¼ãƒ«'),
        ('blk', 'ãƒ–ãƒ­ãƒƒã‚¯'),
        ('to', 'ã‚¿ãƒ¼ãƒ³ã‚ªãƒ¼ãƒãƒ¼'),
        ('foul', 'ãƒ•ã‚¡ã‚¦ãƒ«')
    ] %}
    <div class="comparison-row">
      <div class="label">{{ item[1] }}</div>
      <div class="comparison-grid">
        <div class="value-home" id="compare-{{ item[0] }}-home">0</div>
        <div class="bar-area bar-area-home">
            <div class="bar-fill" id="compare-{{ item[0] }}-bar-home"></div>
        </div>
        
        <div class="center-line"></div>
        
        <div class="bar-area bar-area-away">
            <div class="bar-fill" id="compare-{{ item[0] }}-bar-away"></div>
        </div>
        <div class="value-away" id="compare-{{ item[0] }}-away">0</div>
      </div>
    </div>
    {% endfor %}
  </div>
</div>

{% endblock %}


{% block scripts %}
<script>
const existingStats = {{ stats | tojson }};
const statHeaders = ['é¸æ‰‹å', 'å¾—ç‚¹', 'ï¾˜ï¾Šï¾ï½³ï¾ï¾„ï¾', 'ï½±ï½¼ï½½ï¾„', 'ï½½ï¾ƒï½¨ï½°ï¾™', 'ï¾Œï¾ï¾›ï½¯ï½¸', 'ï¾Œï½§ï½³ï¾™', 'TO', 'FGM', 'FGA', '3PM', '3PA', 'FTM', 'FTA'];
const statFields = ['player_name', 'pts', 'reb', 'ast', 'stl', 'blk', 'foul', 'turnover', 'fgm', 'fga', 'three_pm', 'three_pa', 'ftm', 'fta'];

// --- â˜…è¿½åŠ : AIç”»åƒè§£æå‡¦ç† ---
function previewImage(input) {
    const file = input.files[0];
    if (file) {
        const reader = new FileReader();
        reader.onload = function(e) {
            const img = document.getElementById('image-preview');
            img.src = e.target.result;
            img.style.display = 'inline-block';
            document.getElementById('analyze-btn').style.display = 'inline-block';
        }
        reader.readAsDataURL(file);
    }
}

// ã‚¯ãƒªãƒƒãƒ—ãƒœãƒ¼ãƒ‰ã‹ã‚‰ã®è²¼ã‚Šä»˜ã‘å¯¾å¿œ
document.addEventListener('paste', function(e) {
    const items = e.clipboardData.items;
    for (let i = 0; i < items.length; i++) {
        if (items[i].type.indexOf('image') !== -1) {
            const blob = items[i].getAsFile();
            const input = document.getElementById('score-image-input');
            
            const reader = new FileReader();
            reader.onload = function(event) {
                const img = document.getElementById('image-preview');
                img.src = event.target.result;
                img.style.display = 'inline-block';
                document.getElementById('analyze-btn').style.display = 'inline-block';
                window.pastedImageBlob = blob;
            };
            reader.readAsDataURL(blob);
        }
    }
});

// â˜…ä¿®æ­£ç‰ˆ: è‡ªå‹•åœ§ç¸®æ©Ÿèƒ½ä»˜ãã®è§£æé–¢æ•°
async function analyzeImage() {
    const input = document.getElementById('score-image-input');
    let file = input.files[0];
    
    // ã‚¯ãƒªãƒƒãƒ—ãƒœãƒ¼ãƒ‰è²¼ã‚Šä»˜ã‘ã®ç”»åƒãŒã‚ã‚Œã°ãã‚Œã‚’ä½¿ã†
    if (!file && window.pastedImageBlob) {
        file = window.pastedImageBlob;
    }

    if (!file) {
        alert('ç”»åƒã‚’é¸æŠã—ã¦ãã ã•ã„');
        return;
    }

    const btn = document.getElementById('analyze-btn');
    const msg = document.getElementById('loading-msg');
    
    // ãƒœã‚¿ãƒ³ã‚’ç„¡åŠ¹åŒ–ã—ã¦ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’è¡¨ç¤º
    btn.disabled = true;
    msg.style.display = 'block';
    msg.innerText = 'ç”»åƒã‚’æœ€é©åŒ–ä¸­...'; // ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸å¤‰æ›´

    try {
        // --- â˜…è‡ªå‹•åœ§ç¸®è¨­å®š ---
        const options = {
            maxSizeMB: 4.0,          // 4.0MBä»¥ä¸‹ã‚’ç›®æŒ‡ã™ (Vercelåˆ¶é™å¯¾ç­–)
            maxWidthOrHeight: 2500,  // é•·è¾ºã‚’2500pxã«åˆ¶é™ (AIã«ã¯ã“ã‚Œã§ååˆ†ã‹ã¤è»½é‡åŒ–ã§ãã‚‹)
            useWebWorker: true       // å‡¦ç†ã‚’è»½ãã™ã‚‹
        };

        // åœ§ç¸®å®Ÿè¡Œ (ãƒ•ã‚¡ã‚¤ãƒ«ãŒå°ã•ã‘ã‚Œã°ãã®ã¾ã¾ã€å¤§ãã‘ã‚Œã°åœ§ç¸®ã•ã‚Œã‚‹)
        console.log(`å…ƒã®ã‚µã‚¤ã‚º: ${(file.size / 1024 / 1024).toFixed(2)} MB`);
        const compressedFile = await imageCompression(file, options);
        console.log(`åœ§ç¸®å¾Œã®ã‚µã‚¤ã‚º: ${(compressedFile.size / 1024 / 1024).toFixed(2)} MB`);
        
        // åœ§ç¸®å¾Œã®ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ä½¿ã£ã¦é€ä¿¡æº–å‚™
        const formData = new FormData();
        formData.append('image', compressedFile);

        // è§£æä¸­ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã«æˆ»ã™
        msg.innerText = 'AIãŒè§£æä¸­... (10ã€œ20ç§’ã‹ã‹ã‚Šã¾ã™)';

        // é€ä¿¡
        const response = await fetch('/api/analyze_stats', {
            method: 'POST',
            body: formData
        });

        const data = await response.json();

        if (data.error) {
            alert('ã‚¨ãƒ©ãƒ¼: ' + data.error);
        } else {
            autoFillStats(data.players);
            alert('è‡ªå‹•å…¥åŠ›ãŒå®Œäº†ã—ã¾ã—ãŸï¼\nå…¥åŠ›å†…å®¹ã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚');
        }

    } catch (error) {
        console.error(error);
        alert('ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ: ' + error.message);
    } finally {
        // ãƒœã‚¿ãƒ³ç­‰ã‚’å…ƒã«æˆ»ã™
        btn.disabled = false;
        msg.style.display = 'none';
    }
}

function autoFillStats(aiPlayers) {
    if (!aiPlayers || aiPlayers.length === 0) return;

    // ç”»é¢ä¸Šã®å…¨ãƒ™ãƒ³ãƒãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ã‚’å–å¾—
    const allBenchPlayers = document.querySelectorAll('.bench-player');
    
    aiPlayers.forEach(aiP => {
        // åå‰ã§ãƒãƒƒãƒãƒ³ã‚° (éƒ¨åˆ†ä¸€è‡´)
        let matchedElement = null;

        allBenchPlayers.forEach(el => {
            const dbName = el.dataset.playerName.toLowerCase();
            const aiName = aiP.name.toLowerCase();
            
            // ã©ã¡ã‚‰ã‹ã®åå‰ãŒå«ã¾ã‚Œã¦ã„ã‚Œã°ä¸€è‡´ã¨ã¿ãªã™
            if (dbName.includes(aiName) || aiName.includes(dbName)) {
                matchedElement = el;
            }
        });

        if (matchedElement) {
            // æ—¢ã«é¸æŠã•ã‚Œã¦ã„ãªã‘ã‚Œã°ã‚¯ãƒªãƒƒã‚¯ã—ã¦ãƒ†ãƒ¼ãƒ–ãƒ«ã«è¿½åŠ 
            if (!matchedElement.classList.contains('selected')) {
                matchedElement.click();
            }
            
            // è¿½åŠ ã•ã‚ŒãŸè¡Œã‚’æ¢ã—ã¦å€¤ã‚’åŸ‹ã‚ã‚‹
            const playerId = matchedElement.dataset.playerId;
            
            // DOMæ›´æ–°ã‚’å°‘ã—å¾…ã£ã¦ã‹ã‚‰å…¥åŠ› (clickã‚¤ãƒ™ãƒ³ãƒˆãŒåŒæœŸçš„ã§ãªã„å ´åˆã®ãŸã‚å¿µã®ç‚ºsetTimeout)
            setTimeout(() => {
                const row = document.querySelector(`tr[data-player-id="${playerId}"]`);
                if (row) {
                    const map = {
                        'pts': 'pts', 'reb': 'reb', 'ast': 'ast', 'stl': 'stl', 'blk': 'blk',
                        'foul': 'foul', 'to': 'turnover', 
                        'fgm': 'fgm', 'fga': 'fga', 
                        '3pm': 'three_pm', '3pa': 'three_pa', 
                        'ftm': 'ftm', 'fta': 'fta'
                    };
                    
                    for (const [aiKey, formKey] of Object.entries(map)) {
                        const input = row.querySelector(`input[name="player_${playerId}_${formKey}"]`);
                        if (input && aiP[aiKey] !== undefined) {
                            input.value = aiP[aiKey];
                        }
                    }
                }
                // ã‚°ãƒ©ãƒ•æ›´æ–°
                updateComparisonView();
            }, 50);
        }
    });
}

// --- æ—¢å­˜ã®JSãƒ­ã‚¸ãƒƒã‚¯ ---
document.addEventListener('DOMContentLoaded', function() {
  const tabButtons = document.querySelectorAll('.tab-btn');
  const tabContents = document.querySelectorAll('.tab-content');
  tabButtons.forEach(button => {
    button.addEventListener('click', function() {
      tabButtons.forEach(btn => btn.classList.remove('active'));
      tabContents.forEach(content => content.classList.remove('active'));
      this.classList.add('active');
      document.getElementById(this.dataset.tab).classList.add('active');
      
      if (this.dataset.tab === 'tab-compare') {
          updateComparisonView();
      }
    });
  });

  function createHeaderRow() {
    return '<tr>' + statHeaders.map(h => `<th>${h}</th>`).join('') + '</tr>';
  }

  function createPlayerRow(playerId, playerName, teamId) {
    const playerStats = existingStats[String(playerId)] || {};
    let rowHTML = `<td><a href="/player/${playerId}" target="_blank">${playerName}</a></td>`;
    
    statFields.slice(1).forEach(field => {
      // ä¿®æ­£: å€¤ãŒ0ãªã‚‰ç©ºæ–‡å­—ã€placeholderã«0
      const rawValue = playerStats[field];
      const displayValue = (rawValue !== undefined && rawValue !== 0 && rawValue !== '0') ? rawValue : '';
      
      rowHTML += `<td><input type="number" name="player_${playerId}_${field}" value="${displayValue}" placeholder="0" min="0" oninput="updateComparisonView()"></td>`;
    });
    return `<tr data-player-id="${playerId}" data-player-name="${playerName}" data-team-id="${teamId}">${rowHTML}</tr>`;
  }
  
  function populateInitialStats() {
    const statsHeaderHome = document.getElementById('stats-header-home');
    const statsBodyHome = document.getElementById('stats-body-home');
    const statsHeaderAway = document.getElementById('stats-header-away');
    const statsBodyAway = document.getElementById('stats-body-away');
    let homeHasStats = false;
    let awayHasStats = false;

    for (const playerId in existingStats) {
      const player = document.querySelector(`.bench-player[data-player-id='${playerId}']`);
      if (player) {
        const teamId = player.dataset.teamId;
        const playerName = player.dataset.playerName;
        if (teamId === 'home') {
          statsBodyHome.insertAdjacentHTML('beforeend', createPlayerRow(playerId, playerName, teamId));
          player.classList.add('selected'); 
          homeHasStats = true;
        } else if (teamId === 'away') {
          statsBodyAway.insertAdjacentHTML('beforeend', createPlayerRow(playerId, playerName, teamId));
          player.classList.add('selected');
          awayHasStats = true;
        }
      }
    }
    
    if (homeHasStats) statsHeaderHome.innerHTML = createHeaderRow();
    if (awayHasStats) statsHeaderAway.innerHTML = createHeaderRow();
    
    updateComparisonView();
  }

  populateInitialStats();

  // --- æ‰‹å‹•å…¥åŠ›ã®å‡¦ç† ---
  document.querySelectorAll('.bench-player').forEach(playerSpan => {
    playerSpan.addEventListener('click', function() {
      if (this.classList.contains('selected')) return;
      const teamId = this.dataset.teamId;
      
      const statsBody = document.getElementById(`stats-body-${teamId}`); 
      if (statsBody.children.length >= 5) {
        alert('é¸æŠã§ãã‚‹é¸æ‰‹ã¯5äººã¾ã§ã§ã™ã€‚');
        return;
      }
      const statsHeader = document.getElementById(`stats-header-${teamId}`);
      if (statsHeader.children.length === 0) statsHeader.innerHTML = createHeaderRow();
      const playerId = this.dataset.playerId;
      const playerName = this.dataset.playerName;
      statsBody.insertAdjacentHTML('beforeend', createPlayerRow(playerId, playerName, teamId));
      this.classList.add('selected');
      
      updateComparisonView();
    });
  });

  document.querySelectorAll('.reset-btn').forEach(button => {
    button.addEventListener('click', function() {
      const teamId = this.dataset.teamId;
      document.getElementById(`stats-header-${teamId}`).innerHTML = '';
      document.getElementById(`stats-body-${teamId}`).innerHTML = '';
      document.querySelectorAll(`#bench-${teamId} .bench-player`).forEach(span => {
        span.classList.remove('selected');
      });
      updateComparisonView();
    });
  });
});

// --- ãƒãƒ¼ãƒ æ¯”è¼ƒã‚°ãƒ©ãƒ•ã®ãƒ­ã‚¸ãƒƒã‚¯ (ã‚»ãƒ³ã‚¿ãƒ¼åˆ†å‰²ç‰ˆ) ---
function updateComparisonView() {
    const homeStats = { pts: 0, reb: 0, ast: 0, stl: 0, blk: 0, to: 0, foul: 0, fgm: 0, fga: 0, '3pm': 0, '3pa': 0, ftm: 0, fta: 0 };
    const awayStats = { pts: 0, reb: 0, ast: 0, stl: 0, blk: 0, to: 0, foul: 0, fgm: 0, fga: 0, '3pm': 0, '3pa': 0, ftm: 0, fta: 0 };

    document.querySelectorAll('#stats-body-home tr').forEach(row => {
      homeStats.pts += parseFloat(row.querySelector('input[name$="_pts"]').value) || 0;
      homeStats.reb += parseFloat(row.querySelector('input[name$="_reb"]').value) || 0;
      homeStats.ast += parseFloat(row.querySelector('input[name$="_ast"]').value) || 0;
      homeStats.stl += parseFloat(row.querySelector('input[name$="_stl"]').value) || 0;
      homeStats.blk += parseFloat(row.querySelector('input[name$="_blk"]').value) || 0;
      homeStats.to += parseFloat(row.querySelector('input[name$="_turnover"]').value) || 0;
      homeStats.foul += parseFloat(row.querySelector('input[name$="_foul"]').value) || 0;
      homeStats.fgm += parseFloat(row.querySelector('input[name$="_fgm"]').value) || 0;
      homeStats.fga += parseFloat(row.querySelector('input[name$="_fga"]').value) || 0;
      homeStats['3pm'] += parseFloat(row.querySelector('input[name$="_three_pm"]').value) || 0;
      homeStats['3pa'] += parseFloat(row.querySelector('input[name$="_three_pa"]').value) || 0;
      homeStats.ftm += parseFloat(row.querySelector('input[name$="_ftm"]').value) || 0;
      homeStats.fta += parseFloat(row.querySelector('input[name$="_fta"]').value) || 0;
    });

    document.querySelectorAll('#stats-body-away tr').forEach(row => {
      awayStats.pts += parseFloat(row.querySelector('input[name$="_pts"]').value) || 0;
      awayStats.reb += parseFloat(row.querySelector('input[name$="_reb"]').value) || 0;
      awayStats.ast += parseFloat(row.querySelector('input[name$="_ast"]').value) || 0;
      awayStats.stl += parseFloat(row.querySelector('input[name$="_stl"]').value) || 0;
      awayStats.blk += parseFloat(row.querySelector('input[name$="_blk"]').value) || 0;
      awayStats.to += parseFloat(row.querySelector('input[name$="_turnover"]').value) || 0;
      awayStats.foul += parseFloat(row.querySelector('input[name$="_foul"]').value) || 0;
      awayStats.fgm += parseFloat(row.querySelector('input[name$="_fgm"]').value) || 0;
      awayStats.fga += parseFloat(row.querySelector('input[name$="_fga"]').value) || 0;
      awayStats['3pm'] += parseFloat(row.querySelector('input[name$="_three_pm"]').value) || 0;
      awayStats['3pa'] += parseFloat(row.querySelector('input[name$="_three_pa"]').value) || 0;
      awayStats.ftm += parseFloat(row.querySelector('input[name$="_ftm"]').value) || 0;
      awayStats.fta += parseFloat(row.querySelector('input[name$="_fta"]').value) || 0;
    });

    const homeFGP = homeStats.fga > 0 ? (homeStats.fgm / homeStats.fga * 100) : 0;
    const awayFGP = awayStats.fga > 0 ? (awayStats.fgm / awayStats.fga * 100) : 0;
    const home3PP = homeStats['3pa'] > 0 ? (homeStats['3pm'] / homeStats['3pa'] * 100) : 0;
    const away3PP = awayStats['3pa'] > 0 ? (awayStats['3pm'] / awayStats['3pa'] * 100) : 0;
    const homeFTP = homeStats.fta > 0 ? (homeStats.ftm / homeStats.fta * 100) : 0;
    const awayFTP = awayStats.fta > 0 ? (awayStats.ftm / awayStats.fta * 100) : 0;

    updateSplitBar('pts', homeStats.pts, awayStats.pts, 'integer');
    updateSplitBar('reb', homeStats.reb, awayStats.reb, 'integer');
    updateSplitBar('ast', homeStats.ast, awayStats.ast, 'integer');
    updateSplitBar('stl', homeStats.stl, awayStats.stl, 'integer');
    updateSplitBar('blk', homeStats.blk, awayStats.blk, 'integer');
    updateSplitBar('to', homeStats.to, awayStats.to, 'integer', true);
    updateSplitBar('foul', homeStats.foul, awayStats.foul, 'integer', true);
    
    updateSplitBar('fgp', homeFGP, awayFGP, 'percent');
    updateSplitBar('3pp', home3PP, away3PP, 'percent');
    updateSplitBar('ftp', homeFTP, awayFTP, 'percent');
}

function updateSplitBar(id, homeVal, awayVal, format = 'integer', lessIsBetter = false) {
    const homeValEl = document.getElementById(`compare-${id}-home`);
    const awayValEl = document.getElementById(`compare-${id}-away`);
    const homeBarEl = document.getElementById(`compare-${id}-bar-home`);
    const awayBarEl = document.getElementById(`compare-${id}-bar-away`);

    if (format === 'percent') {
      homeValEl.textContent = homeVal.toFixed(1) + '%';
      awayValEl.textContent = awayVal.toFixed(1) + '%';
    } else {
      homeValEl.textContent = homeVal;
      awayValEl.textContent = awayVal;
    }

    const total = homeVal + awayVal;
    let homeWidth = 0;
    let awayWidth = 0;
    
    if (total > 0) {
        homeWidth = (homeVal / total) * 100;
        awayWidth = (awayVal / total) * 100;
    }

    homeBarEl.style.width = homeWidth + '%';
    awayBarEl.style.width = awayWidth + '%';

    homeValEl.classList.remove('winner');
    awayValEl.classList.remove('winner');
    homeBarEl.classList.remove('winner');
    awayBarEl.classList.remove('winner');

    if (homeVal === awayVal) {
    } else if ((!lessIsBetter && homeVal > awayVal) || (lessIsBetter && homeVal < awayVal)) {
        homeValEl.classList.add('winner');
        homeBarEl.classList.add('winner');
    } else {
        awayValEl.classList.add('winner');
        awayBarEl.classList.add('winner');
    }
}
</script>
{% endblock %}