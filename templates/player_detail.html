{% extends "layout.html" %}
{% block content %}
<style>
    .player-header {
        display: flex;
        align-items: center;
        gap: 25px;
        margin-bottom: 20px;
        background-color: #f8f9fa;
        padding: 20px;
        border-radius: 8px;
    }
    .player-header h1 { margin: 0; }
    .player-header .team-link {
        font-size: 1.2em;
        font-weight: 500;
    }
    .player-header .team-logo {
        height: 40px;
        width: 40px;
        object-fit: contain;
        margin-right: 10px;
    }

    .avg-stats-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(100px, 1fr));
        gap: 15px;
        margin-bottom: 30px;
    }
    .stat-card {
        background-color: #f8f9fa;
        padding: 15px;
        border-radius: 8px;
        text-align: center;
    }
    .stat-card .value {
        font-size: 1.8em;
        font-weight: bold;
    }
    .stat-card .label {
        font-size: 0.9em;
        color: #555;
    }
    .stat-card .details {
        font-size: 0.8em;
        color: #777;
    }
    
    /* ★★★ レーダーチャートのスタイル (.radar-chart-container) を削除 ★★★ */
    
    /* グラフ用の共通スタイル */
    .chart-container {
        background-color: #f8f9fa;
        padding: 20px;
        border-radius: 8px;
        margin-bottom: 30px;
        margin-left: auto;
        margin-right: auto;
    }
    /* 折れ線グラフ用のサイズ */
    .line-chart-container {
        max-width: 800px;
        margin-top: 30px;
    }

    .game-log-table th, .game-log-table td {
        vertical-align: middle;
        text-align: center;
        font-size: 0.9em;
    }
    .game-log-table th { font-size: 0.8em; }
    .game-log-table .opponent { text-align: left; }
    .game-log-table .opponent a,
    .game-log-table .result a {
        color: #007bff;
        text-decoration: none;
        font-weight: bold;
    }
    .game-log-table .opponent a:hover,
    .game-log-table .result a:hover {
        text-decoration: underline;
    }
</style>

<div class="container mt-4">
    <div class="player-header">
        <div>
            <h1>{{ player.name }}</h1>
            <a href="{{ url_for('team_detail', team_id=player.team.id) }}" class="team-link">
                {% if player.team.logo_image %}
                <img src="{{ player.team.logo_image }}" alt="{{ player.team.name }}" class="team-logo">
                {% endif %}
                {{ player.team.name }}
            </a>
        </div>
    </div>

    <h3>シーズンアベレージ ({{ avg_stats.games_played or 0 }} 試合)</h3>
    {% if avg_stats and avg_stats.games_played > 0 %}
    
        <div class="avg-stats-grid">
            <div class="stat-card">
                <div class="value">{{ "%.1f"|format(avg_stats.avg_pts) }}</div>
                <div class="label">PTS</div>
            </div>
            <div class="stat-card">
                <div class="value">{{ "%.1f"|format(avg_stats.avg_reb) }}</div>
                <div class="label">REB</div>
            </div>
            <div class="stat-card">
                <div class="value">{{ "%.1f"|format(avg_stats.avg_ast) }}</div>
                <div class="label">AST</div>
            </div>
            <div class="stat-card">
                <div class="value">{{ "%.1f"|format(avg_stats.avg_stl) }}</div>
                <div class="label">STL</div>
            </div>
            <div class="stat-card">
                <div class="value">{{ "%.1f"|format(avg_stats.avg_blk) }}</div>
                <div class="label">BLK</div>
            </div>
        </div>
        <div class="avg-stats-grid">
            <div class="stat-card">
                <div class="value">{{ "%.1f"|format(avg_stats.fg_pct) }}<span style="font-size: 0.6em;">%</span></div>
                <div class="label">FG%</div>
                <div class="details">{{ avg_stats.total_fgm }}/{{ avg_stats.total_fga }}</div>
            </div>
            <div class="stat-card">
                <div class="value">{{ "%.1f"|format(avg_stats.three_p_pct) }}<span style="font-size: 0.6em;">%</span></div>
                <div class="label">3P%</div>
                <div class="details">{{ avg_stats.total_3pm }}/{{ avg_stats.total_3pa }}</div>
            </div>
            <div class="stat-card">
                <div class="value">{{ "%.1f"|format(avg_stats.ft_pct) }}<span style="font-size: 0.6em;">%</span></div>
                <div class="label">FT%</div>
                <div class="details">{{ avg_stats.total_ftm }}/{{ avg_stats.total_fta }}</div>
            </div>
            <div class="stat-card">
                <div class="value">{{ "%.1f"|format(avg_stats.avg_turnover) }}</div>
                <div class="label">TO</div>
            </div>
            <div class="stat-card">
                <div class="value">{{ "%.1f"|format(avg_stats.avg_foul) }}</div>
                <div class="label">FOUL</div>
            </div>
        </div>
    {% else %}
        <p>スタッツが記録された試合はまだありません。</p>
    {% endif %}

    {% if avg_stats and avg_stats.games_played > 0 %}
    <div class="chart-container line-chart-container">
        <canvas id="playerLineChart"></canvas>
    </div>
    {% endif %}

    <h3 class="mt-5">ゲームログ</h3>
    <div class="table-responsive">
        <table class="table table-striped table-hover game-log-table">
            <thead class="thead-dark">
                <tr>
                    <th>日付</th>
                    <th>対戦相手</th>
                    <th>結果</th>
                    <th>PTS</th>
                    <th>REB</th>
                    <th>AST</th>
                    <th>STL</th>
                    <th>BLK</th>
                    <th>TO</th>
                    <th>FGM/A</th>
                    <th>3PM/A</th>
                    <th>FTM/A</th>
                </tr>
            </thead>
            <tbody>
                {% for stat_entry in game_stats %}
                    {% set stat = stat_entry[0] %} {# PlayerStat オブジェクト #}
                    {% set game_date = stat_entry[1] %}
                    {% set home_team_id = stat_entry[2] %}
                    {% set away_team_id = stat_entry[3] %}
                    {% set home_team_name = stat_entry[4] %}
                    {% set away_team_name = stat_entry[5] %}
                    {% set home_score = stat_entry[6] %}
                    {% set away_score = stat_entry[7] %}

                    {# 自分のチームがホームかアウェイか判定 #}
                    {% if player.team_id == home_team_id %}
                        {% set opponent_name = away_team_name %}
                        {% set opponent_id = away_team_id %}
                        {% set prefix = "@ " %}
                        {% set result = "W" if home_score > away_score else "L" %}
                        {% set score_str = home_score ~ "-" ~ away_score %}
                    {% else %}
                        {% set opponent_name = home_team_name %}
                        {% set opponent_id = home_team_id %}
                        {% set prefix = "vs " %}
                        {% set result = "W" if away_score > home_score else "L" %}
                        {% set score_str = away_score ~ "-" ~ home_score %}
                    {% endif %}

                <tr>
                    <td>{{ game_date }}</td>
                    <td class="opponent">
                        {{ prefix }}
                        <a href="{{ url_for('team_detail', team_id=opponent_id) }}">
                            {{ opponent_name }}
                        </a>
                    </td>
<td class="result">
  <a href="{{ url_for('game_result', game_id=stat.game_id) }}">
    {{ result }} <small>({{ score_str }})</small>
  </a>
</td>
                    <td>{{ stat.pts }}</td>
                    <td>{{ stat.reb }}</td>
                    <td>{{ stat.ast }}</td>
                    <td>{{ stat.stl }}</td>
                    <td>{{ stat.blk }}</td>
                    <td>{{ stat.turnover }}</td>
                    <td>{{ stat.fgm }}/{{ stat.fga }}</td>
                    <td>{{ stat.three_pm }}/{{ stat.three_pa }}</td>
                    <td>{{ stat.ftm }}/{{ stat.fta }}</td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
</div>
{% endblock %}


{% block scripts %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    // avg_stats が存在する場合のみグラフを描画
    {% if avg_stats and avg_stats.games_played > 0 %}
    
    // ★★★ 修正箇所2: レーダーチャートの描画ロジックをすべて削除 ★★★
    // ( new Chart(ctxRadar, config); を含むセクションを削除しました )


    // --- 2. 折れ線グラフ (これだけ残します) ---
    
    // 2a. Flaskから渡されたゲームログのデータを取得
    const gameStatsRaw = [
        {% for stat_entry in game_stats %}
        {
            date: "{{ stat_entry[1] }}", // game_date
            pts: {{ stat_entry[0].pts or 0 }}, // PlayerStat.pts
            reb: {{ stat_entry[0].reb or 0 }},
            ast: {{ stat_entry[0].ast or 0 }},
            stl: {{ stat_entry[0].stl or 0 }},
            blk: {{ stat_entry[0].blk or 0 }}
        },
        {% endfor %}
    ];

    // 2b. 昇順 (asc) に反転
    const gameStats = gameStatsRaw.reverse();

    // 2c. グラフ用のデータ配列を作成
    const lineLabels = gameStats.map(stat => stat.date); // X軸 (日付)
    const lineDataPts = gameStats.map(stat => stat.pts); // Y軸 (得点)
    const lineDataReb = gameStats.map(stat => stat.reb); // Y軸 (リバウンド)
    const lineDataAst = gameStats.map(stat => stat.ast); // Y軸 (アシスト)
    const lineDataStl = gameStats.map(stat => stat.stl);
    const lineDataBlk = gameStats.map(stat => stat.blk);

    // 2d. 折れ線グラフのデータ
    const lineData = {
        labels: lineLabels,
        datasets: [
            {
                label: '得点 (PTS)',
                data: lineDataPts,
                borderColor: 'rgb(255, 99, 132)', // 赤
                backgroundColor: 'rgba(255, 99, 132, 0.5)',
                yAxisID: 'y', // 主軸 (左)
            },
            {
                label: 'リバウンド (REB)',
                data: lineDataReb,
                borderColor: 'rgb(54, 162, 235)', // 青
                backgroundColor: 'rgba(54, 162, 235, 0.5)',
                yAxisID: 'y1', // 副軸 (右)
                hidden: true, // デフォルトで非表示
            },
            {
                label: 'アシスト (AST)',
                data: lineDataAst,
                borderColor: 'rgb(75, 192, 192)', // 緑
                backgroundColor: 'rgba(75, 192, 192, 0.5)',
                yAxisID: 'y1', // 副軸 (右)
                hidden: true, // デフォルトで非表示
            },
            {
                label: 'スティール (STL)',
                data: lineDataStl,
                borderColor: 'rgb(153, 102, 255)', // 紫
                backgroundColor: 'rgba(153, 102, 255, 0.5)',
                yAxisID: 'y1', // 副軸 (右)
                hidden: true,
            },
            {
                label: 'ブロック (BLK)',
                data: lineDataBlk,
                borderColor: 'rgb(255, 159, 64)', // オレンジ
                backgroundColor: 'rgba(255, 159, 64, 0.5)',
                yAxisID: 'y1', // 副軸 (右)
                hidden: true,
            }
        ]
    };

    // 2e. 折れ線グラフの設定
    const lineConfig = {
        type: 'line', 
        data: lineData,
        options: {
            responsive: true,
            interaction: {
                mode: 'index',
                intersect: false,
            },
            stacked: false,
            plugins: {
                title: {
                    display: true,
                    text: '試合ごとのスタッツ推移'
                },
                legend: {
                    display: true, 
                    position: 'bottom',
                }
            },
            scales: {
                x: {
                    display: true,
                    title: {
                        display: true,
                        text: '試合日'
                    }
                },
                y: {
                    type: 'linear',
                    display: true,
                    position: 'left',
                    title: {
                        display: true,
                        text: '得点'
                    },
                    beginAtZero: true
                },
                y1: {
                    type: 'linear',
                    display: true,
                    position: 'right',
                    title: {
                        display: true,
                        text: 'AST / REB / STL / BLK'
                    },
                    beginAtZero: true,
                    grid: {
                        drawOnChartArea: false,
                    },
                },
            }
        },
    };

    // 2f. グラフの描画
    const ctxLine = document.getElementById('playerLineChart').getContext('2d');
    new Chart(ctxLine, lineConfig);

    {% endif %} // if avg_stats... の閉じタグ
});
</script>
{% endblock %}