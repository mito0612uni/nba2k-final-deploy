{% extends "layout.html" %}

{% block content %}

{# ★★★ 修正: マクロ定義を一番上に移動しました ★★★ #}
{% macro render_player_card(row, rank) %}
<div class="ranking-card">
    <div class="rank-number rank-{{ rank }}">{{ rank }}</div>
    
    {% if row.Team.logo_image %}
        <img src="{{ row.Team.logo_image }}" class="player-img">
    {% else %}
        <div class="player-img" style="display:flex; align-items:center; justify-content:center; font-size:0.8em;">No img</div>
    {% endif %}

    <div class="player-info">
        <div class="player-name">
            <a href="{{ url_for('player_detail', player_id=row.Player.id) }}" target="_blank">{{ row.Player.name }}</a>
        </div>
        <span class="team-name">{{ row.Team.name }}</span>
        
        <div class="stats-row">
            <span class="stat-item main-stat">{{ "%.1f"|format(row.avg_pts) }} <small>PTS</small></span>
            <span class="stat-item">{{ "%.1f"|format(row.avg_reb) }} REB</span>
            <span class="stat-item">{{ "%.1f"|format(row.avg_ast) }} AST</span>
            <span class="stat-item">{{ "%.1f"|format(row.avg_stl) }} STL</span>
            <span class="stat-item">{{ "%.1f"|format(row.avg_blk) }} BLK</span>
        </div>
        <div class="score-badge">
            Eff Score: {{ "%.1f"|format(row.score) }} ({{ row.games_played }}試合)
        </div>
    </div>
</div>
{% endmacro %}
{# ★★★ マクロ定義ここまで ★★★ #}

<style>
    .mvp-container { max-width: 1000px; margin: 0 auto; }
    
    /* 期間指定フォーム */
    .date-range-form {
        background-color: #fff; padding: 25px; border-radius: 10px;
        box-shadow: 0 2px 5px rgba(0,0,0,0.05); margin-bottom: 40px;
        display: flex; flex-wrap: wrap; gap: 15px; align-items: end; justify-content: center;
    }
    .form-group { display: flex; flex-direction: column; }
    .form-group label { font-weight: bold; font-size: 0.9em; color: #555; margin-bottom: 5px; }
    .form-group input { padding: 10px; border: 1px solid #ddd; border-radius: 5px; }
    .search-btn { background-color: #004a99; color: white; border: none; padding: 10px 25px; border-radius: 5px; cursor: pointer; font-weight: bold; margin-bottom: 2px;}
    .search-btn:hover { background-color: #003377; }

    /* 結果表示エリア */
    .results-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(350px, 1fr));
        gap: 30px;
    }
    .league-column h3 {
        text-align: center;
        background-color: #333;
        color: #fff;
        padding: 10px;
        border-radius: 8px;
        margin-bottom: 20px;
    }
    .league-column.league-a h3 { background-color: #c62828; } /* Aリーグ色 */
    .league-column.league-b h3 { background-color: #1565c0; } /* Bリーグ色 */

    /* 選手カード */
    .ranking-card {
        background-color: #fff; border-radius: 12px; overflow: hidden;
        box-shadow: 0 4px 8px rgba(0,0,0,0.05); margin-bottom: 15px;
        display: flex; align-items: center; padding: 15px;
        position: relative;
        transition: transform 0.2s;
        border: 1px solid #eee;
    }
    .ranking-card:hover { transform: translateY(-3px); box-shadow: 0 8px 16px rgba(0,0,0,0.1); }
    
    /* 順位バッジ */
    .rank-number {
        font-size: 2em; font-weight: 900; margin-right: 15px; width: 40px; text-align: center;
        color: #ccc;
    }
    .rank-1 { color: #FFD700; text-shadow: 1px 1px 0 #c5a000; } /* 金 */
    .rank-2 { color: #C0C0C0; text-shadow: 1px 1px 0 #a0a0a0; } /* 銀 */
    .rank-3 { color: #CD7F32; text-shadow: 1px 1px 0 #a05a20; } /* 銅 */

    .player-img { width: 60px; height: 60px; border-radius: 50%; object-fit: cover; background-color: #f0f0f0; margin-right: 15px; border: 2px solid #eee; }
    
    .player-info { flex-grow: 1; }
    .player-name { font-size: 1.2em; font-weight: bold; margin: 0; color: #333; }
    .player-name a { text-decoration: none; color: inherit; }
    .team-name { font-size: 0.8em; color: #777; display: block; margin-bottom: 5px;}
    
    /* スタッツ表示 */
    .stats-row {
        display: flex;
        gap: 10px;
        font-size: 0.85em;
        color: #555;
        flex-wrap: wrap;
    }
    .main-stat {
        font-size: 1.1em; font-weight: 800; color: #004a99;
    }
    .stat-item { white-space: nowrap; }
    .score-badge {
        background-color: #f0f0f0; padding: 2px 6px; border-radius: 4px;
        font-size: 0.8em; color: #333; font-weight: bold;
        margin-top: 5px; display: inline-block;
    }
</style>

<div class="mvp-container">
    <h2 style="text-align: center; margin-bottom: 30px;">週間MVP選出 (管理者用)</h2>

    <form method="post" class="date-range-form">
        <div class="form-group">
            <label>開始日</label>
            <input type="date" name="start_date" value="{{ start_date }}" required>
        </div>
        <div class="form-group">
            <label>終了日</label>
            <input type="date" name="end_date" value="{{ end_date }}" required>
        </div>
        <button type="submit" class="search-btn">選手を選出</button>
    </form>

    {% if top_players_a or top_players_b %}
        <div class="results-grid">
            <div class="league-column league-a">
                <h3>Aリーグ TOP 5</h3>
                {% for row in top_players_a %}
                    {{ render_player_card(row, loop.index) }}
                {% else %}
                    <p style="text-align:center; color:#777;">対象データなし</p>
                {% endfor %}
            </div>

            <div class="league-column league-b">
                <h3>Bリーグ TOP 5</h3>
                {% for row in top_players_b %}
                    {{ render_player_card(row, loop.index) }}
                {% else %}
                    <p style="text-align:center; color:#777;">対象データなし</p>
                {% endfor %}
            </div>
        </div>
    {% endif %}
</div>

{% endblock %}