{% extends "layout.html" %}
{% block content %}
<style>
    /* --- ã‚¹ã‚¿ãƒƒãƒ„ãƒšãƒ¼ã‚¸å…±é€šã‚¹ã‚¿ã‚¤ãƒ« --- */
    .stats-container {
        max-width: 1400px;
        margin: 30px auto;
        padding: 0 20px;
    }
    
    .stats-section {
        background: #fff;
        border-radius: 8px;
        box-shadow: 0 4px 10px rgba(0,0,0,0.05);
        padding: 20px;
        margin-bottom: 40px;
        border: 1px solid #eee;
    }

    h2 {
        color: #004a99;
        font-weight: 800;
        border-left: 5px solid #ffd700;
        padding-left: 15px;
        margin-bottom: 20px;
        font-size: 1.5rem;
    }

    /* --- æ¤œç´¢ãƒœãƒƒã‚¯ã‚¹ --- */
    .search-wrapper {
        margin-bottom: 20px;
        position: relative;
        max-width: 400px;
    }
    .search-input {
        width: 100%;
        padding: 12px 15px 12px 45px; /* ã‚¢ã‚¤ã‚³ãƒ³åˆ†ã®ä½™ç™½ */
        border: 1px solid #ddd;
        border-radius: 30px;
        font-size: 1rem;
        box-sizing: border-box;
        transition: all 0.3s;
        background-color: #fff;
        -webkit-appearance: none; /* ã‚¹ãƒãƒ›ã§ã®ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã‚¹ã‚¿ã‚¤ãƒ«è§£é™¤ */
    }
    .search-input:focus {
        border-color: #004a99;
        box-shadow: 0 0 0 3px rgba(0, 74, 153, 0.1);
        outline: none;
    }
    .search-icon {
        position: absolute;
        left: 15px;
        top: 50%;
        transform: translateY(-50%);
        color: #aaa;
        font-size: 1.1rem;
    }

    /* --- ãƒ†ãƒ¼ãƒ–ãƒ«è¨­å®š --- */
    .table-responsive {
        overflow-x: auto;
        -webkit-overflow-scrolling: touch; /* iOSã§ã®æ…£æ€§ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ« */
        margin-bottom: 10px;
        border: 1px solid #ddd;
        border-radius: 4px;
        max-height: 800px;
        overflow-y: auto;
        background-color: #fff;
    }

    .stats-table {
        width: 100%;
        border-collapse: separate;
        border-spacing: 0;
        font-size: 0.9rem;
        white-space: nowrap;
    }

    .stats-table th, .stats-table td {
        padding: 12px 15px;
        border-bottom: 1px solid #eee;
        border-right: 1px solid #f0f0f0;
        text-align: center;
        vertical-align: middle;
    }

    /* ãƒ˜ãƒƒãƒ€ãƒ¼ */
    .stats-table th {
        background: #343a40;
        color: #fff;
        font-weight: bold;
        position: sticky;
        top: 0;
        z-index: 10;
        border-right-color: #555;
        cursor: pointer;
        user-select: none;
        transition: background-color 0.2s;
    }
    .stats-table th:hover { background-color: #495057; }

    /* ã‚½ãƒ¼ãƒˆã‚¢ã‚¤ã‚³ãƒ³ */
    .stats-table th::after {
        content: 'â‡…'; opacity: 0.3; margin-left: 4px; font-size: 0.8em; font-weight: normal;
    }
    .stats-table th.asc::after { content: 'â–²'; opacity: 1; color: #ffd700; }
    .stats-table th.desc::after { content: 'â–¼'; opacity: 1; color: #ffd700; }

    /* å·¦ç«¯ã‚«ãƒ©ãƒ å›ºå®š (PCåˆæœŸå€¤) */
    .stats-table th:first-child,
    .stats-table td:first-child {
        position: sticky; left: 0; z-index: 11;
        border-right: 2px solid #ddd; text-align: left;
        min-width: 160px; /* åå‰ãŒè¦‹ãˆã‚‹å¹… */
        background-color: #fff; /* èƒŒæ™¯è‰²å¿…é ˆ */
    }
    .stats-table th:first-child { background: #343a40; z-index: 20; }
    .stats-table td:first-child { font-weight: bold; color: #004a99; }

    /* ç¸æ¨¡æ§˜ */
    .stats-table tbody tr:nth-child(even) td { background-color: #f8f9fa; }
    .stats-table tbody tr:nth-child(even) td:first-child { background-color: #f8f9fa; }
    
    /* ãƒªãƒ³ã‚¯ */
    .stats-table a { text-decoration: none; color: inherit; display: block; }
    
    /* å€¤ã®å¼·èª¿ */
    .val-main { font-weight: bold; color: #222; font-size: 1rem; }
    .val-sub { color: #666; font-size: 0.85rem; }
    .val-pct { color: #007bff; font-weight: bold; }
    
    .mini-logo {
        height: 24px; width: 24px; object-fit: contain;
        vertical-align: middle; margin-right: 8px;
        background: #fff; border-radius: 50%; border: 1px solid #eee;
    }

    /* ========================================= */
    /* ğŸ“± ã‚¹ãƒãƒ›å‘ã‘ãƒ¬ã‚¹ãƒãƒ³ã‚·ãƒ–èª¿æ•´ (ã“ã“ãŒé‡è¦) */
    /* ========================================= */
    @media (max-width: 768px) {
        .stats-container {
            padding: 0 10px; /* ç”»é¢ç«¯ã®ä½™ç™½ã‚’æ¸›ã‚‰ã™ */
            margin-top: 20px;
        }
        
        .stats-section {
            padding: 15px 10px; /* ã‚«ãƒ¼ãƒ‰å†…ã®ä½™ç™½ã‚’æ¸›ã‚‰ã™ */
            border-radius: 6px;
        }

        h2 {
            font-size: 1.2rem; /* è¦‹å‡ºã—ã‚’å°ã•ã */
            margin-bottom: 15px;
            padding-left: 10px;
            border-left-width: 4px;
        }

        /* æ¤œç´¢ãƒœãƒƒã‚¯ã‚¹ã‚’ç”»é¢å¹…ã„ã£ã±ã„ã« */
        .search-wrapper {
            max-width: 100%;
        }
        
        /* ãƒ†ãƒ¼ãƒ–ãƒ«ã®æ–‡å­—ã‚µã‚¤ã‚ºã¨ä½™ç™½ã‚’å‡ç¸® */
        .stats-table {
            font-size: 0.8rem; /* æ–‡å­—ã‚µã‚¤ã‚ºãƒ€ã‚¦ãƒ³ */
        }
        
        .stats-table th, .stats-table td {
            padding: 10px 6px; /* ã‚»ãƒ«ã®å·¦å³ä½™ç™½ã‚’è©°ã‚ã‚‹ */
        }

        /* å›ºå®šã‚«ãƒ©ãƒ ï¼ˆåå‰ï¼‰ã®å¹…èª¿æ•´ */
        .stats-table th:first-child,
        .stats-table td:first-child {
            min-width: 110px; /* å¹…ã‚’ç‹­ã‚ã‚‹ */
            max-width: 140px;
            padding-left: 10px;
            font-size: 0.85rem;
            
            /* é•·ã„åå‰ã¯çœç•¥(...)ã—ã¦è¡¨ç¤º */
            overflow: hidden;
            text-overflow: ellipsis; 
            white-space: nowrap; 
        }
        
        /* ä¸»è¦ã‚¹ã‚¿ãƒƒãƒ„ã®æ–‡å­—ã‚µã‚¤ã‚ºèª¿æ•´ */
        .val-main { font-size: 0.9rem; }
        .val-sub { font-size: 0.75rem; }
        
        /* ãƒ­ã‚´ã‚µã‚¤ã‚ºèª¿æ•´ */
        .mini-logo {
            height: 20px; width: 20px; margin-right: 5px;
        }
    }
</style>

<div class="stats-container">
    
    <div class="search-wrapper">
        <i class="fa-solid fa-magnifying-glass search-icon"></i>
        <input type="text" id="statsSearch" class="search-input" placeholder="ãƒãƒ¼ãƒ åã‚„é¸æ‰‹åã§æ¤œç´¢...">
    </div>

    <div class="stats-section">
        <h2>ãƒãƒ¼ãƒ æˆç¸¾ (å¹³å‡)</h2>
        <div class="table-responsive">
            <table class="stats-table" id="teamTable">
                <thead>
                    <tr>
                        <th>ãƒãƒ¼ãƒ å</th>
                        <th>ãƒªãƒ¼ã‚°</th>
                        <th>å‹</th><th>æ•—</th><th>å‹ç‚¹</th>
                        <th>å¾—ç‚¹</th><th>å¤±ç‚¹</th><th>å¾—å¤±å·®</th>
                        <th>AST</th><th>REB</th><th>STL</th><th>BLK</th>
                        <th>TO</th><th>FOUL</th>
                        <th>FG%</th><th>3P%</th><th>FT%</th>
                    </tr>
                </thead>
                <tbody>
                    {% for row in team_stats %}
                    <tr>
                        <td data-value="{{ row.team_name }}">
                            {% if row.team.logo_image %}
                            <img src="{{ row.team.logo_image }}" class="mini-logo">
                            {% endif %}
                            <a href="{{ url_for('team_detail', team_id=row.team.id) }}" style="display:inline;">{{ row.team_name }}</a>
                        </td>
                        <td>
                            <span style="font-size:0.8em; padding:2px 6px; border-radius:4px; 
                                background:{% if row.league=='Aãƒªãƒ¼ã‚°' %}#ffebee;color:#c62828{% else %}#e3f2fd;color:#1565c0{% endif %}">
                                {{ row.league }}
                            </span>
                        </td>
                        <td>{{ row.wins }}</td>
                        <td>{{ row.losses }}</td>
                        <td style="font-weight:bold;">{{ row.points }}</td>
                        
                        <td class="val-main">{{ "%.1f"|format(row.avg_pf) }}</td>
                        <td>{{ "%.1f"|format(row.avg_pa) }}</td>
                        <td style="color:{% if row.diff > 0 %}green{% elif row.diff < 0 %}red{% endif %};">{{ row.diff }}</td>
                        
                        <td>{{ "%.1f"|format(row.avg_ast) }}</td>
                        <td>{{ "%.1f"|format(row.avg_reb) }}</td>
                        <td>{{ "%.1f"|format(row.avg_stl) }}</td>
                        <td>{{ "%.1f"|format(row.avg_blk) }}</td>
                        <td>{{ "%.1f"|format(row.avg_turnover) }}</td>
                        <td>{{ "%.1f"|format(row.avg_foul) }}</td>
                        
                        <td class="val-pct">{{ "%.1f"|format(row.fg_pct) }}%</td>
                        <td class="val-pct">{{ "%.1f"|format(row.three_p_pct) }}%</td>
                        <td class="val-pct">{{ "%.1f"|format(row.ft_pct) }}%</td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>

    <div class="stats-section">
        <h2>å€‹äººæˆç¸¾ (å¹³å‡)</h2>
        <div class="table-responsive">
            <table class="stats-table" id="playerTable">
                <thead>
                    <tr>
                        <th>é¸æ‰‹å</th>
                        <th>ãƒãƒ¼ãƒ </th>
                        <th>è©¦åˆ</th>
                        <th>PTS</th><th>REB</th><th>AST</th><th>STL</th><th>BLK</th>
                        <th>TO</th><th>FOUL</th>
                        <th>FGM</th><th>FGA</th><th>FG%</th>
                        <th>3PM</th><th>3PA</th><th>3P%</th>
                        <th>FTM</th><th>FTA</th><th>FT%</th>
                    </tr>
                </thead>
                <tbody>
                    {% for row in individual_stats %}
                    <tr>
                        <td data-value="{{ row.player_name }}"><a href="{{ url_for('player_detail', player_id=row.player_id) }}">{{ row.player_name }}</a></td>
                        <td style="text-align:left; font-size:0.9em;" data-value="{{ row.team_name }}">
                            <a href="{{ url_for('team_detail', team_id=row.team_id) }}">{{ row.team_name }}</a>
                        </td>
                        <td>{{ row.games_played }}</td>
                        
                        <td class="val-main">{{ "%.1f"|format(row.avg_pts) }}</td>
                        <td>{{ "%.1f"|format(row.avg_reb) }}</td>
                        <td>{{ "%.1f"|format(row.avg_ast) }}</td>
                        <td>{{ "%.1f"|format(row.avg_stl) }}</td>
                        <td>{{ "%.1f"|format(row.avg_blk) }}</td>
                        
                        <td>{{ "%.1f"|format(row.avg_turnover) }}</td>
                        <td>{{ "%.1f"|format(row.avg_foul) }}</td>
                        
                        <td class="val-sub">{{ "%.1f"|format(row.avg_fgm) }}</td>
                        <td class="val-sub">{{ "%.1f"|format(row.avg_fga) }}</td>
                        <td class="val-pct">{{ "%.1f"|format(row.fg_pct) }}%</td>
                        
                        <td class="val-sub">{{ "%.1f"|format(row.avg_three_pm) }}</td>
                        <td class="val-sub">{{ "%.1f"|format(row.avg_three_pa) }}</td>
                        <td class="val-pct">{{ "%.1f"|format(row.three_p_pct) }}%</td>
                        
                        <td class="val-sub">{{ "%.1f"|format(row.avg_ftm) }}</td>
                        <td class="val-sub">{{ "%.1f"|format(row.avg_fta) }}</td>
                        <td class="val-pct">{{ "%.1f"|format(row.ft_pct) }}%</td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>

</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    
    // --- 1. æ¤œç´¢æ©Ÿèƒ½ ---
    const searchInput = document.getElementById('statsSearch');
    
    searchInput.addEventListener('keyup', function() {
        const searchText = this.value.toLowerCase().trim();
        const allRows = document.querySelectorAll('.stats-table tbody tr');

        allRows.forEach(row => {
            // æ¤œç´¢å¯¾è±¡ï¼šé¸æ‰‹åã‚»ãƒ«(data-value) ã¨ ãƒãƒ¼ãƒ åã‚»ãƒ«(data-value or text)
            // ãƒãƒ¼ãƒ æˆç¸¾è¡¨ã®å ´åˆã¯1åˆ—ç›®ãŒãƒãƒ¼ãƒ åã€å€‹äººæˆç¸¾è¡¨ã®å ´åˆã¯2åˆ—ç›®ã‚‚ãƒãƒ¼ãƒ å
            let textToSearch = "";
            const cells = row.querySelectorAll('td');
            if (cells.length > 0) textToSearch += cells[0].textContent; // 1åˆ—ç›® (åå‰)
            if (cells.length > 1) textToSearch += " " + cells[1].textContent; // 2åˆ—ç›® (å€‹äººæˆç¸¾ã®ãƒãƒ¼ãƒ åãªã©)

            if (textToSearch.toLowerCase().includes(searchText)) {
                row.style.display = '';
            } else {
                row.style.display = 'none';
            }
        });
    });

    // --- 2. ã‚½ãƒ¼ãƒˆæ©Ÿèƒ½ ---
    const getCellValue = (tr, idx) => {
        const td = tr.children[idx];
        return td.getAttribute('data-value') || td.textContent || td.innerText;
    };

    const comparer = (idx, asc) => (a, b) => {
        const v1 = getCellValue(asc ? a : b, idx);
        const v2 = getCellValue(asc ? b : a, idx);
        
        // æ•°å€¤å¤‰æ›ï¼ˆã‚«ãƒ³ãƒã‚„%ã‚’é™¤å»ã—ã¦ãƒ‘ãƒ¼ã‚¹ï¼‰
        const n1 = parseFloat(v1.replace(/[^\d.-]/g, ''));
        const n2 = parseFloat(v2.replace(/[^\d.-]/g, ''));

        if (!isNaN(n1) && !isNaN(n2)) {
            return n1 - n2;
        }
        return v1.toString().localeCompare(v2, 'ja');
    };

    document.querySelectorAll('.stats-table th').forEach(th => {
        th.addEventListener('click', (() => {
            const table = th.closest('table');
            const tbody = table.querySelector('tbody');
            if (!tbody || tbody.querySelectorAll('tr').length === 0) return;

            const elementIndex = Array.from(th.parentNode.children).indexOf(th);
            const isAsc = th.classList.contains('asc');
            
            // ä»–ã®ãƒ˜ãƒƒãƒ€ãƒ¼ã®ã‚¯ãƒ©ã‚¹ã‚’ãƒªã‚»ãƒƒãƒˆ
            table.querySelectorAll('th').forEach(h => h.classList.remove('asc', 'desc'));
            
            if (isAsc) {
                th.classList.remove('asc'); th.classList.add('desc');
            } else {
                th.classList.add('asc'); th.classList.remove('desc');
            }

            Array.from(tbody.querySelectorAll('tr'))
                .sort(comparer(elementIndex, !isAsc))
                .forEach(tr => tbody.appendChild(tr));
        }));
    });
});
</script>
{% endblock %}