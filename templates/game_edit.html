{% extends "layout.html" %}

{% block content %}
<script type="text/javascript" src="https://cdn.jsdelivr.net/npm/browser-image-compression@2.0.2/dist/browser-image-compression.js"></script>

<style>
  /* æ—¢å­˜ã®ã‚¹ã‚¿ã‚¤ãƒ« */
  .bench { border: 1px solid #ddd; padding: 10px; margin-bottom: 15px; border-radius: 5px; }
  .bench-player { background-color: #f0f0f0; border: 1px solid #ccc; padding: 5px 10px; border-radius: 15px; cursor: pointer; display: inline-block; margin: 5px; }
  .bench-player:hover { background-color: #e0e0e0; }
  .bench-player.selected { background-color: #a0a0a0; color: white; cursor: not-allowed; }
  .stats-table input { width: 50px; text-align: right; }
  
  .team-section h3 a, .stats-table td a { color: inherit; text-decoration: none; }
  .team-section h3 a:hover, .stats-table td a:hover { color: #004a99; text-decoration: underline; }

  /* ã‚¿ãƒ–åˆ‡ã‚Šæ›¿ãˆ */
  .tab-navigation { display: flex; border-bottom: 1px solid #ddd; margin-bottom: 20px; }
  .tab-btn { padding: 10px 20px; cursor: pointer; background-color: #f1f1f1; border: 1px solid #ddd; border-bottom: none; margin-bottom: -1px; border-radius: 5px 5px 0 0; font-weight: bold; }
  .tab-btn.active { background-color: #fff; border-bottom: 1px solid #fff; color: #004a99; }
  .tab-content { display: none; }
  .tab-content.active { display: block; }

  /* ãƒãƒ¼ãƒ æ¯”è¼ƒã‚°ãƒ©ãƒ• */
  .comparison-container { max-width: 700px; margin: 20px auto; font-family: 'Roboto', sans-serif; }
  .comparison-row { margin-bottom: 12px; }
  .comparison-row .label { text-align: center; font-size: 13px; color: #666; margin-bottom: 4px; font-weight: bold; }
  .comparison-grid { display: grid; grid-template-columns: 60px 1fr 1px 1fr 60px; align-items: center; gap: 5px; height: 24px; }
  .value-home { text-align: right; font-weight: bold; color: #999; }
  .value-away { text-align: left; font-weight: bold; color: #999; }
  .value-home.winner, .value-away.winner { color: #333; font-size: 1.1em; }
  .center-line { width: 100%; height: 100%; background-color: #ddd; }
  .bar-area { width: 100%; height: 100%; background-color: #f0f0f0; position: relative; border-radius: 4px; }
  .bar-fill { height: 100%; width: 0%; transition: width 0.4s ease; position: absolute; top: 0; }
  .bar-area-home .bar-fill { right: 0; background-color: #ccc; border-radius: 4px 0 0 4px; }
  .bar-area-home .bar-fill.winner { background-color: #004a99; }
  .bar-area-away .bar-fill { left: 0; background-color: #ccc; border-radius: 0 4px 4px 0; }
  .bar-area-away .bar-fill.winner { background-color: #004a99; }

  /* AIè§£æã‚¨ãƒªã‚¢ */
  .ai-scan-area { background: #e8f4ff; border: 2px dashed #004a99; padding: 20px; border-radius: 10px; margin-bottom: 30px; text-align: center; }
  .ai-scan-title { font-weight: bold; color: #004a99; margin-bottom: 10px; display: block; font-size: 1.1em; }
  .ai-btn { background: #004a99; color: white; border: none; padding: 10px 20px; border-radius: 5px; font-weight: bold; cursor: pointer; margin-top: 10px; }
  .ai-btn:disabled { background: #ccc; cursor: not-allowed; }
  .loading-msg { color: #004a99; font-weight: bold; margin-top: 10px; display: none; }
  
  /* ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ç”»åƒç”¨ */
  #preview-container { margin-top: 10px; display: flex; gap: 10px; flex-wrap: wrap; justify-content: center; }
  .preview-img { max-width: 150px; max-height: 150px; border: 1px solid #ccc; border-radius: 5px; }
</style>

<h2>çµæœå…¥åŠ›: {{ game.home_team.name }} vs {{ game.away_team.name }}</h2>

<p style="margin-bottom: 15px;">
  ãƒãƒ¼ãƒ å¾—ç‚¹ã¯è‡ªå‹•è¨ˆç®—ã•ã‚Œã¾ã™ã€‚èª­ã¿å–ã‚ŠãŒã†ã¾ãã„ã‹ãªã„å ´åˆã¯æ‰‹å‹•ã§å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚
</p>

<div class="ai-scan-area">
    <span class="ai-scan-title">ğŸ¤– AIè‡ªå‹•å…¥åŠ› (Beta)</span>
    
    <div style="background-color: #fff; padding: 10px; border-radius: 5px; margin-bottom: 15px; border: 1px solid #ddd; text-align: left; display: inline-block;">
        <p style="margin: 0 0 5px; color: #d9534f; font-weight: bold;">
            âš ï¸ é‡è¦: ç”»åƒã¯å¿…ãšã€ŒPNGå½¢å¼ã€ã‚’ä½¿ç”¨ã—ã¦ãã ã•ã„ã€‚
        </p>
        <p style="font-size: 0.9em; margin: 0; color: #555;">
            JPGå½¢å¼ã¯åœ§ç¸®ãƒã‚¤ã‚ºã«ã‚ˆã‚Šã€Œ8ã€ã¨ã€Œ6ã€ãªã©ã‚’èª¤èªã™ã‚‹å¯èƒ½æ€§ãŒé«˜ããªã‚Šã¾ã™ã€‚<br>
            å›ç·šè½ã¡ç­‰ã§ãƒªã‚¶ãƒ«ãƒˆãŒåˆ†ã‹ã‚ŒãŸå ´åˆã¯ã€<b>è¤‡æ•°ã®ç”»åƒã‚’åŒæ™‚ã«é¸æŠ</b>ã—ã¦ãã ã•ã„ï¼ˆAIãŒåˆç®—ã—ã¾ã™ï¼‰ã€‚
        </p>
    </div>
    <br>

    <input type="file" id="score-image-input" accept="image/*" multiple style="display:none;" onchange="previewImages(this)">
    <button type="button" onclick="document.getElementById('score-image-input').click()" style="padding:5px 10px; cursor:pointer;">ğŸ“· ç”»åƒã‚’é¸æŠï¼ˆè¤‡æ•°å¯ï¼‰ / è²¼ã‚Šä»˜ã‘</button>
    
    <div id="preview-container"></div>
    
    <button id="analyze-btn" class="ai-btn" onclick="analyzeImage()" style="display:none;">âœ¨ ç”»åƒã‚’AIã§èª­ã¿å–ã‚‹</button>
    <div id="loading-msg" class="loading-msg">AIãŒè§£æä¸­... (æšæ•°ã«ã‚ˆã‚Šæ™‚é–“ãŒã‹ã‹ã‚Šã¾ã™)</div>
</div>

{% if current_user.is_admin %}
<div style="background-color: #f8d3da; border: 1px solid #f5c6cb; padding: 15px; border-radius: 5px; margin-bottom: 20px;">
    <h4>ç®¡ç†è€…ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ï¼šä¸æˆ¦å‹å‡¦ç†</h4>
    <div style="display: flex; gap: 20px;">
      <form action="{{ url_for('forfeit_game', game_id=game.id) }}" method="post" onsubmit="return confirm('{{ game.home_team.name }} ã®ä¸æˆ¦å‹ã¨ã—ã¦è¨˜éŒ²ã—ã¾ã™ã‹ï¼Ÿ');">
          <input type="hidden" name="winning_team_id" value="{{ game.home_team_id }}">
          <button type="submit" style="background-color: #28a745; color: white;">{{ game.home_team.name }} ã®ä¸æˆ¦å‹</button>
      </form>
      <form action="{{ url_for('forfeit_game', game_id=game.id) }}" method="post" onsubmit="return confirm('{{ game.away_team.name }} ã®ä¸æˆ¦å‹ã¨ã—ã¦è¨˜éŒ²ã—ã¾ã™ã‹ï¼Ÿ');">
          <input type="hidden" name="winning_team_id" value="{{ game.away_team_id }}">
          <button type="submit" style="background-color: #28a745; color: white;">{{ game.away_team.name }} ã®ä¸æˆ¦å‹</button>
      </form>
    </div>
</div>
{% endif %}

<div class="tab-navigation">
  <div class="tab-btn active" data-tab="tab-input">ã‚¹ã‚¿ãƒƒãƒ„å…¥åŠ›</div>
  <div class="tab-btn" data-tab="tab-compare">ãƒãƒ¼ãƒ æ¯”è¼ƒ</div>
</div>

<div id="tab-input" class="tab-content active">
  <form method="post">
    <input type="hidden" name="result_image_url" id="result_image_url_input">

    {# --- ã‚¢ã‚¦ã‚§ã‚¤ãƒãƒ¼ãƒ  --- #}
    <div class="team-section">
      <h3><a href="{{ url_for('team_detail', team_id=game.away_team.id) }}" target="_blank">{{ game.away_team.name }} (ã‚¢ã‚¦ã‚§ã‚¤)</a></h3>
      <div class="bench" id="bench-away">
          <strong>ãƒ™ãƒ³ãƒ:</strong>
        {% for player in game.away_team.players %}
          <span class="bench-player" data-team-id="away" data-player-id="{{ player.id }}" data-player-name="{{ player.name }}">{{ player.name }}</span>
        {% endfor %}
      </div>
      <table class="stats-table">
        <thead id="stats-header-away"></thead>
        <tbody id="stats-body-away"></tbody>
      </table>
      <button type="button" class="reset-btn" data-team-id="away">é¸æŠã‚’ãƒªã‚»ãƒƒãƒˆ</button>
    </div>

    <hr style="margin: 30px 0;">

    {# --- ãƒ›ãƒ¼ãƒ ãƒãƒ¼ãƒ  --- #}
    <div class="team-section">
      <h3><a href="{{ url_for('team_detail', team_id=game.home_team.id) }}" target="_blank">{{ game.home_team.name }} (ãƒ›ãƒ¼ãƒ )</a></h3>
      <div class="bench" id="bench-home">
          <strong>ãƒ™ãƒ³ãƒ:</strong>
        {% for player in game.home_team.players %}
          <span class="bench-player" data-team-id="home" data-player-id="{{ player.id }}" data-player-name="{{ player.name }}">{{ player.name }}</span>
        {% endfor %}
      </div>
      <table class="stats-table">
        <thead id="stats-header-home"></thead>
        <tbody id="stats-body-home"></tbody>
      </table>
      <button type="button" class="reset-btn" data-team-id="home">é¸æŠã‚’ãƒªã‚»ãƒƒãƒˆ</button>
    </div>

    <hr style="margin: 30px 0;">

    <div>
      <h3>è©¦åˆã®å‹•ç”»ãƒªãƒ³ã‚¯</h3>
      <div style="margin-bottom: 10px;">
        <label for="youtube_url_away">{{ game.away_team.name }}å´ URL:</label>
        <input type="url" id="youtube_url_away" name="youtube_url_away" value="{{ game.youtube_url_away or '' }}" placeholder="https://..." style="width: 100%; max-width: 500px; padding: 5px;">
      </div>
      <div>
        <label for="youtube_url_home">{{ game.home_team.name }}å´ URL:</label>
        <input type="url" id="youtube_url_home" name="youtube_url_home" value="{{ game.home_team.name or '' }}" placeholder="https://..." style="width: 100%; max-width: 500px; padding: 5px;">
      </div>
    </div>
    
    <button type="submit" style="margin-top: 20px; padding: 10px 20px; font-size: 16px;">çµæœã‚’ä¿å­˜</button>
  </form>
</div>

<div id="tab-compare" class="tab-content">
  <div class="comparison-container">
    {% for item in [('pts', 'å¾—ç‚¹'), ('fgp', 'FG%'), ('3pp', '3P%'), ('ftp', 'FT%'), ('reb', 'ãƒªãƒã‚¦ãƒ³ãƒ‰'), ('ast', 'ã‚¢ã‚·ã‚¹ãƒˆ'), ('stl', 'ã‚¹ãƒ†ã‚£ãƒ¼ãƒ«'), ('blk', 'ãƒ–ãƒ­ãƒƒã‚¯'), ('to', 'ã‚¿ãƒ¼ãƒ³ã‚ªãƒ¼ãƒãƒ¼'), ('foul', 'ãƒ•ã‚¡ã‚¦ãƒ«')] %}
    <div class="comparison-row">
      <div class="label">{{ item[1] }}</div>
      <div class="comparison-grid">
        <div class="value-home" id="compare-{{ item[0] }}-home">0</div>
        <div class="bar-area bar-area-home"><div class="bar-fill" id="compare-{{ item[0] }}-bar-home"></div></div>
        <div class="center-line"></div>
        <div class="bar-area bar-area-away"><div class="bar-fill" id="compare-{{ item[0] }}-bar-away"></div></div>
        <div class="value-away" id="compare-{{ item[0] }}-away">0</div>
      </div>
    </div>
    {% endfor %}
  </div>
</div>
{% endblock %}

{% block scripts %}
<script>
const existingStats = {{ stats | tojson }};
const statHeaders = ['é¸æ‰‹å', 'å¾—ç‚¹', 'ï¾˜ï¾Šï¾ï½³ï¾ï¾„ï¾', 'ï½±ï½¼ï½½ï¾„', 'ï½½ï¾ƒï½¨ï½°ï¾™', 'ï¾Œï¾ï¾›ï½¯ï½¸', 'ï¾Œï½§ï½³ï¾™', 'TO', 'FGM', 'FGA', '3PM', '3PA', 'FTM', 'FTA'];
const statFields = ['player_name', 'pts', 'reb', 'ast', 'stl', 'blk', 'foul', 'turnover', 'fgm', 'fga', 'three_pm', 'three_pa', 'ftm', 'fta'];

// --- è¤‡æ•°ç”»åƒã®ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ ---
function previewImages(input) {
    const container = document.getElementById('preview-container');
    container.innerHTML = ''; // ã‚¯ãƒªã‚¢
    const files = input.files;

    if (files.length > 0) {
        Array.from(files).forEach(file => {
            const reader = new FileReader();
            reader.onload = function(e) {
                const img = document.createElement('img');
                img.src = e.target.result;
                img.className = 'preview-img';
                container.appendChild(img);
            }
            reader.readAsDataURL(file);
        });
        document.getElementById('analyze-btn').style.display = 'inline-block';
    }
}

// ã‚¯ãƒªãƒƒãƒ—ãƒœãƒ¼ãƒ‰è²¼ã‚Šä»˜ã‘å¯¾å¿œ
document.addEventListener('paste', function(e) {
    const items = e.clipboardData.items;
    const container = document.getElementById('preview-container');
    container.innerHTML = '';
    
    for (let i = 0; i < items.length; i++) {
        if (items[i].type.indexOf('image') !== -1) {
            const blob = items[i].getAsFile();
            const reader = new FileReader();
            reader.onload = function(event) {
                const img = document.createElement('img');
                img.src = event.target.result;
                img.className = 'preview-img';
                container.appendChild(img);
                document.getElementById('analyze-btn').style.display = 'inline-block';
                window.pastedImageBlob = blob;
            };
            reader.readAsDataURL(blob);
        }
    }
});

// â˜…è‡ªå‹•åœ§ç¸® & è¤‡æ•°æšé€ä¿¡ & AIè§£æ
async function analyzeImage() {
    const input = document.getElementById('score-image-input');
    let files = input.files;
    
    if ((!files || files.length === 0) && window.pastedImageBlob) {
        files = [window.pastedImageBlob];
    }

    if (!files || files.length === 0) {
        alert('ç”»åƒã‚’é¸æŠã—ã¦ãã ã•ã„');
        return;
    }

    const btn = document.getElementById('analyze-btn');
    const msg = document.getElementById('loading-msg');
    
    btn.disabled = true;
    msg.style.display = 'block';
    msg.innerText = `${files.length}æšã®ç”»åƒã‚’æœ€é©åŒ–ä¸­...`;

    try {
        // --- â˜…ä¿®æ­£: 4Kç”»è³ªå„ªå…ˆã®åœ§ç¸®è¨­å®š ---
        const options = {
            // ã‚µã‚¤ã‚ºåˆ¶é™ã‚’ Vercelä¸Šé™(4.5MB) ã‚®ãƒªã‚®ãƒªã¾ã§ç·©ã‚ã‚‹
            // é«˜è§£åƒåº¦ã‚’æ®‹ã™ãŸã‚ã«ã€å®¹é‡ã«ã¯ä½™è£•ã‚’æŒãŸã›ã‚‹
            maxSizeMB: 2.0,
            
            // 4Kè§£åƒåº¦(3840px)ã¾ã§ã¯ãƒªã‚µã‚¤ã‚ºã›ãšã«ç¶­æŒã™ã‚‹
            // æ–‡å­—ãŒå°ã•ãã¦ã‚‚æ½°ã‚Œãªã„ã‚ˆã†ã«ã™ã‚‹ãŸã‚
            maxWidthOrHeight: 3840,
            
            // ç”»è³ªã¯é«˜ã‚(0.85)ã«ç¶­æŒã—ã¦ã€ãƒã‚¤ã‚ºã«ã‚ˆã‚‹èª¤èª­ã‚’é˜²ã
            initialQuality: 0.85,
            
            useWebWorker: true
        };

        const formData = new FormData();
        const fileArray = files instanceof FileList ? Array.from(files) : files;

        for (const file of fileArray) {
            console.log(`åœ§ç¸®ä¸­: ${file.name || 'pasted'}`);
            // æŒ‡å®šã—ãŸoptionsã§åœ§ç¸®
            const compressedFile = await imageCompression(file, options);
            formData.append('image', compressedFile);
        }

        msg.innerText = 'AIãŒè§£æï¼†è¨ˆç®—ä¸­... (10ã€œ20ç§’ã‹ã‹ã‚Šã¾ã™)';

        const response = await fetch('/api/analyze_stats', {
            method: 'POST',
            body: formData
        });

        const data = await response.json();

        if (data.error) {
            alert('ã‚¨ãƒ©ãƒ¼: ' + data.error);
        } else {
            if (data.image_url) {
                document.getElementById('result_image_url_input').value = data.image_url;
            }
            await autoFillStats(data.players);
            alert('å…¥åŠ›ãŒå®Œäº†ã—ã¾ã—ãŸï¼\næ•°å€¤ã¨ä¸¦ã³é †ã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚');
        }

    } catch (error) {
        console.error(error);
        alert('ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ: ' + error.message);
    } finally {
        btn.disabled = false;
        msg.style.display = 'none';
    }
}

// ==========================================
// â˜…ãƒ˜ãƒ«ãƒ‘ãƒ¼é–¢æ•°ï¼š2ã¤ã®æ–‡å­—åˆ—ãŒã©ã‚Œãã‚‰ã„ä¼¼ã¦ã„ã‚‹ã‹è¨ˆç®—ã™ã‚‹ (0ã€œ1ã®ã‚¹ã‚³ã‚¢)
// ==========================================
function getSimilarity(s1, s2) {
    const longer = s1.length > s2.length ? s1 : s2;
    const shorter = s1.length > s2.length ? s2 : s1;
    const longerLength = longer.length;
    if (longerLength === 0) return 1.0;
    
    // ç·¨é›†è·é›¢(Levenshtein Distance)ã‚’è¨ˆç®—
    const costs = new Array();
    for (let i = 0; i <= s1.length; i++) {
        let lastValue = i;
        for (let j = 0; j <= s2.length; j++) {
            if (i == 0) costs[j] = j;
            else {
                if (j > 0) {
                    let newValue = costs[j - 1];
                    if (s1.charAt(i - 1) != s2.charAt(j - 1))
                        newValue = Math.min(Math.min(newValue, lastValue), costs[j]) + 1;
                    costs[j - 1] = lastValue;
                    lastValue = newValue;
                }
            }
        }
        if (i > 0) costs[s2.length] = lastValue;
    }
    
    return (longerLength - costs[s2.length]) / longerLength;
}

// æ–‡å­—åˆ—ã‚’æ¯”è¼ƒç”¨ã«ãã‚Œã„ã«ã™ã‚‹é–¢æ•°
function normalizeName(name) {
    if (!name) return '';
    return name.toString()
        .toLowerCase()
        .replace(/[-_ .]/g, '')     // è¨˜å·å‰Šé™¤
        .replace(/[1lI|]/g, 'i')    // å½¢ãŒä¼¼ã¦ã„ã‚‹æ–‡å­—ã‚’çµ±ä¸€
        .replace(/[0oO]/g, 'o');
}

// ==========================================
// â˜…ãƒ¡ã‚¤ãƒ³ï¼šä¸€ç•ªä¼¼ã¦ã„ã‚‹é¸æ‰‹ã‚’æ¢ã—ã¦å…¥åŠ›ã™ã‚‹é–¢æ•°
// ==========================================
async function autoFillStats(aiPlayers) {
    if (!aiPlayers || aiPlayers.length === 0) return;

    // 1. ãƒªã‚»ãƒƒãƒˆ
    document.querySelectorAll('.reset-btn').forEach(btn => btn.click());
    const allBenchPlayers = document.querySelectorAll('.bench-player');
    
    console.log("--- AIè‡ªå‹•å…¥åŠ›é–‹å§‹ ---");

    // 2. AIãƒªã‚¹ãƒˆé †ã«å‡¦ç†
    for (const aiP of aiPlayers) {
        let bestMatchElement = null;
        let bestScore = 0;
        
        // AIã®åå‰ã‚’æ­£è¦åŒ–
        const normAiName = normalizeName(aiP.name);

        // ãƒ™ãƒ³ãƒã®å…¨é¸æ‰‹ã¨æ¯”è¼ƒã—ã¦ã€ä¸€ç•ªã‚¹ã‚³ã‚¢ãŒé«˜ã„(ä¼¼ã¦ã„ã‚‹)é¸æ‰‹ã‚’æ¢ã™
        for (const el of allBenchPlayers) {
            const dbName = el.dataset.playerName;
            const normDbName = normalizeName(dbName);
            
            // é¡ä¼¼åº¦ã‚¹ã‚³ã‚¢ã‚’è¨ˆç®— (0.0 ã€œ 1.0)
            let score = getSimilarity(normAiName, normDbName);
            
            // éƒ¨åˆ†ä¸€è‡´ãƒœãƒ¼ãƒŠã‚¹ (ã©ã¡ã‚‰ã‹ãŒå«ã¾ã‚Œã¦ã„ã‚Œã°ã‚¹ã‚³ã‚¢å¤§å¹…ã‚¢ãƒƒãƒ—)
            if (normAiName.includes(normDbName) || normDbName.includes(normAiName)) {
                score = Math.max(score, 0.9);
            }

            // ç¾åœ¨ã®æœ€é«˜ã‚¹ã‚³ã‚¢ã‚ˆã‚Šé«˜ã‘ã‚Œã°å€™è£œã‚’æ›´æ–°
            if (score > bestScore) {
                bestScore = score;
                bestMatchElement = el;
            }
        }

        // ã‚¹ã‚³ã‚¢ãŒ 0.4 (40%ä¸€è‡´) ä»¥ä¸Šãªã‚‰æ¡ç”¨
        // (åå‰ãŒçŸ­ã™ãã‚‹ã¨èª¤çˆ†ã™ã‚‹å¯èƒ½æ€§ãŒã‚ã‚Šã¾ã™ãŒã€NBA IDãªã‚‰å¤§ä¸ˆå¤«)
        if (bestMatchElement && bestScore > 0.4) {
            console.log(`Match: AI[${aiP.name}] -> DB[${bestMatchElement.dataset.playerName}] (Score: ${bestScore.toFixed(2)})`);
            
            if (!bestMatchElement.classList.contains('selected')) {
                bestMatchElement.click();
                await new Promise(r => setTimeout(r, 100)); // ã‚¯ãƒªãƒƒã‚¯åæ˜ å¾…ã¡
            }
            
            const playerId = bestMatchElement.dataset.playerId;
            const row = document.querySelector(`tr[data-player-id="${playerId}"]`);
            
            if (row) {
                const map = {
                    'pts': 'pts', 'reb': 'reb', 'ast': 'ast', 'stl': 'stl', 'blk': 'blk',
                    'foul': 'foul', 'to': 'turnover', 
                    'fgm': 'fgm', 'fga': 'fga', 
                    '3pm': 'three_pm', '3pa': 'three_pa', 
                    'ftm': 'ftm', 'fta': 'fta'
                };
                
                for (const [aiKey, formKey] of Object.entries(map)) {
                    const input = row.querySelector(`input[name="player_${playerId}_${formKey}"]`);
                    if (input && aiP[aiKey] !== undefined) {
                        input.value = aiP[aiKey];
                    }
                }
            }
        } else {
            console.log(`No match found for AI player: ${aiP.name}`);
        }
    }
    updateComparisonView();
}

// --- ä»¥ä¸‹ã€æ—¢å­˜ã®ãƒ­ã‚¸ãƒƒã‚¯ (å¤‰æ›´ãªã—) ---
document.addEventListener('DOMContentLoaded', function() {
  const tabButtons = document.querySelectorAll('.tab-btn');
  const tabContents = document.querySelectorAll('.tab-content');
  tabButtons.forEach(button => {
    button.addEventListener('click', function() {
      tabButtons.forEach(btn => btn.classList.remove('active'));
      tabContents.forEach(content => content.classList.remove('active'));
      this.classList.add('active');
      document.getElementById(this.dataset.tab).classList.add('active');
      if (this.dataset.tab === 'tab-compare') updateComparisonView();
    });
  });

  function createHeaderRow() {
    return '<tr>' + statHeaders.map(h => `<th>${h}</th>`).join('') + '</tr>';
  }

  function createPlayerRow(playerId, playerName, teamId) {
    const playerStats = existingStats[String(playerId)] || {};
    let rowHTML = `<td><a href="/player/${playerId}" target="_blank">${playerName}</a></td>`;
    statFields.slice(1).forEach(field => {
      const rawValue = playerStats[field];
      const displayValue = (rawValue !== undefined && rawValue !== 0 && rawValue !== '0') ? rawValue : '';
      rowHTML += `<td><input type="number" name="player_${playerId}_${field}" value="${displayValue}" placeholder="0" min="0" oninput="updateComparisonView()"></td>`;
    });
    return `<tr data-player-id="${playerId}" data-player-name="${playerName}" data-team-id="${teamId}">${rowHTML}</tr>`;
  }
  
  function populateInitialStats() {
    const statsHeaderHome = document.getElementById('stats-header-home');
    const statsBodyHome = document.getElementById('stats-body-home');
    const statsHeaderAway = document.getElementById('stats-header-away');
    const statsBodyAway = document.getElementById('stats-body-away');
    let homeHasStats = false;
    let awayHasStats = false;

    for (const playerId in existingStats) {
      const player = document.querySelector(`.bench-player[data-player-id='${playerId}']`);
      if (player) {
        const teamId = player.dataset.teamId;
        const playerName = player.dataset.playerName;
        if (teamId === 'home') {
          statsBodyHome.insertAdjacentHTML('beforeend', createPlayerRow(playerId, playerName, teamId));
          player.classList.add('selected'); 
          homeHasStats = true;
        } else if (teamId === 'away') {
          statsBodyAway.insertAdjacentHTML('beforeend', createPlayerRow(playerId, playerName, teamId));
          player.classList.add('selected');
          awayHasStats = true;
        }
      }
    }
    if (homeHasStats) statsHeaderHome.innerHTML = createHeaderRow();
    if (awayHasStats) statsHeaderAway.innerHTML = createHeaderRow();
    updateComparisonView();
  }

  populateInitialStats();

  // æ‰‹å‹•å…¥åŠ›
  document.querySelectorAll('.bench-player').forEach(playerSpan => {
    playerSpan.addEventListener('click', function() {
      if (this.classList.contains('selected')) return;
      const teamId = this.dataset.teamId;
      const statsBody = document.getElementById(`stats-body-${teamId}`); 
      if (statsBody.children.length >= 5) { alert('é¸æŠã§ãã‚‹é¸æ‰‹ã¯5äººã¾ã§ã§ã™ã€‚'); return; }
      const statsHeader = document.getElementById(`stats-header-${teamId}`);
      if (statsHeader.children.length === 0) statsHeader.innerHTML = createHeaderRow();
      
      const playerId = this.dataset.playerId;
      const playerName = this.dataset.playerName;
      statsBody.insertAdjacentHTML('beforeend', createPlayerRow(playerId, playerName, teamId));
      this.classList.add('selected');
      updateComparisonView();
    });
  });

  document.querySelectorAll('.reset-btn').forEach(button => {
    button.addEventListener('click', function() {
      const teamId = this.dataset.teamId;
      document.getElementById(`stats-header-${teamId}`).innerHTML = '';
      document.getElementById(`stats-body-${teamId}`).innerHTML = '';
      document.querySelectorAll(`#bench-${teamId} .bench-player`).forEach(span => {
        span.classList.remove('selected');
      });
      updateComparisonView();
    });
  });
});

// ã‚°ãƒ©ãƒ•æ›´æ–°
function updateComparisonView() {
    const homeStats = { pts: 0, reb: 0, ast: 0, stl: 0, blk: 0, to: 0, foul: 0, fgm: 0, fga: 0, '3pm': 0, '3pa': 0, ftm: 0, fta: 0 };
    const awayStats = { pts: 0, reb: 0, ast: 0, stl: 0, blk: 0, to: 0, foul: 0, fgm: 0, fga: 0, '3pm': 0, '3pa': 0, ftm: 0, fta: 0 };

    document.querySelectorAll('#stats-body-home tr').forEach(row => {
      homeStats.pts += parseFloat(row.querySelector('input[name$="_pts"]').value) || 0;
      homeStats.reb += parseFloat(row.querySelector('input[name$="_reb"]').value) || 0;
      homeStats.ast += parseFloat(row.querySelector('input[name$="_ast"]').value) || 0;
      homeStats.stl += parseFloat(row.querySelector('input[name$="_stl"]').value) || 0;
      homeStats.blk += parseFloat(row.querySelector('input[name$="_blk"]').value) || 0;
      homeStats.to += parseFloat(row.querySelector('input[name$="_turnover"]').value) || 0;
      homeStats.foul += parseFloat(row.querySelector('input[name$="_foul"]').value) || 0;
      homeStats.fgm += parseFloat(row.querySelector('input[name$="_fgm"]').value) || 0;
      homeStats.fga += parseFloat(row.querySelector('input[name$="_fga"]').value) || 0;
      homeStats['3pm'] += parseFloat(row.querySelector('input[name$="_three_pm"]').value) || 0;
      homeStats['3pa'] += parseFloat(row.querySelector('input[name$="_three_pa"]').value) || 0;
      homeStats.ftm += parseFloat(row.querySelector('input[name$="_ftm"]').value) || 0;
      homeStats.fta += parseFloat(row.querySelector('input[name$="_fta"]').value) || 0;
    });

    document.querySelectorAll('#stats-body-away tr').forEach(row => {
      awayStats.pts += parseFloat(row.querySelector('input[name$="_pts"]').value) || 0;
      awayStats.reb += parseFloat(row.querySelector('input[name$="_reb"]').value) || 0;
      awayStats.ast += parseFloat(row.querySelector('input[name$="_ast"]').value) || 0;
      awayStats.stl += parseFloat(row.querySelector('input[name$="_stl"]').value) || 0;
      awayStats.blk += parseFloat(row.querySelector('input[name$="_blk"]').value) || 0;
      awayStats.to += parseFloat(row.querySelector('input[name$="_turnover"]').value) || 0;
      awayStats.foul += parseFloat(row.querySelector('input[name$="_foul"]').value) || 0;
      awayStats.fgm += parseFloat(row.querySelector('input[name$="_fgm"]').value) || 0;
      awayStats.fga += parseFloat(row.querySelector('input[name$="_fga"]').value) || 0;
      awayStats['3pm'] += parseFloat(row.querySelector('input[name$="_three_pm"]').value) || 0;
      awayStats['3pa'] += parseFloat(row.querySelector('input[name$="_three_pa"]').value) || 0;
      awayStats.ftm += parseFloat(row.querySelector('input[name$="_ftm"]').value) || 0;
      awayStats.fta += parseFloat(row.querySelector('input[name$="_fta"]').value) || 0;
    });

    const homeFGP = homeStats.fga > 0 ? (homeStats.fgm / homeStats.fga * 100) : 0;
    const awayFGP = awayStats.fga > 0 ? (awayStats.fgm / awayStats.fga * 100) : 0;
    const home3PP = homeStats['3pa'] > 0 ? (homeStats['3pm'] / homeStats['3pa'] * 100) : 0;
    const away3PP = awayStats['3pa'] > 0 ? (awayStats['3pm'] / awayStats['3pa'] * 100) : 0;
    const homeFTP = homeStats.fta > 0 ? (homeStats.ftm / homeStats.fta * 100) : 0;
    const awayFTP = awayStats.fta > 0 ? (awayStats.ftm / awayStats.fta * 100) : 0;

    updateSplitBar('pts', homeStats.pts, awayStats.pts, 'integer');
    updateSplitBar('reb', homeStats.reb, awayStats.reb, 'integer');
    updateSplitBar('ast', homeStats.ast, awayStats.ast, 'integer');
    updateSplitBar('stl', homeStats.stl, awayStats.stl, 'integer');
    updateSplitBar('blk', homeStats.blk, awayStats.blk, 'integer');
    updateSplitBar('to', homeStats.to, awayStats.to, 'integer', true);
    updateSplitBar('foul', homeStats.foul, awayStats.foul, 'integer', true);
    updateSplitBar('fgp', homeFGP, awayFGP, 'percent');
    updateSplitBar('3pp', home3PP, away3PP, 'percent');
    updateSplitBar('ftp', homeFTP, awayFTP, 'percent');
}

function updateSplitBar(id, homeVal, awayVal, format = 'integer', lessIsBetter = false) {
    const homeValEl = document.getElementById(`compare-${id}-home`);
    const awayValEl = document.getElementById(`compare-${id}-away`);
    const homeBarEl = document.getElementById(`compare-${id}-bar-home`);
    const awayBarEl = document.getElementById(`compare-${id}-bar-away`);

    if (format === 'percent') {
      homeValEl.textContent = homeVal.toFixed(1) + '%';
      awayValEl.textContent = awayVal.toFixed(1) + '%';
    } else {
      homeValEl.textContent = homeVal;
      awayValEl.textContent = awayVal;
    }

    const total = homeVal + awayVal;
    let homeWidth = 0;
    let awayWidth = 0;
    if (total > 0) {
        homeWidth = (homeVal / total) * 100;
        awayWidth = (awayVal / total) * 100;
    }

    homeBarEl.style.width = homeWidth + '%';
    awayBarEl.style.width = awayWidth + '%';

    homeValEl.classList.remove('winner');
    awayValEl.classList.remove('winner');
    homeBarEl.classList.remove('winner');
    awayBarEl.classList.remove('winner');

    if (homeVal === awayVal) return;
    if ((!lessIsBetter && homeVal > awayVal) || (lessIsBetter && homeVal < awayVal)) {
        homeValEl.classList.add('winner');
        homeBarEl.classList.add('winner');
    } else {
        awayValEl.classList.add('winner');
        awayBarEl.classList.add('winner');
    }
}
</script>
{% endblock %}