{% extends "layout.html" %}
{% block content %}
<style>
  /* 共通スタイル */
  .tab-navigation { display: flex; border-bottom: 1px solid #ddd; margin-bottom: 20px; }
  .tab-btn {
    padding: 10px 20px; cursor: pointer; background-color: #f1f1f1;
    border: 1px solid #ddd; border-bottom: none; margin-bottom: -1px;
    border-radius: 5px 5px 0 0; font-weight: bold;
  }
  .tab-btn.active { background-color: #fff; border-bottom: 1px solid #fff; color: #004a99; }
  .tab-content { display: none; }
  .tab-content.active { display: block; }
  
  /* スコア表示 */
  .final-score { text-align: center; margin: 20px 0; font-weight: bold; }
  .final-score .team-name { font-size: 1.5em; display: inline-block; padding: 0 15px; color: #555; }
  .final-score .team-name a { color: inherit; text-decoration: none; }
  .final-score .team-name a:hover { color: #007bff; }
  .final-score .score { font-size: 2.5em; display: inline-block; }
  .final-score .score.winner { color: #000; }
  .final-score .score.loser { color: #888; }
  
  /* センター分割グラフ */
  .comparison-container { max-width: 700px; margin: 20px auto; font-family: 'Roboto', sans-serif; }
  .comparison-row { margin-bottom: 12px; }
  .comparison-row .label { text-align: center; font-size: 13px; color: #666; margin-bottom: 4px; font-weight: bold; }
  .comparison-grid { display: grid; grid-template-columns: 60px 1fr 1px 1fr 60px; align-items: center; gap: 5px; height: 24px; }
  .value-home { text-align: right; font-weight: bold; color: #999; }
  .value-away { text-align: left; font-weight: bold; color: #999; }
  .value-home.winner, .value-away.winner { color: #333; font-size: 1.1em; }
  .center-line { width: 100%; height: 100%; background-color: #ddd; }
  .bar-area { width: 100%; height: 100%; background-color: #f0f0f0; position: relative; border-radius: 4px; }
  .bar-fill { height: 100%; width: 0%; transition: width 0.4s ease; position: absolute; top: 0; }
  /* ホーム(左)のバー */
  .bar-area-home .bar-fill { right: 0; background-color: #ccc; border-radius: 4px 0 0 4px; }
  .bar-area-home .bar-fill.winner { background-color: #004a99; }
  /* アウェイ(右)のバー */
  .bar-area-away .bar-fill { left: 0; background-color: #ccc; border-radius: 0 4px 4px 0; }
  .bar-area-away .bar-fill.winner { background-color: #004a99; }

  /* ボックススコア */
  .stats-table { width: 100%; border-collapse: collapse; margin-bottom: 20px; }
  .stats-table th, .stats-table td { border: 1px solid #ddd; padding: 8px; text-align: center; }
  .stats-table th { background-color: #f4f4f4; }
  .stats-table .player-name { text-align: left; }
  .stats-table .player-name a { color: inherit; font-weight: bold; text-decoration: none; }
  .stats-table .player-name a:hover { color: #007bff; }
  .stats-table tfoot { font-weight: bold; background-color: #f9f9f9; }
</style>

<h2>試合結果: {{ game.home_team.name }} vs {{ game.away_team.name }}</h2>
<p>{{ game.game_date }} {% if game.start_time %}{{ game.start_time }}{% endif %}</p>

<div class="final-score">
  <span class="team-name {% if game.home_score > game.away_score %}winner{% endif %}">
    <a href="{{ url_for('team_detail', team_id=game.home_team.id) }}">{{ game.home_team.name }}</a>
  </span>
  <span class="score {% if game.home_score > game.away_score %}winner{% else %}loser{% endif %}">{{ game.home_score }}</span>
  -
  <span class="score {% if game.away_score > game.home_score %}winner{% else %}loser{% endif %}">{{ game.away_score }}</span>
  <span class="team-name {% if game.away_score > game.home_score %}winner{% endif %}">
    <a href="{{ url_for('team_detail', team_id=game.away_team.id) }}">{{ game.away_team.name }}</a>
  </span>
</div>

{% if current_user.is_authenticated %}
<div style="text-align: center; margin-bottom: 20px;">
  <a href="{{ url_for('edit_game', game_id=game.id) }}" style="padding: 10px 15px; background-color: #ffc107; color: black; text-decoration: none; border-radius: 5px; font-weight: bold;">
    この試合のスタッツを編集する
  </a>
</div>
{% endif %}

<div class="tab-navigation">
  <div class="tab-btn active" data-tab="tab-compare">チーム比較</div>
  <div class="tab-btn" data-tab="tab-box-score">ボックススコア</div>
</div>

<div id="tab-compare" class="tab-content active">
  <div class="comparison-container">
    {% for item in [
        ('pts', '得点'), ('fgp', 'フィールドゴール'), ('3pp', '3ポイント'), ('ftp', 'フリースロー'),
        ('reb', 'リバウンド'), ('ast', 'アシスト'), ('stl', 'スティール'), ('blk', 'ブロック'),
        ('to', 'ターンオーバー'), ('foul', 'ファウル')
    ] %}
    <div class="comparison-row">
      <div class="label">{{ item[1] }}</div>
      <div class="comparison-grid">
        <div class="value-home" id="compare-{{ item[0] }}-home">0</div>
        <div class="bar-area bar-area-home">
            <div class="bar-fill" id="compare-{{ item[0] }}-bar-home"></div>
        </div>
        <div class="center-line"></div>
        <div class="bar-area bar-area-away">
            <div class="bar-fill" id="compare-{{ item[0] }}-bar-away"></div>
        </div>
        <div class="value-away" id="compare-{{ item[0] }}-away">0</div>
      </div>
    </div>
    {% endfor %}
  </div>
</div>

<div id="tab-box-score" class="tab-content">
  
  <h3>
    <a href="{{ url_for('team_detail', team_id=game.away_team.id) }}" style="color: inherit; text-decoration: none;">
      {{ game.away_team.name }} (アウェイ)
    </a>
  </h3>
  <table class="stats-table" id="box-score-away">
    <thead>
      <tr>
        <th>選手名</th><th>PTS</th><th>REB</th><th>AST</th><th>STL</th><th>BLK</th><th>FOUL</th><th>TO</th><th>FGM/A</th><th>3PM/A</th><th>FTM/A</th>
      </tr>
    </thead>
    <tbody></tbody>
    <tfoot>
      <tr>
        <td>合計</td>
        <td id="box-total-pts-away">0</td><td id="box-total-reb-away">0</td><td id="box-total-ast-away">0</td>
        <td id="box-total-stl-away">0</td><td id="box-total-blk-away">0</td><td id="box-total-foul-away">0</td>
        <td id="box-total-to-away">0</td><td id="box-total-fg-away">0/0</td><td id="box-total-3p-away">0/0</td>
        <td id="box-total-ft-away">0/0</td>
      </tr>
    </tfoot>
  </table>

  <hr>

  <h3>
    <a href="{{ url_for('team_detail', team_id=game.home_team.id) }}" style="color: inherit; text-decoration: none;">
      {{ game.home_team.name }} (ホーム)
    </a>
  </h3>
  <table class="stats-table" id="box-score-home">
    <thead>
      <tr>
        <th>選手名</th><th>PTS</th><th>REB</th><th>AST</th><th>STL</th><th>BLK</th><th>FOUL</th><th>TO</th><th>FGM/A</th><th>3PM/A</th><th>FTM/A</th>
      </tr>
    </thead>
    <tbody></tbody>
    <tfoot>
      <tr>
        <td>合計</td>
        <td id="box-total-pts-home">0</td><td id="box-total-reb-home">0</td><td id="box-total-ast-home">0</td>
        <td id="box-total-stl-home">0</td><td id="box-total-blk-home">0</td><td id="box-total-foul-home">0</td>
        <td id="box-total-to-home">0</td><td id="box-total-fg-home">0/0</td><td id="box-total-3p-home">0/0</td>
        <td id="box-total-ft-home">0/0</td>
      </tr>
    </tfoot>
  </table>

  <div style="margin-top: 20px;">
    <strong>DNP:</strong>
    <p id="dnp-away" style="color: #555;"></p>
    <p id="dnp-home" style="color: #555;"></p>
  </div>

</div>
{% endblock %}


{% block scripts %}
<script>
const existingStats = {{ stats | tojson }};
const allHomePlayers = [
  {% for player in game.home_team.players %}{ id: {{ player.id }}, name: "{{ player.name }}" },{% endfor %}
];
const allAwayPlayers = [
  {% for player in game.away_team.players %}{ id: {{ player.id }}, name: "{{ player.name }}" },{% endfor %}
];

document.addEventListener('DOMContentLoaded', function() {
  
  // タブ切り替え
  const tabButtons = document.querySelectorAll('.tab-btn');
  const tabContents = document.querySelectorAll('.tab-content');
  tabButtons.forEach(button => {
    button.addEventListener('click', function() {
      tabButtons.forEach(btn => btn.classList.remove('active'));
      tabContents.forEach(content => content.classList.remove('active'));
      this.classList.add('active');
      document.getElementById(this.dataset.tab).classList.add('active');
    });
  });

  // 集計
  const homeStats = { pts: 0, reb: 0, ast: 0, stl: 0, blk: 0, to: 0, foul: 0, fgm: 0, fga: 0, '3pm': 0, '3pa': 0, ftm: 0, fta: 0 };
  const awayStats = { pts: 0, reb: 0, ast: 0, stl: 0, blk: 0, to: 0, foul: 0, fgm: 0, fga: 0, '3pm': 0, '3pa': 0, ftm: 0, fta: 0 };
  
  allHomePlayers.forEach(p => {
      const s = existingStats[String(p.id)];
      if (s) {
          homeStats.pts += s.pts||0; homeStats.reb += s.reb||0; homeStats.ast += s.ast||0;
          homeStats.stl += s.stl||0; homeStats.blk += s.blk||0; homeStats.to += s.turnover||0;
          homeStats.foul += s.foul||0; homeStats.fgm += s.fgm||0; homeStats.fga += s.fga||0;
          homeStats['3pm'] += s.three_pm||0; homeStats['3pa'] += s.three_pa||0;
          homeStats.ftm += s.ftm||0; homeStats.fta += s.fta||0;
      }
  });
  allAwayPlayers.forEach(p => {
      const s = existingStats[String(p.id)];
      if (s) {
          awayStats.pts += s.pts||0; awayStats.reb += s.reb||0; awayStats.ast += s.ast||0;
          awayStats.stl += s.stl||0; awayStats.blk += s.blk||0; awayStats.to += s.turnover||0;
          awayStats.foul += s.foul||0; awayStats.fgm += s.fgm||0; awayStats.fga += s.fga||0;
          awayStats['3pm'] += s.three_pm||0; awayStats['3pa'] += s.three_pa||0;
          awayStats.ftm += s.ftm||0; awayStats.fta += s.fta||0;
      }
  });

  // グラフ更新 (lessIsBetter を適用)
  updateSplitBar('pts', homeStats.pts, awayStats.pts, 'integer');
  updateSplitBar('fgp', (homeStats.fga>0?homeStats.fgm/homeStats.fga*100:0), (awayStats.fga>0?awayStats.fgm/awayStats.fga*100:0), 'percent');
  updateSplitBar('3pp', (homeStats['3pa']>0?homeStats['3pm']/homeStats['3pa']*100:0), (awayStats['3pa']>0?awayStats['3pm']/awayStats['3pa']*100:0), 'percent');
  updateSplitBar('ftp', (homeStats.fta>0?homeStats.ftm/homeStats.fta*100:0), (awayStats.fta>0?awayStats.ftm/awayStats.fta*100:0), 'percent');
  updateSplitBar('reb', homeStats.reb, awayStats.reb, 'integer');
  updateSplitBar('ast', homeStats.ast, awayStats.ast, 'integer');
  updateSplitBar('stl', homeStats.stl, awayStats.stl, 'integer');
  updateSplitBar('blk', homeStats.blk, awayStats.blk, 'integer');
  updateSplitBar('to', homeStats.to, awayStats.to, 'integer', true); // ターンオーバー
  updateSplitBar('foul', homeStats.foul, awayStats.foul, 'integer', true); // ファウル

  function updateSplitBar(id, homeVal, awayVal, format, lessIsBetter=false) {
    const homeValEl = document.getElementById(`compare-${id}-home`);
    const awayValEl = document.getElementById(`compare-${id}-away`);
    const homeBarEl = document.getElementById(`compare-${id}-bar-home`);
    const awayBarEl = document.getElementById(`compare-${id}-bar-away`);
    if (!homeValEl) return;

    if (format === 'percent') {
      homeValEl.textContent = homeVal.toFixed(1) + '%';
      awayValEl.textContent = awayVal.toFixed(1) + '%';
    } else {
      homeValEl.textContent = homeVal;
      awayValEl.textContent = awayVal;
    }

    const total = homeVal + awayVal;
    let homeWidth = 0, awayWidth = 0;
    if (total > 0) {
        homeWidth = (homeVal / total) * 100;
        awayWidth = (awayVal / total) * 100;
    }
    homeBarEl.style.width = homeWidth + '%';
    awayBarEl.style.width = awayWidth + '%';

    homeValEl.classList.remove('winner'); awayValEl.classList.remove('winner');
    homeBarEl.classList.remove('winner'); awayBarEl.classList.remove('winner');

    if (homeVal === awayVal) return;
    if ((!lessIsBetter && homeVal > awayVal) || (lessIsBetter && homeVal < awayVal)) {
        homeValEl.classList.add('winner'); homeBarEl.classList.add('winner');
    } else {
        awayValEl.classList.add('winner'); awayBarEl.classList.add('winner');
    }
  }

  // ボックススコア描画
  const homeTbody = document.getElementById('box-score-home').querySelector('tbody');
  const awayTbody = document.getElementById('box-score-away').querySelector('tbody');
  let dnpHome = [], dnpAway = [];

  allHomePlayers.forEach(p => {
    const s = existingStats[String(p.id)];
    if (s) {
      homeTbody.insertAdjacentHTML('beforeend', createBoxRow(p, s));
    } else { dnpHome.push(p.name); }
  });
  allAwayPlayers.forEach(p => {
    const s = existingStats[String(p.id)];
    if (s) {
      awayTbody.insertAdjacentHTML('beforeend', createBoxRow(p, s));
    } else { dnpAway.push(p.name); }
  });

  function createBoxRow(player, stat) {
      return `<tr>
          <td class="player-name"><a href="/player/${player.id}">${player.name}</a></td>
          <td>${stat.pts}</td><td>${stat.reb}</td><td>${stat.ast}</td>
          <td>${stat.stl}</td><td>${stat.blk}</td><td>${stat.foul}</td>
          <td>${stat.turnover}</td><td>${stat.fgm}/${stat.fga}</td>
          <td>${stat.three_pm}/${stat.three_pa}</td><td>${stat.ftm}/${stat.fta}</td>
        </tr>`;
  }
  
  if (dnpHome.length > 0) document.getElementById('dnp-home').textContent = `{{ game.home_team.name }}: ${dnpHome.join(', ')}`;
  if (dnpAway.length > 0) document.getElementById('dnp-away').textContent = `{{ game.away_team.name }}: ${dnpAway.join(', ')}`;

  // 合計行更新
  document.getElementById('box-total-pts-home').textContent = homeStats.pts;
  document.getElementById('box-total-reb-home').textContent = homeStats.reb;
  document.getElementById('box-total-ast-home').textContent = homeStats.ast;
  document.getElementById('box-total-stl-home').textContent = homeStats.stl;
  document.getElementById('box-total-blk-home').textContent = homeStats.blk;
  document.getElementById('box-total-foul-home').textContent = homeStats.foul;
  document.getElementById('box-total-to-home').textContent = homeStats.to;
  document.getElementById('box-total-fg-home').textContent = `${homeStats.fgm}/${homeStats.fga}`;
  document.getElementById('box-total-3p-home').textContent = `${homeStats['3pm']}/${homeStats['3pa']}`;
  document.getElementById('box-total-ft-home').textContent = `${homeStats.ftm}/${homeStats.fta}`;

  document.getElementById('box-total-pts-away').textContent = awayStats.pts;
  document.getElementById('box-total-reb-away').textContent = awayStats.reb;
  document.getElementById('box-total-ast-away').textContent = awayStats.ast;
  document.getElementById('box-total-stl-away').textContent = awayStats.stl;
  document.getElementById('box-total-blk-away').textContent = awayStats.blk;
  document.getElementById('box-total-foul-away').textContent = awayStats.foul;
  document.getElementById('box-total-to-away').textContent = awayStats.to;
  document.getElementById('box-total-fg-away').textContent = `${awayStats.fgm}/${awayStats.fga}`;
  document.getElementById('box-total-3p-away').textContent = `${awayStats['3pm']}/${awayStats['3pa']}`;
  document.getElementById('box-total-ft-away').textContent = `${awayStats.ftm}/${awayStats.fta}`;
});
</script>
{% endblock %}