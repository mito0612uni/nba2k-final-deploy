{% extends "layout.html" %}
{% block content %}
<style>
    /* --- ç®¡ç†ç”»é¢å…±é€šã‚¹ã‚¿ã‚¤ãƒ« --- */
    body { background-color: #f4f6f9; }
    .admin-container { max-width: 1000px; margin: 40px auto; padding: 0 15px; }
    
    .page-header {
        display: flex; align-items: center; justify-content: space-between;
        margin-bottom: 30px; border-bottom: 2px solid #e9ecef; padding-bottom: 15px;
    }
    .page-header h2 { margin: 0; color: #2c3e50; font-weight: 700; font-size: 1.8rem; }
    
    /* ã‚«ãƒ¼ãƒ‰ã‚¹ã‚¿ã‚¤ãƒ« */
    .admin-card {
        background: #ffffff; border-radius: 12px; border: none;
        box-shadow: 0 5px 15px rgba(0,0,0,0.05); margin-bottom: 25px; overflow: hidden;
    }
    .card-header {
        background: #fff; border-bottom: 1px solid #f0f0f0; padding: 20px 25px;
        font-weight: 700; color: #34495e; font-size: 1.1rem;
    }
    .card-body { padding: 25px; }

    /* ãƒ•ã‚©ãƒ¼ãƒ è¦ç´  */
    .form-group label { font-weight: 600; color: #555; margin-bottom: 8px; display: block; font-size: 0.9rem; }
    .form-control {
        border-radius: 8px; border: 1px solid #ddd; padding: 10px; font-size: 1rem; width: 100%;
        background-color: #fdfdfd; transition: border-color 0.2s;
    }
    .form-control:focus { border-color: #28a745; box-shadow: 0 0 0 3px rgba(40,167,69,0.1); }
    
    .btn-create {
        background: linear-gradient(135deg, #28a745 0%, #218838 100%); color: white;
        border: none; padding: 12px 30px; border-radius: 30px; font-weight: bold; cursor: pointer;
        box-shadow: 0 4px 10px rgba(40,167,69,0.3); transition: transform 0.2s; margin-top: 15px;
    }
    .btn-create:hover { transform: translateY(-2px); box-shadow: 0 6px 15px rgba(40,167,69,0.4); }

    /* ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒˆã‚«ãƒ¼ãƒ‰ */
    .event-card {
        background: #fff; border-radius: 10px; padding: 20px;
        border: 1px solid #eee; margin-bottom: 15px; position: relative;
        transition: box-shadow 0.2s;
    }
    .event-card:hover { box-shadow: 0 5px 15px rgba(0,0,0,0.08); }
    
    /* ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ãƒ©ã‚¤ãƒ³ */
    .status-line {
        position: absolute; left: 0; top: 0; bottom: 0; width: 5px;
        border-radius: 10px 0 0 10px;
    }
    .status-open .status-line { background-color: #28a745; } /* ç·‘ */
    .status-closed .status-line { background-color: #dc3545; } /* èµ¤ */
    .status-published .status-line { background-color: #007bff; } /* é’ */

    .event-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px; flex-wrap: wrap; gap: 10px; }
    .event-title { font-size: 1.2rem; font-weight: bold; color: #333; margin: 0; }
    .event-type { background: #eee; color: #666; padding: 2px 8px; border-radius: 4px; font-size: 0.8rem; margin-left: 10px; }
    
    .status-badge {
        font-size: 0.85rem; font-weight: bold; padding: 5px 12px; border-radius: 20px;
    }
    .badge-open { background: #d4edda; color: #155724; }
    .badge-closed { background: #f8d7da; color: #721c24; }
    .badge-published { background: #cce5ff; color: #004085; }

    .action-buttons { display: flex; gap: 10px; margin-top: 15px; align-items: center; flex-wrap: wrap; }
    .btn-action {
        padding: 8px 16px; border-radius: 6px; font-size: 0.9rem; font-weight: 600;
        border: none; cursor: pointer; text-decoration: none; display: inline-block; color: white;
    }
    .btn-toggle { background-color: #6c757d; }
    .btn-review { background-color: #17a2b8; }
    .btn-delete { background-color: #fff; color: #dc3545; border: 1px solid #dc3545; }
    .btn-delete:hover { background-color: #dc3545; color: white; }
    
    .btn-archive { background-color: #ffc107; color: #333; }
    .btn-restore { background-color: #17a2b8; }

    /* è©³ç´°ã‚¢ã‚³ãƒ¼ãƒ‡ã‚£ã‚ªãƒ³ */
    details summary {
        cursor: pointer; color: #007bff; font-weight: 500; font-size: 0.9rem; margin-top: 15px; outline: none;
    }
    .votes-detail-box {
        background: #f8f9fa; padding: 15px; margin-top: 10px; border-radius: 8px;
        border: 1px solid #eee; max-height: 200px; overflow-y: auto; font-size: 0.9rem;
    }
    .vote-user-row { padding: 5px 0; border-bottom: 1px solid #eee; }
    .vote-user-row:last-child { border-bottom: none; }
    
    .date-range-info {
        font-size: 0.85em; color: #666; margin-top: 5px; display: block;
    }
</style>

<div class="admin-container">
    <div class="page-header">
        <h2><span style="color:#28a745; margin-right:10px;">ğŸ—³ï¸</span>æŠ•ç¥¨ç®¡ç†</h2>
    </div>
    
    <div class="admin-card">
        <div class="card-header">æ–°è¦ã‚¤ãƒ™ãƒ³ãƒˆä½œæˆ</div>
        <div class="card-body">
            <form method="post">
                <input type="hidden" name="action" value="create">
                
                <div style="display: flex; gap: 20px; flex-wrap: wrap; margin-bottom: 15px;">
                    <div style="flex: 2; min-width: 250px;" class="form-group">
                        <label>ã‚¤ãƒ™ãƒ³ãƒˆå</label>
                        <input type="text" name="title" class="form-control" placeholder="ä¾‹: ç¬¬1é€± é€±é–“MVPæŠ•ç¥¨" required>
                    </div>
                    
                    <div style="flex: 1; min-width: 150px;" class="form-group">
                        <label>ã‚¿ã‚¤ãƒ—</label>
                        <select name="vote_type" class="form-control" id="voteTypeSelect" onchange="toggleDateInputs()">
                            <option value="weekly">é€±é–“MVP</option>
                            <option value="all_star">ã‚ªãƒ¼ãƒ«ã‚¹ã‚¿ãƒ¼</option>
                            <option value="awards">ã‚·ãƒ¼ã‚ºãƒ³ã‚¢ãƒ¯ãƒ¼ãƒ‰</option>
                        </select>
                    </div>
                </div>

                <div id="dateInputs" style="display: flex; gap: 20px; flex-wrap: wrap; margin-bottom: 15px; background: #f9f9f9; padding: 15px; border-radius: 8px;">
                    <div style="flex: 1;" class="form-group">
                        <label>é›†è¨ˆé–‹å§‹æ—¥ <small>(é€±é–“MVPã®å¯¾è±¡æœŸé–“)</small></label>
                        <input type="date" name="start_date" class="form-control">
                    </div>
                    <div style="flex: 1;" class="form-group">
                        <label>é›†è¨ˆçµ‚äº†æ—¥</label>
                        <input type="date" name="end_date" class="form-control">
                    </div>
                </div>
                
                <div class="form-group">
                    <label>èª¬æ˜ (ä»»æ„)</label>
                    <input type="text" name="description" class="form-control" placeholder="ãƒ¦ãƒ¼ã‚¶ãƒ¼å‘ã‘ã®èª¬æ˜æ–‡...">
                </div>
                
                <div style="text-align: right;">
                    <button type="submit" class="btn-create">ä½œæˆã™ã‚‹</button>
                </div>
            </form>
        </div>
    </div>

    <h3 style="color: #2c3e50; font-size: 1.3rem; margin-bottom: 15px; padding-left: 5px; border-left: 4px solid #28a745;">
        ã‚¤ãƒ™ãƒ³ãƒˆä¸€è¦§ <small style="font-weight: normal; font-size: 0.8em; color: #666;">(ç¾åœ¨ã®ã‚·ãƒ¼ã‚ºãƒ³)</small>
    </h3>
    
    {% for config in configs %}
        {% set status_class = 'status-published' if config.is_published else ('status-open' if config.is_open else 'status-closed') %}
        
        <div class="event-card {{ status_class }}">
            <div class="status-line"></div>
            
            <div class="event-header">
                <div>
                    <h4 class="event-title">
                        {{ config.title }}
                        <span class="event-type">{{ config.vote_type }}</span>
                    </h4>
                    <div style="color:#888; font-size: 0.85em; margin-top: 5px;">
                        ä½œæˆæ—¥: {{ config.created_at.strftime('%Y/%m/%d') }}
                        {% if config.start_date and config.end_date %}
                            | <span style="color: #d63384; font-weight: bold;">å¯¾è±¡æœŸé–“: {{ config.start_date }} ã€œ {{ config.end_date }}</span>
                        {% endif %}
                    </div>
                </div>
                
                <div>
                    {% if config.is_published %}
                        <span class="status-badge badge-published">å…¬é–‹æ¸ˆã¿</span>
                    {% elif config.is_open %}
                        <span class="status-badge badge-open">å—ä»˜ä¸­</span>
                    {% else %}
                        <span class="status-badge badge-closed">å—ä»˜åœæ­¢ä¸­</span>
                    {% endif %}
                </div>
            </div>
            
            <div class="action-buttons">
                {% if not config.is_published %}
                    <form method="post">
                        <input type="hidden" name="action" value="toggle_status">
                        <input type="hidden" name="config_id" value="{{ config.id }}">
                        <button type="submit" class="btn-action btn-toggle" style="background-color: {% if config.is_open %}#6c757d{% else %}#28a745{% endif %};">
                            {% if config.is_open %}â›” å—ä»˜ã‚’åœæ­¢{% else %}â–¶ å—ä»˜ã‚’é–‹å§‹{% endif %}
                        </button>
                    </form>
                    
                    <form method="post">
                        <input type="hidden" name="action" value="calculate_review">
                        <input type="hidden" name="config_id" value="{{ config.id }}">
                        <button type="submit" class="btn-action btn-review">ğŸ“Š é›†è¨ˆãƒ»ãƒ¬ãƒ“ãƒ¥ãƒ¼</button>
                    </form>
                {% else %}
                    <a href="{{ url_for('admin_vote_review', config_id=config.id) }}" class="btn-action btn-review">ğŸ“ˆ çµæœã‚’ç¢ºèª</a>
                    
                    {% if config.show_on_home %}
                        <form method="post" style="display:inline;">
                            <input type="hidden" name="action" value="hide_from_home">
                            <input type="hidden" name="config_id" value="{{ config.id }}">
                            <button type="submit" class="btn-action btn-archive">ğŸ™ˆ ãƒˆãƒƒãƒ—ã‹ã‚‰éš ã™</button>
                        </form>
                    {% else %}
                        <form method="post" style="display:inline;">
                            <input type="hidden" name="action" value="show_on_home">
                            <input type="hidden" name="config_id" value="{{ config.id }}">
                            <button type="submit" class="btn-action btn-restore">ğŸ‘ï¸ ãƒˆãƒƒãƒ—ã«è¡¨ç¤º</button>
                        </form>
                        <span style="font-size:0.8em; color:#999;">(ã‚¢ãƒ¼ã‚«ã‚¤ãƒ–ä¸­)</span>
                    {% endif %}
                {% endif %}
                
                <form method="post" onsubmit="return confirm('æœ¬å½“ã«å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ\nã“ã‚Œã‚’è¡Œã†ã¨ã€é¸æ‰‹ã®å—è³æ­´ã‹ã‚‰ã‚‚ãƒ‡ãƒ¼ã‚¿ãŒæ¶ˆãˆã¾ã™ã€‚\nï¼ˆãƒˆãƒƒãƒ—ã‹ã‚‰æ¶ˆã™ã ã‘ãªã‚‰ã€Œéš ã™ã€ãƒœã‚¿ãƒ³ã‚’ä½¿ã£ã¦ãã ã•ã„ï¼‰');" style="margin-left: auto;">
                    <input type="hidden" name="action" value="delete">
                    <input type="hidden" name="config_id" value="{{ config.id }}">
                    <button type="submit" class="btn-action btn-delete">ğŸ—‘ï¸ å‰Šé™¤</button>
                </form>
            </div>
            
            <details>
                <summary>æŠ•ç¥¨çŠ¶æ³ã‚’è¦‹ã‚‹ ({{ votes_detail[config.id]|length }}å)</summary>
                <div class="votes-detail-box">
                    {% for username, votes in votes_detail[config.id].items() %}
                        <div class="vote-user-row">
                            <strong>{{ username }}</strong>: {{ votes|join(', ') }}
                        </div>
                    {% else %}
                        <p style="text-align:center; color:#999; margin:0;">ã¾ã æŠ•ç¥¨ã¯ã‚ã‚Šã¾ã›ã‚“ã€‚</p>
                    {% endfor %}
                </div>
            </details>
        </div>
    {% else %}
        <div style="padding: 40px; text-align: center; color: #999;">
            <p>ç¾åœ¨ã®ã‚·ãƒ¼ã‚ºãƒ³ã«æŠ•ç¥¨ã‚¤ãƒ™ãƒ³ãƒˆã¯ã‚ã‚Šã¾ã›ã‚“ã€‚</p>
        </div>
    {% endfor %}
</div>

<script>
    // é€±é–“MVPã®æ™‚ã ã‘æ—¥ä»˜å…¥åŠ›ã‚’è¡¨ç¤ºã™ã‚‹ç°¡æ˜“ãƒ­ã‚¸ãƒƒã‚¯
    function toggleDateInputs() {
        var type = document.getElementById('voteTypeSelect').value;
        var dateInputs = document.getElementById('dateInputs');
        if (type === 'weekly') {
            dateInputs.style.display = 'flex';
        } else {
            dateInputs.style.display = 'none';
        }
    }
    // åˆæœŸå®Ÿè¡Œ
    document.addEventListener('DOMContentLoaded', toggleDateInputs);
</script>
{% endblock %}