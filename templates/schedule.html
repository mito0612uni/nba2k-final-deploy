{% extends "layout.html" %}
{% block content %}
<style>
  /* 既存のスタイル */
  .schedule-container { max-width: 900px; margin: 0 auto; }
  .page-header { display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 15px; margin-bottom: 25px; }
  .page-header h2 { margin: 0; }
  .header-actions { display: flex; gap: 10px; }
  .header-actions .button { text-decoration: none; color: white; padding: 8px 15px; border-radius: 5px; font-size: 14px; border: none; cursor: pointer; }
  .button.primary { background-color: #004a99; } /* layout.htmlのCSSを継承 */
  .button.warning { background-color: #ffc107; color: black; }
  .button.danger { background-color: #dc3545; }
  .filter-form { background-color: #f8f9fa; padding: 15px; border-radius: 5px; margin-bottom: 25px; display: flex; flex-wrap: wrap; gap: 20px; align-items: center; }
  .filter-form select, .filter-form input[type="date"] { padding: 5px 8px; border-radius: 4px; border: 1px solid #ddd; font-size: 14px; }
  .clear-date-btn { margin-left: 5px; text-decoration: none; color: #004a99; font-size: 14px; font-weight: bold; }
  .game-card { background-color: #ffffff; border: 1px solid #e0e0e0; border-radius: 8px; margin-bottom: 15px; box-shadow: 0 2px 4px rgba(0,0,0,0.05); overflow: hidden; }
  .game-card-header { display: flex; justify-content: space-between; align-items: center; background-color: #f9f9f9; padding: 10px 15px; border-bottom: 1px solid #eee; font-size: 14px; }
  .game-date { font-weight: bold; }
  .game-password { font-weight: bold; color: #dc3545; }
  .game-card-body { display: flex; align-items: center; padding: 20px 15px; gap: 10px; }
  .team-info { flex: 1; display: flex; align-items: center; /* ★★★ 修正1: flex-directionをcolumnにするため削除 ★★★ */ position: relative; } 
  .team-info.home { justify-content: flex-end; flex-direction: column; } /* ★★★ 修正2: Homeは右寄せ、縦並び ★★★ */
  .team-info.away { justify-content: flex-start; flex-direction: column; } /* ★★★ 修正3: Awayは左寄せ、縦並び ★★★ */
  
  /* ★★★ 修正4: ロゴと名前のコンテナを修正 ★★★ */
  .team-name-container { display: flex; align-items: center; }
  .team-info.home .team-name-container { flex-direction: row-reverse; } /* Homeは名前の左にロゴ */
  .team-info.away .team-name-container { flex-direction: row; } /* Awayは名前の右にロゴ */

  .team-info img { height: 25px; width: 25px; object-fit: contain; }
  .team-info.home img { margin-left: 10px; margin-right: 0; } /* 調整 */
  .team-info.away img { margin-right: 10px; margin-left: 0; } /* 調整 */
  
  .team-name { font-size: 1.1em; font-weight: bold; }
  .team-name a { color: inherit; text-decoration: none; }
  .team-name a:hover { color: #004a99; }
  .team-label { font-size: 0.8em; color: #777; }
  
  /* ★★★ 修正5: 動画再生アイコンのスタイル ★★★ */
  .video-play-link {
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 5px;
    margin-top: 5px; /* ロゴと名前の下に少しスペース */
    font-size: 12px;
    font-weight: bold;
    color: #dc3545; /* YouTubeっぽい赤 */
    text-decoration: none;
  }
  .video-play-link:hover {
    text-decoration: underline;
  }
  .video-play-link::before {
    content: "▶"; /* 再生アイコン */
    font-size: 16px;
    line-height: 1;
  }
  /* ここまで動画再生アイコンのスタイル */

  .score-info { flex: 0 0 160px; text-align: center; font-size: 1.4em; font-weight: bold; }
  .score-info a { color: inherit; text-decoration: none; }
  .score-info a:hover { color: #004a99; }
  .forfeit-win { color: #dc3545; }
  .forfeit-lose { color: #333; font-style: italic; font-weight: normal; }
  .score-winner { color: #dc3545; }
  .score-loser { color: #555; }
  .vs-text { color: #888; font-size: 1.1em; }
  .game-card-footer { display: flex; justify-content: flex-end; align-items: center; gap: 15px; background-color: #f9f9f9; padding: 10px 15px; border-top: 1px solid #eee; font-size: 14px; }
  .game-card-footer a, .game-card-footer button { text-decoration: none; color: #004a99; font-weight: bold; }
  .game-card-footer button.delete-btn { background: none; border: none; color: #dc3545; cursor: pointer; padding: 0; font-size: 14px; font-weight: bold; }
  .game-card-footer button.swap-btn { background: none; border: none; color: #ffc107; cursor: pointer; padding: 0; font-size: 14px; font-weight: bold; }
  .date-update-form { padding: 15px; justify-content: center; }
  .date-update-form form { display: flex; flex-wrap: wrap; gap: 10px; width: 100%; align-items: center; justify-content: center; }
  .date-update-form label { font-weight: bold; font-size: 14px; margin: 0; }
  .date-update-form input[type="date"], .date-update-form input[type="time"] { padding: 5px; border: 1px solid #ccc; border-radius: 4px; }
  .date-update-form button { background-color: #004a99; color: white; padding: 5px 10px; border: none; border-radius: 4px; cursor: pointer; }
  @media (max-width: 600px) {
    .game-card-body { flex-direction: column; gap: 15px; }
    .team-info.home { justify-content: center; }
    .team-info.away { justify-content: center; }
    .score-info { flex-basis: auto; order: 1; }
    .team-info.home { order: 0; }
    .team-info.away { order: 2; }
    .game-card-footer { flex-direction: column; align-items: stretch; gap: 10px; }
    .game-card-footer a, .game-card-footer button.delete-btn, .game-card-footer button.swap-btn { text-align: center; padding: 8px; border-radius: 4px; background-color: #e9ecef; }
    .game-card-footer button.delete-btn { color: #dc3545; }
    .game-card-footer button.swap-btn { color: #ff8000; } 
    .game-card-footer a { color: #004a99; }
    .date-update-form form { flex-direction: column; align-items: stretch; }
  }
</style>

<div class="schedule-container">
  
  <div class="page-header">
    <h2>試合日程・結果</h2>
    {% if current_user.is_authenticated and current_user.is_admin %}
      <div class="header-actions">
        <a href="{{ url_for('auto_schedule') }}" class="button warning">自動作成</a>
        <a href="{{ url_for('add_schedule') }}" class="button primary">新しい日程を追加</a>
        <form action="{{ url_for('delete_all_schedules') }}" method="post" style="margin: 0;">
          <button type="button" class="button danger" onclick="confirmDelete(event, 'all')">全日程を削除</button>
        </form>
      </div>
    {% endif %}
  </div>

  <form method="get" action="{{ url_for('schedule') }}" class="filter-form">
    <div>
      <label for="team-select">チームで絞り込み:</label>
      <select name="team_id" id="team-select" onchange="this.form.submit()">
        <option value="">全チーム</option>
        {% for team in all_teams %}
          <option value="{{ team.id }}" {% if team.id == selected_team_id %}selected{% endif %}>{{ team.name }}</option>
        {% endfor %}
      </select>
    </div>
    <div>
      <label for="date-select">日付で絞り込み:</label>
      <input type="date" name="selected_date" id="date-select" value="{{ selected_date }}" onchange="this.form.submit()">
      {% if selected_date %}
        <a href="{{ url_for('schedule', team_id=selected_team_id) }}" class="clear-date-btn">(クリア)</a>
      {% endif %}
    </div>
  </form>
  
  {% if games %}
    {% for game in games %}
    <div class="game-card">
      <div class="game-card-header">
        <div class="game-date">{{ game.game_date }} {% if game.start_time %}{{ game.start_time }}{% endif %}</div>
        {% if game.game_password %}<div class="game-password">パスワード: {{ game.game_password }}</div>{% endif %}
      </div>
      <div class="game-card-body">
        
        <div class="team-info home">
          <div class="team-name-container">
            <span class="team-name">
              <a href="{{ url_for('team_detail', team_id=game.home_team.id) }}">{{ game.home_team.name }}</a>
            </span>
            {% if game.home_team.logo_image %}<img src="{{ game.home_team.logo_image }}" alt="">{% endif %}
            <span class="team-label">(Home)</span>
          </div>
          {% if game.youtube_url_home %}
            <a href="{{ game.youtube_url_home }}" target="_blank" title="{{ game.home_team.name }}視点" class="video-play-link">動画H</a>
          {% endif %}
        </div>
        
        <div class="score-info">
          {% if game.is_finished %}
            <a href="{{ url_for('game_result', game_id=game.id) }}">
              {% if game.winner_id is not none %}{% if game.winner_id == game.home_team.id %}<span class="forfeit-win">(不戦勝)</span> - <span class="forfeit-lose">(不戦敗)</span>{% else %}<span class="forfeit-lose">(不戦敗)</span> - <span class="forfeit-win">(不戦勝)</span>{% endif %}
              {% else %}{% if game.home_score > game.away_score %}<span class="score-winner">{{ game.home_score }}</span> - <span class="score-loser">{{ game.away_score }}</span>{% elif game.away_score > game.home_score %}<span class="score-loser">{{ game.home_score }}</span> - <span class="score-winner">{{ game.away_score }}</span>{% else %}<span>{{ game.home_score }}</span> - <span>{{ game.away_score }}</span>{% endif %}{% endif %}
            </a>
          {% else %}<span class="vs-text">vs</span>{% endif %}
        </div>
        
        <div class="team-info away">
          <div class="team-name-container">
            <span class="team-label">(Away)</span> 
            <span class="team-name">
              <a href="{{ url_for('team_detail', team_id=game.away_team.id) }}">{{ game.away_team.name }}</a>
            </span>
            {% if game.away_team.logo_image %}<img src="{{ game.away_team.logo_image }}" alt="">{% endif %}
          </div>
          {% if game.youtube_url_away %}
            <a href="{{ game.youtube_url_away }}" target="_blank" title="{{ game.away_team.name }}視点" class="video-play-link">動画A</a>
          {% endif %}
        </div>
        
      </div>

      <div class="game-card-footer">
        {% if game.is_finished %}
          <a href="{{ url_for('game_result', game_id=game.id) }}">結果を見る</a>
        {% elif current_user.is_authenticated %}
          <a href="{{ url_for('edit_game', game_id=game.id) }}">結果入力</a>
        {% endif %}
        
        {% if current_user.is_authenticated and current_user.is_admin %}
          
          <form action="{{ url_for('swap_teams', game_id=game.id) }}" method="post" style="display: inline; margin: 0;">
            <button type="submit" class="swap-btn" title="ホームとアウェイを入れ替え">[H/A入替]</button>
          </form>
          
          <button type="button" class="swap-btn" style="color: #17a2b8;" onclick="toggleDateForm({{ game.id }})">[日程変更]</button>
          
          <form action="{{ url_for('delete_game', game_id=game.id) }}" method="post" style="display: inline; margin: 0;">
            <button type="button" class="delete-btn" onclick="confirmDelete(event, 'single')">[削除]</button>
          </form>
        {% endif %}
      </div>
      
      {% if current_user.is_authenticated and current_user.is_admin %}
      <div class="game-card-footer date-update-form" id="date-form-{{ game.id }}" style="display: none; background-color: #fdfdfd; border-top: 1px dashed #ccc;">
        <form action="{{ url_for('update_game_date', game_id=game.id) }}" method="post">
            <label for="new-date-{{ game.id }}">新しい日付:</label>
            <input type="date" id="new-date-{{ game.id }}" name="new_game_date" value="{{ game.game_date }}" required>
            <label for="new-time-{{ game.id }}">新しい時間:</label>
            <input type="time" id="new-time-{{ game.id }}" name="new_game_time" value="{{ game.start_time }}" required>
            <button type="submit">保存</button>
        </form>
      </div>
      {% endif %}

    </div>
    {% endfor %}
  {% else %}
    {% if selected_date %}<p><strong>{{ selected_date }}</strong> に該当する試合はありません。</p>
    {% else %}<p>該当する試合はありません。</p>{% endif %}
  {% endif %}
</div>
{% endblock %}


{% block scripts %}
<script>
function toggleDateForm(gameId) {
    document.querySelectorAll('.date-update-form').forEach(form => {
      if (form.id !== `date-form-${gameId}`) {
        form.style.display = 'none';
      }
    });
    const targetForm = document.getElementById(`date-form-${gameId}`);
    if (targetForm) {
        targetForm.style.display = targetForm.style.display === 'none' ? 'flex' : 'none';
    }
}

function confirmDelete(event, type) {
    let message;
    if (type === 'all') {
        message = "警告：本当に全ての日程と試合結果を削除しますか？\nこの操作は元に戻せません。\n\n削除を実行するには、パスワード「delete」を入力してください。";
    } else {
        message = "本当にこの日程を削除しますか？\n削除を実行するには、パスワード「delete」を入力してください。";
    }
    
    const password = prompt(message);
    
    if (password === 'delete') {
        const form = event.target.form;
        const input = document.createElement('input');
        input.type = 'hidden';
        input.name = 'password';
        input.value = 'delete';
        form.appendChild(input);
        form.submit();
    } else if (password !== null) {
        alert('パスワードが違います。削除はキャンセルされました。');
    }
}
</script>
{% endblock %}