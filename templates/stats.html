{% extends "layout.html" %}
{% block content %}
<style>
    /* --- スタッツページ専用スタイル --- */
    .stats-container {
        max-width: 1400px;
        margin: 30px auto;
        padding: 0 20px;
    }
    
    .stats-section {
        background: #fff;
        border-radius: 8px;
        box-shadow: 0 4px 10px rgba(0,0,0,0.05);
        padding: 20px;
        margin-bottom: 40px;
        border: 1px solid #eee;
    }

    h2 {
        color: #004a99;
        font-weight: 800;
        border-left: 5px solid #ffd700;
        padding-left: 15px;
        margin-bottom: 20px;
        font-size: 1.5rem;
    }

    /* ▼▼▼ 検索ボックスのスタイル (追加) ▼▼▼ */
    .search-wrapper {
        margin-bottom: 20px;
        position: relative;
        max-width: 400px;
    }
    .search-input {
        width: 100%;
        padding: 12px 15px 12px 40px; /* アイコン分の余白 */
        border: 1px solid #ddd;
        border-radius: 30px;
        font-size: 1rem;
        box-sizing: border-box;
        transition: all 0.3s;
        background-color: #fff;
    }
    .search-input:focus {
        border-color: #004a99;
        box-shadow: 0 0 0 3px rgba(0, 74, 153, 0.1);
        outline: none;
    }
    .search-icon {
        position: absolute;
        left: 15px;
        top: 50%;
        transform: translateY(-50%);
        color: #aaa;
    }

    /* ▼▼▼ テーブルのスクロール対応 ▼▼▼ */
    .table-responsive {
        overflow-x: auto;
        -webkit-overflow-scrolling: touch;
        margin-bottom: 10px;
        border: 1px solid #ddd;
        border-radius: 4px;
        max-height: 800px;
        overflow-y: auto;
    }

    .stats-table {
        width: 100%;
        border-collapse: separate;
        border-spacing: 0;
        font-size: 0.9rem;
        white-space: nowrap;
    }

    .stats-table th, .stats-table td {
        padding: 12px 15px;
        border-bottom: 1px solid #eee;
        border-right: 1px solid #f0f0f0;
        text-align: center;
    }

    /* ヘッダー固定 & ソート用スタイル */
    .stats-table th {
        background: #343a40;
        color: #fff;
        font-weight: bold;
        position: sticky;
        top: 0;
        z-index: 10;
        border-right-color: #555;
        cursor: pointer;
        user-select: none;
        transition: background-color 0.2s;
    }

    .stats-table th:hover { background-color: #495057; }

    /* ソートアイコン */
    .stats-table th::after {
        content: ' ⇅'; opacity: 0.3; margin-left: 5px; font-size: 0.8em; font-weight: normal;
    }
    .stats-table th.asc::after { content: ' ▲'; opacity: 1; color: #ffd700; }
    .stats-table th.desc::after { content: ' ▼'; opacity: 1; color: #ffd700; }

    /* 左端カラム固定 */
    .stats-table th:first-child,
    .stats-table td:first-child {
        position: sticky; left: 0; z-index: 11;
        border-right: 2px solid #ddd; text-align: left; min-width: 160px;
    }
    .stats-table th:first-child { background: #343a40; z-index: 20; }
    .stats-table td:first-child { background: #fff; font-weight: bold; color: #004a99; }

    /* 縞模様 */
    .stats-table tbody tr:nth-child(even) td { background-color: #f8f9fa; }
    .stats-table tbody tr:nth-child(even) td:first-child { background-color: #f8f9fa; }
    
    /* ホバー効果 */
    .stats-table tbody tr:hover td { background-color: #e9ecef; }
    .stats-table tbody tr:hover td:first-child { background-color: #e9ecef; }

    .stats-table a { text-decoration: none; color: inherit; }
    .stats-table a:hover { text-decoration: underline; color: #0056b3; }

    .val-main { font-weight: bold; color: #222; font-size: 1rem; }
    .val-sub { color: #666; font-size: 0.85rem; }
    .val-pct { color: #007bff; font-weight: bold; }
    
    .mini-logo {
        height: 24px; width: 24px; object-fit: contain;
        vertical-align: middle; margin-right: 5px;
        background: #fff; border-radius: 50%; border: 1px solid #eee;
    }
</style>

<div class="stats-container">
    
    <div class="search-wrapper">
        <i class="fa-solid fa-magnifying-glass search-icon"></i>
        <input type="text" id="statsSearch" class="search-input" placeholder="選手名やチーム名で検索...">
    </div>

    <div class="stats-section">
        <h2>チーム成績 (平均)</h2>
        <div class="table-responsive">
            <table class="stats-table" id="teamTable">
                <thead>
                    <tr>
                        <th>チーム名</th>
                        <th>リーグ</th>
                        <th>勝</th><th>敗</th><th>勝点</th>
                        <th>平均得点</th><th>平均失点</th><th>得失差</th>
                        <th>AST</th><th>REB</th><th>STL</th><th>BLK</th>
                        <th>TO</th><th>FOUL</th>
                        <th>FG%</th><th>3P%</th><th>FT%</th>
                    </tr>
                </thead>
                <tbody>
                    {% for row in team_stats %}
                    <tr>
                        <td data-value="{{ row.team_name }}">
                            {% if row.team.logo_image %}
                            <img src="{{ row.team.logo_image }}" class="mini-logo">
                            {% endif %}
                            <a href="{{ url_for('team_detail', team_id=row.team.id) }}">{{ row.team_name }}</a>
                        </td>
                        <td>
                            <span style="font-size:0.8em; padding:2px 6px; border-radius:4px; 
                                background:{% if row.league=='Aリーグ' %}#ffebee;color:#c62828{% else %}#e3f2fd;color:#1565c0{% endif %}">
                                {{ row.league }}
                            </span>
                        </td>
                        <td>{{ row.wins }}</td>
                        <td>{{ row.losses }}</td>
                        <td style="font-weight:bold;">{{ row.points }}</td>
                        
                        <td class="val-main">{{ "%.1f"|format(row.avg_pf) }}</td>
                        <td>{{ "%.1f"|format(row.avg_pa) }}</td>
                        <td style="color:{% if row.diff > 0 %}green{% elif row.diff < 0 %}red{% endif %};">{{ row.diff }}</td>
                        
                        <td>{{ "%.1f"|format(row.avg_ast) }}</td>
                        <td>{{ "%.1f"|format(row.avg_reb) }}</td>
                        <td>{{ "%.1f"|format(row.avg_stl) }}</td>
                        <td>{{ "%.1f"|format(row.avg_blk) }}</td>
                        <td>{{ "%.1f"|format(row.avg_turnover) }}</td>
                        <td>{{ "%.1f"|format(row.avg_foul) }}</td>
                        
                        <td class="val-pct">{{ "%.1f"|format(row.fg_pct) }}%</td>
                        <td class="val-pct">{{ "%.1f"|format(row.three_p_pct) }}%</td>
                        <td class="val-pct">{{ "%.1f"|format(row.ft_pct) }}%</td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>

    <div class="stats-section">
        <h2>個人成績 (平均)</h2>
        <div class="table-responsive">
            <table class="stats-table" id="playerTable">
                <thead>
                    <tr>
                        <th>選手名</th>
                        <th>チーム</th>
                        <th>試合</th>
                        <th>PTS</th><th>REB</th><th>AST</th><th>STL</th><th>BLK</th>
                        <th>TO</th><th>FOUL</th>
                        <th>FGM</th><th>FGA</th><th>FG%</th>
                        <th>3PM</th><th>3PA</th><th>3P%</th>
                        <th>FTM</th><th>FTA</th><th>FT%</th>
                    </tr>
                </thead>
                <tbody>
                    {% for row in individual_stats %}
                    <tr>
                        <td data-value="{{ row.player_name }}"><a href="{{ url_for('player_detail', player_id=row.player_id) }}">{{ row.player_name }}</a></td>
                        <td style="text-align:left; font-size:0.9em;" data-value="{{ row.team_name }}">{{ row.team_name }}</td>
                        <td>{{ row.games_played }}</td>
                        
                        <td class="val-main">{{ "%.1f"|format(row.avg_pts) }}</td>
                        <td>{{ "%.1f"|format(row.avg_reb) }}</td>
                        <td>{{ "%.1f"|format(row.avg_ast) }}</td>
                        <td>{{ "%.1f"|format(row.avg_stl) }}</td>
                        <td>{{ "%.1f"|format(row.avg_blk) }}</td>
                        
                        <td>{{ "%.1f"|format(row.avg_turnover) }}</td>
                        <td>{{ "%.1f"|format(row.avg_foul) }}</td>
                        
                        <td class="val-sub">{{ "%.1f"|format(row.avg_fgm) }}</td>
                        <td class="val-sub">{{ "%.1f"|format(row.avg_fga) }}</td>
                        <td class="val-pct">{{ "%.1f"|format(row.fg_pct) }}%</td>
                        
                        <td class="val-sub">{{ "%.1f"|format(row.avg_three_pm) }}</td>
                        <td class="val-sub">{{ "%.1f"|format(row.avg_three_pa) }}</td>
                        <td class="val-pct">{{ "%.1f"|format(row.three_p_pct) }}%</td>
                        
                        <td class="val-sub">{{ "%.1f"|format(row.avg_ftm) }}</td>
                        <td class="val-sub">{{ "%.1f"|format(row.avg_fta) }}</td>
                        <td class="val-pct">{{ "%.1f"|format(row.ft_pct) }}%</td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>

</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    
    // --- 1. 検索機能 ---
    const searchInput = document.getElementById('statsSearch');
    
    searchInput.addEventListener('keyup', function() {
        const searchText = this.value.toLowerCase();
        // 対象となるすべての行を取得 (チーム成績、個人成績の両方)
        const allRows = document.querySelectorAll('.stats-table tbody tr');

        allRows.forEach(row => {
            const rowText = row.textContent.toLowerCase();
            if (rowText.includes(searchText)) {
                row.style.display = '';
            } else {
                row.style.display = 'none';
            }
        });
    });

    // --- 2. ソート機能 ---
    const getCellValue = (tr, idx) => {
        const td = tr.children[idx];
        return td.getAttribute('data-value') || td.textContent || td.innerText;
    };

    const comparer = (idx, asc) => (a, b) => {
        const v1 = getCellValue(asc ? a : b, idx);
        const v2 = getCellValue(asc ? b : a, idx);
        
        const n1 = parseFloat(v1.replace(/[^\d.-]/g, ''));
        const n2 = parseFloat(v2.replace(/[^\d.-]/g, ''));

        if (!isNaN(n1) && !isNaN(n2)) {
            return n1 - n2;
        }
        return v1.toString().localeCompare(v2, 'ja');
    };

    document.querySelectorAll('.stats-table th').forEach(th => {
        th.addEventListener('click', (() => {
            const table = th.closest('table');
            const tbody = table.querySelector('tbody');
            if (!tbody || tbody.querySelectorAll('tr').length === 0) return;

            const elementIndex = Array.from(th.parentNode.children).indexOf(th);
            const isAsc = th.classList.contains('asc');
            
            table.querySelectorAll('th').forEach(h => h.classList.remove('asc', 'desc'));
            
            if (isAsc) {
                th.classList.remove('asc'); th.classList.add('desc');
            } else {
                th.classList.add('asc'); th.classList.remove('desc');
            }

            Array.from(tbody.querySelectorAll('tr'))
                .sort(comparer(elementIndex, !isAsc))
                .forEach(tr => tbody.appendChild(tr));
        }));
    });
});
</script>
{% endblock %}