{% extends "layout.html" %}
{% block content %}
<style>
  /* ページ全体のコンテナ */
  .schedule-container {
    max-width: 900px;
    margin: 0 auto;
  }

  /* ページヘッダー（タイトルとボタン） */
  .page-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    flex-wrap: wrap; /* スマホ表示でも改行されるように */
    gap: 15px;
    margin-bottom: 25px;
  }
  .page-header h2 {
    margin: 0;
  }
  .header-actions {
    display: flex;
    gap: 10px;
  }
  .header-actions .button {
    text-decoration: none;
    color: white;
    padding: 8px 15px;
    border-radius: 5px;
    font-size: 14px;
    border: none;
    cursor: pointer;
  }
  .button.primary { background-color: #007bff; }
  .button.warning { background-color: #ffc107; color: black; }
  .button.danger { background-color: #dc3545; }

  /* 絞り込みフォーム */
  .filter-form {
    background-color: #f8f9fa;
    padding: 15px;
    border-radius: 5px;
    margin-bottom: 25px;
    display: flex;
    flex-wrap: wrap;
    gap: 20px;
    align-items: center;
  }
  .filter-form select,
  .filter-form input[type="date"] {
    padding: 5px 8px;
    border-radius: 4px;
    border: 1px solid #ddd;
    font-size: 14px; /* フォントサイズを揃える */
  }
  .clear-date-btn {
    margin-left: 5px; 
    text-decoration: none; 
    color: #007bff; 
    font-size: 14px;
    font-weight: bold;
  }


  /* 試合カード */
  .game-card {
    background-color: #ffffff;
    border: 1px solid #e0e0e0;
    border-radius: 8px;
    margin-bottom: 15px;
    box-shadow: 0 2px 4px rgba(0,0,0,0.05);
    overflow: hidden; /* カードのデザインを保つ */
  }

  /* カード上部 (日付とパスワード) */
  .game-card-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    background-color: #f9f9f9;
    padding: 10px 15px;
    border-bottom: 1px solid #eee;
    font-size: 14px;
  }
  .game-date { font-weight: bold; }
  .game-password { font-weight: bold; color: #dc3545; }

  /* カード中央 (試合情報) */
  .game-card-body {
    display: flex;
    align-items: center;
    padding: 20px 15px;
    gap: 10px;
  }
  
  .team-info {
    flex: 1; /* スペースを均等に分ける */
    display: flex;
    align-items: center;
  }
  .team-info.home { justify-content: flex-end; /* 右寄せ */ }
  .team-info.away { justify-content: flex-start; /* 左寄せ */ }
  
  .team-info img {
    height: 25px;
    width: 25px;
    object-fit: contain; /* ロゴの比率を保つ */
  }
  .team-info.home img { margin-right: 10px; }
  .team-info.away img { margin-left: 10px; }
  
  .team-name { font-size: 1.1em; font-weight: bold; }
  .team-name a { color: inherit; text-decoration: none; }
  .team-name a:hover { color: #007bff; }
  .team-label { font-size: 0.8em; color: #777; }

  .score-info {
    flex: 0 0 160px; /* スコア部分は固定幅 */
    text-align: center;
    font-size: 1.4em;
    font-weight: bold;
  }
  .score-info a { color: inherit; text-decoration: none; }
  .score-info a:hover { color: #007bff; }
  
  .forfeit-win { color: #dc3545; }
  .forfeit-lose { color: #333; font-style: italic; font-weight: normal; }
  .score-winner { color: #dc3545; }
  .score-loser { color: #555; }
  .vs-text { color: #888; font-size: 1.1em; }


  /* カード下部 (ボタン) */
  .game-card-footer {
    display: flex;
    justify-content: flex-end; /* ボタンを右寄せ */
    align-items: center;
    gap: 15px;
    background-color: #f9f9f9;
    padding: 10px 15px;
    border-top: 1px solid #eee;
    font-size: 14px;
  }
  .game-card-footer a, .game-card-footer button {
    text-decoration: none;
    color: #007bff;
    font-weight: bold;
  }
  .game-card-footer button.delete-btn {
    background: none;
    border: none;
    color: #dc3545;
    cursor: pointer;
    padding: 0;
    font-size: 14px;
    font-weight: bold;
  }
  .game-card-footer button.swap-btn {
    background: none;
    border: none;
    color: #ffc107; /* 警告色 (黄色) */
    cursor: pointer;
    padding: 0;
    font-size: 14px;
    font-weight: bold;
  }
  
  /* ★★★ 修正箇所1: 日程変更フォームのスタイル ★★★ */
  .date-update-form {
    padding: 15px;
    justify-content: center;
  }
  .date-update-form form {
    display: flex; 
    gap: 10px; 
    width: 100%; 
    align-items: center;
    justify-content: center;
  }
  .date-update-form label {
    font-weight: bold; 
    font-size: 14px; 
    margin: 0;
  }
  .date-update-form input[type="date"] {
    padding: 5px; 
    border: 1px solid #ccc; 
    border-radius: 4px;
  }
  .date-update-form button {
    background-color: #007bff; 
    color: white; 
    padding: 5px 10px; 
    border: none; 
    border-radius: 4px; 
    cursor: pointer;
  }

  /* スマホ表示の調整 */
  @media (max-width: 600px) {
    .game-card-body {
      flex-direction: column; /* 縦並びにする */
      gap: 15px;
    }
    .team-info.home { justify-content: center; }
    .team-info.away { justify-content: center; }
    .score-info {
      flex-basis: auto; /* 幅を自動に */
      order: 1; /* アウェイチームを先に表示（vsの順序のため） */
    }
    .team-info.home { order: 0; }
    .team-info.away { order: 2; }
    
    .game-card-footer {
      flex-direction: column;
      align-items: stretch; /* ボタンを全幅に */
      gap: 10px;
    }
    .game-card-footer a, 
    .game-card-footer button.delete-btn,
    .game-card-footer button.swap-btn {
      text-align: center;
      padding: 8px;
      border-radius: 4px;
      background-color: #e9ecef;
    }
    /* スマホ時は色を保持する */
    .game-card-footer button.delete-btn { color: #dc3545; }
    .game-card-footer button.swap-btn { color: #ff8000; } 
    .game-card-footer a { color: #007bff; }
    
    .date-update-form form {
        flex-direction: column;
        align-items: stretch;
    }
  }

</style>

<div class="schedule-container">
  
  <div class="page-header">
    <h2>試合日程・結果</h2>
    {% if current_user.is_authenticated and current_user.is_admin %}
      <div class="header-actions">
        <a href="{{ url_for('auto_schedule') }}" class="button warning">自動作成</a>
        <a href="{{ url_for('add_schedule') }}" class="button primary">新しい日程を追加</a>
        <form action="{{ url_for('delete_all_schedules') }}" method="post" onsubmit="return confirm('警告：本当に全ての日程と試合結果を削除しますか？この操作は元に戻せません。');" style="margin: 0;">
          <button type="submit" class="button danger">全日程を削除</button>
        </form>
      </div>
    {% endif %}
  </div>

  <form method="get" action="{{ url_for('schedule') }}" class="filter-form">
    
    <div>
      <label for="team-select">チームで絞り込み:</label>
      <select name="team_id" id="team-select" onchange="this.form.submit()">
        <option value="">全チーム</option>
        {% for team in all_teams %}
          <option value="{{ team.id }}" {% if team.id == selected_team_id %}selected{% endif %}>{{ team.name }}</option>
        {% endfor %}
      </select>
    </div>
    
    <div>
      <label for="date-select">日付で絞り込み:</label>
      <input type="date" name="selected_date" id="date-select" 
             value="{{ selected_date }}" 
             onchange="this.form.submit()">
      
      {% if selected_date %}
        <a href="{{ url_for('schedule', team_id=selected_team_id) }}" class="clear-date-btn">
          (クリア)
        </a>
      {% endif %}
    </div>
    </form>
  {% if games %}
    {% for game in games %}
    <div class="game-card">
      <div class="game-card-header">
        <div class="game-date">
          {{ game.game_date }} 
          {% if game.start_time %}{{ game.start_time }}{% endif %}
        </div>
        {% if game.game_password %}
          <div class="game-password">
            パスワード: {{ game.game_password }}
          </div>
        {% endif %}
      </div>
      
      <div class="game-card-body">
        
        <div class="team-info home">
          {% if game.home_team.logo_image %}<img src="{{ game.home_team.logo_image }}" alt="">{% endif %}
          <span class="team-name">
            <a href="{{ url_for('team_detail', team_id=game.home_team.id) }}">
              {{ game.home_team.name }}
            </a>
            <span class="team-label">(Home)</span>
          </span>
        </div>

        <div class="score-info">
          {% if game.is_finished %}
            <a href="{{ url_for('game_result', game_id=game.id) }}">
              {% if game.winner_id is not none %}
                {% if game.winner_id == game.home_team.id %}
                  <span class="forfeit-win">(不戦勝)</span> - <span class="forfeit-lose">(不戦敗)</span>
                {% else %}
                  <span class="forfeit-lose">(不戦敗)</span> - <span class="forfeit-win">(不戦勝)</span>
                {% endif %}
              {% else %}
                {% if game.home_score > game.away_score %}
                  <span class="score-winner">{{ game.home_score }}</span> - <span class="score-loser">{{ game.away_score }}</span>
                {% elif game.away_score > game.home_score %}
                  <span class="score-loser">{{ game.home_score }}</span> - <span class="score-winner">{{ game.away_score }}</span>
                {% else %}
                  <span>{{ game.home_score }}</span> - <span>{{ game.away_score }}</span>
                {% endif %}
              {% endif %}
            </a>
          {% else %}
            <span class="vs-text">vs</span>
          {% endif %}
        </div>

        <div class="team-info away">
          <span class="team-name">
            <span class="team-label">(Away)</span> 
            <a href="{{ url_for('team_detail', team_id=game.away_team.id) }}">
              {{ game.away_team.name }}
            </a>
          </span>
          {% if game.away_team.logo_image %}<img src="{{ game.away_team.logo_image }}" alt="">{% endif %}
        </div>
      </div>

      <div class="game-card-footer">
        {% if game.youtube_url_home %}<a href="{{ game.youtube_url_home }}" target="_blank" title="{{ game.home_team.name }}視点">[動画 H]</a>{% endif %}
        {% if game.youtube_url_away %}<a href="{{ game.youtube_url_away }}" target="_blank" title="{{ game.away_team.name }}視点">[動画 A]</a>{% endif %}
        
        {% if game.is_finished %}
          <a href="{{ url_for('game_result', game_id=game.id) }}">結果を見る</a>
        {% elif current_user.is_authenticated and current_user.is_admin %}
          <a href="{{ url_for('edit_game', game_id=game.id) }}">結果入力</a>
        {% endif %}
        
        {% if current_user.is_authenticated and current_user.is_admin %}
          
          <form action="{{ url_for('swap_teams', game_id=game.id) }}" method="post" style="display: inline; margin: 0;">
            <button type="submit" class="swap-btn" title="ホームとアウェイを入れ替え">[H/A入替]</button>
          </form>
          
          <button type="button" class="swap-btn" style="color: #17a2b8;" onclick="toggleDateForm({{ game.id }})">[日程変更]</button>
          
          <form action="{{ url_for('delete_game', game_id=game.id) }}" method="post" onsubmit="return confirm('本当にこの日程を削除しますか？');" style="display: inline; margin: 0;">
            <button type="submit" class="delete-btn">[削除]</button>
          </form>
        {% endif %}
      </div>
      
      {% if current_user.is_authenticated and current_user.is_admin %}
      <div class="game-card-footer date-update-form" id="date-form-{{ game.id }}" style="display: none; background-color: #fdfdfd; border-top: 1px dashed #ccc;">
        <form action="{{ url_for('update_game_date', game_id=game.id) }}" method="post">
            <label for="new-date-{{ game.id }}">新しい日付:</label>
            <input type="date" id="new-date-{{ game.id }}" name="new_game_date" value="{{ game.game_date }}" required>
            <button type="submit">保存</button>
        </form>
      </div>
      {% endif %}

    </div>
    {% endfor %}
  {% else %}
    {% if selected_date %}
      <p><strong>{{ selected_date }}</strong> に該当する試合はありません。</p>
    {% else %}
      <p>該当する試合はありません。</p>
    {% endif %}
  {% endif %}
</div>
{% endblock %}

{% block scripts %}
<script>
function toggleDateForm(gameId) {
    // すべての隠しフォームを一旦非表示にする
    document.querySelectorAll('.date-update-form').forEach(form => {
      if (form.id !== `date-form-${gameId}`) {
        form.style.display = 'none';
      }
    });
    // 対象のフォームの表示/非表示を切り替える
    const targetForm = document.getElementById(`date-form-${gameId}`);
    if (targetForm) {
        targetForm.style.display = targetForm.style.display === 'none' ? 'flex' : 'none';
    }
}
</script>
{% endblock %}