{% extends "layout.html" %}

{% block content %}

{# ★★★ マクロ定義 (修正版) ★★★ #}
{% macro render_player_card(row, rank) %}
<div class="ranking-card">
    <div class="rank-number rank-{{ rank }}">{{ rank }}</div>
    
    {# 修正: 選手画像優先表示 #}
    {% if row.player.image_url %}
        <img src="{{ row.player.image_url }}" class="player-img" style="object-fit:cover;">
    {% elif row.team.logo_image %}
        <img src="{{ row.team.logo_image }}" class="player-img">
    {% else %}
        <div class="player-img" style="display:flex; align-items:center; justify-content:center; font-size:0.8em; background:#eee; color:#777;">No img</div>
    {% endif %}

    <div class="player-info">
        <div class="player-name">
            {# 修正: row.Player -> row.player #}
            <a href="{{ url_for('player_detail', player_id=row.player.id) }}" target="_blank">{{ row.player.name }}</a>
        </div>
        <span class="team-name">{{ row.team.name }}</span>
        
        <div class="stats-row">
            <span class="stat-item main-stat">{{ "%.1f"|format(row.avg_pts) }} <small>PTS</small></span>
            <span class="stat-item">{{ "%.1f"|format(row.avg_reb) }} REB</span>
            <span class="stat-item">{{ "%.1f"|format(row.avg_ast) }} AST</span>
            <span class="stat-item">{{ "%.1f"|format(row.avg_stl) }} STL</span>
            <span class="stat-item">{{ "%.1f"|format(row.avg_blk) }} BLK</span>
            <span class="stat-item">{{ "%.1f"|format(row.fg_pct) }}% FG</span>
            <span class="stat-item">{{ "%.1f"|format(row.three_pt_pct) }}% 3P</span>
        </div>

        <div style="display:flex; align-items:center; gap:10px; flex-wrap:wrap; margin-top:5px;">
            <div class="score-badge">
                IMP: {{ "%.1f"|format(row.score) }}
            </div>
            {# ★追加: 期間中のチーム勝敗表示 #}
            <div style="font-size:0.9em; font-weight:bold; color:#d63384; background:rgba(214, 51, 132, 0.1); padding:2px 8px; border-radius:4px;">
                期間戦績: {{ row.team_wins|default(0) }}勝 {{ row.team_losses|default(0) }}敗
            </div>
        </div>
    </div>
</div>
{% endmacro %}
{# ★★★ マクロ定義ここまで ★★★ #}

<style>
    .mvp-container { max-width: 1000px; margin: 0 auto; padding: 20px; }
    
    /* 期間指定フォーム */
    .date-range-form {
        background-color: #fff; padding: 25px; border-radius: 10px;
        box-shadow: 0 2px 5px rgba(0,0,0,0.05); margin-bottom: 40px;
        display: flex; flex-wrap: wrap; gap: 15px; align-items: end; justify-content: center;
        border: 1px solid #eee;
    }
    .form-group { display: flex; flex-direction: column; flex: 1; min-width: 150px; }
    .form-group label { font-weight: bold; font-size: 0.9em; color: #555; margin-bottom: 5px; }
    .form-group input, .form-group select { padding: 10px; border: 1px solid #ddd; border-radius: 5px; }
    .search-btn { background-color: #004a99; color: white; border: none; padding: 10px 25px; border-radius: 5px; cursor: pointer; font-weight: bold; margin-bottom: 2px;}
    .search-btn:hover { background-color: #003377; }

    /* 結果表示エリア */
    .results-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(350px, 1fr));
        gap: 30px;
    }
    .league-column h3 {
        text-align: center;
        background-color: #333;
        color: #fff;
        padding: 10px;
        border-radius: 8px;
        margin-bottom: 20px;
    }
    .league-column.league-a h3 { background-color: #c62828; }
    .league-column.league-b h3 { background-color: #1565c0; }

    /* 選手カード */
    .ranking-card {
        background-color: #fff; border-radius: 12px; overflow: hidden;
        box-shadow: 0 4px 8px rgba(0,0,0,0.05); margin-bottom: 15px;
        display: flex; align-items: center; padding: 15px;
        position: relative;
        transition: transform 0.2s;
        border: 1px solid #eee;
        border-left: 5px solid #333;
    }
    .ranking-card:hover { transform: translateY(-3px); box-shadow: 0 8px 16px rgba(0,0,0,0.1); }
    
    /* 順位バッジ */
    .rank-number {
        font-size: 2em; font-weight: 900; margin-right: 15px; width: 40px; text-align: center;
        color: #ccc;
    }
    .rank-1 { color: #FFD700; text-shadow: 1px 1px 0 #c5a000; }
    .rank-2 { color: #C0C0C0; text-shadow: 1px 1px 0 #a0a0a0; }
    .rank-3 { color: #CD7F32; text-shadow: 1px 1px 0 #a05a20; }

    .player-img { width: 60px; height: 60px; border-radius: 50%; object-fit: cover; background-color: #f0f0f0; margin-right: 15px; border: 2px solid #eee; }
    
    .player-info { flex-grow: 1; min-width: 0; }
    .player-name { font-size: 1.2em; font-weight: bold; margin: 0; color: #004a99; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
    .player-name a { text-decoration: none; color: inherit; }
    .team-name { font-size: 0.8em; color: #777; display: block; margin-bottom: 5px;}
    
    /* スタッツ表示 */
    .stats-row {
        display: flex; gap: 8px; font-size: 0.85em; color: #555; flex-wrap: wrap; margin-bottom: 5px;
    }
    .main-stat { font-size: 1.1em; font-weight: 800; color: #333; }
    .stat-item { white-space: nowrap; }
    .score-badge {
        background-color: #f0f0f0; padding: 2px 6px; border-radius: 4px;
        font-size: 0.85em; color: #333; font-weight: bold;
    }

    /* フォームコンテナ */
    .form-card {
        background-color: #fff; padding: 25px; border-radius: 10px;
        box-shadow: 0 2px 5px rgba(0,0,0,0.05); margin-bottom: 20px;
        border: 1px solid #eee;
    }
    .form-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; flex-wrap: wrap; gap: 10px;}
    .form-header h3 { margin: 0; color: #333; }
    
    .btn {
        padding: 10px 20px; border-radius: 5px; cursor: pointer; font-weight: bold; border: none; color: white;
    }
    .btn-primary { background-color: #004a99; }
    .btn-success { background-color: #28a745; }
    .btn-danger { background-color: #dc3545; }
</style>

<div class="mvp-container">
    <h2 style="text-align: center; margin-bottom: 30px; color: #fff; text-shadow: 1px 1px 3px rgba(0,0,0,0.5);">MVP候補 選出ツール</h2>

    <div class="form-card">
        <div class="form-header">
            <h3>現在の公開ステータス: 
                {% if is_mvp_visible %}
                    <span style="color: #28a745;">公開中 (ON)</span>
                {% else %}
                    <span style="color: #dc3545;">非公開 (OFF)</span>
                {% endif %}
            </h3>
            <form method="post" style="margin:0;">
                <input type="hidden" name="action" value="toggle_visibility">
                <input type="hidden" name="current_visibility" value="{{ 'true' if is_mvp_visible else 'false' }}">
                {% if is_mvp_visible %}
                    <button type="submit" class="btn btn-danger">トップページから非表示にする</button>
                {% else %}
                    <button type="submit" class="btn btn-success">トップページに表示する</button>
                {% endif %}
            </form>
        </div>
        <p style="color: #666; font-size: 0.9em;">※「公開中」にすると、保存された週間/月間MVP候補がトップページに表示されます。</p>
    </div>

    <div class="form-card">
        <h3>新規選出 (期間指定)</h3>
        <form method="post" class="date-range-form">
            <input type="hidden" name="action" value="calculate">
            
            <div class="form-group">
                <label>候補タイプ</label>
                <select name="target_type" required>
                    <option value="weekly" {% if target_type == 'weekly' %}selected{% endif %}>週間MVP</option>
                    <option value="monthly" {% if target_type == 'monthly' %}selected{% endif %}>月間MVP</option>
                </select>
            </div>

            <div class="form-group">
                <label>開始日</label>
                <input type="date" name="start_date" value="{{ start_date }}" required>
            </div>
            <div class="form-group">
                <label>終了日</label>
                <input type="date" name="end_date" value="{{ end_date }}" required>
            </div>
            <button type="submit" class="btn btn-primary">候補を計算する</button>
        </form>
    </div>

    {% if top_players_a or top_players_b %}
        <div style="text-align: center; margin-top: 40px; padding-top: 20px; color:white;">
            <h2 style="color: #ffd700; text-shadow: 1px 1px 2px black;">{{ target_type|capitalize }} MVP 候補プレビュー</h2>
            <p>以下の内容でよろしければ「公開・保存」ボタンを押してください。</p>
            
            <form method="post">
                <input type="hidden" name="action" value="publish">
                <input type="hidden" name="start_date" value="{{ start_date }}">
                <input type="hidden" name="end_date" value="{{ end_date }}">
                <input type="hidden" name="target_type" value="{{ target_type }}">
                
                <button type="submit" class="btn btn-success" style="font-size: 1.2em; padding: 15px 40px; margin-bottom: 20px;" 
                        onclick="return confirm('{{ target_type|capitalize }} MVP候補として保存・公開しますか？\n(同じタイプの古いデータは上書きされます)');">
                    この結果を公開・保存する
                </button>
            </form>
        </div>

        <div class="results-grid">
            {% if top_players_a %}
            <div class="league-column league-a">
                <h3>Aリーグ TOP 5</h3>
                {% for row in top_players_a %}
                    {{ render_player_card(row, loop.index) }}
                {% else %}
                    <p style="text-align:center; color:#ccc;">対象データなし</p>
                {% endfor %}
            </div>
            {% endif %}

            {% if top_players_b %}
            <div class="league-column league-b">
                <h3>Bリーグ TOP 5</h3>
                {% for row in top_players_b %}
                    {{ render_player_card(row, loop.index) }}
                {% else %}
                    <p style="text-align:center; color:#ccc;">対象データなし</p>
                {% endfor %}
            </div>
            {% endif %}
        </div>
    {% endif %}
</div>
{% endblock %}