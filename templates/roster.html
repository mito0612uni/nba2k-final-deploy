{% extends "layout.html" %}
{% block content %}
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

<style>
    /* --- ç®¡ç†ç”»é¢å…±é€š --- */
    body { background-color: #f4f6f9; }
    .roster-container { max-width: 1200px; margin: 40px auto; padding: 0 15px; }
    
    .page-header {
        display: flex; align-items: center; justify-content: space-between;
        margin-bottom: 30px; border-bottom: 2px solid #e9ecef; padding-bottom: 15px;
    }
    .page-header h2 { margin: 0; color: #2c3e50; font-weight: 700; font-size: 1.8rem; }

    /* ã‚³ãƒ³ãƒˆãƒ­ãƒ¼ãƒ«ãƒ‘ãƒãƒ«ï¼ˆç™»éŒ²ãƒ»ã‚·ãƒ£ãƒƒãƒ•ãƒ«ç­‰ï¼‰ */
    .control-panel-grid {
        display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 20px;
        margin-bottom: 40px;
    }
    .control-card {
        background: #fff; padding: 25px; border-radius: 12px;
        box-shadow: 0 5px 15px rgba(0,0,0,0.05); border: 1px solid #eee;
    }
    .control-title {
        font-weight: bold; font-size: 1.1em; margin-bottom: 15px; border-bottom: 2px solid #eee;
        padding-bottom: 8px; color: #555;
    }

    .form-row { margin-bottom: 15px; }
    .form-control {
        width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 6px;
        font-size: 0.95em; box-sizing: border-box;
    }
    .btn {
        padding: 10px 20px; border: none; border-radius: 6px; cursor: pointer;
        font-weight: bold; font-size: 0.95em; width: 100%; transition: 0.2s; color: white;
    }
    .btn-primary { background: #007bff; } .btn-primary:hover { background: #0056b3; }
    .btn-success { background: #28a745; } .btn-success:hover { background: #218838; }
    .btn-warning { background: #ffc107; color: #333; } .btn-warning:hover { background: #e0a800; }
    .btn-danger { background: #dc3545; } .btn-danger:hover { background: #c82333; }
    .btn-secondary { background: #6c757d; } .btn-secondary:hover { background: #5a6268; }

    /* ãƒãƒ¼ãƒ ãƒªã‚¹ãƒˆ */
    .league-section { margin-bottom: 40px; }
    .league-title {
        font-size: 1.5em; font-weight: 800; margin-bottom: 20px; padding-left: 10px;
        border-left: 5px solid #333; color: #333;
    }
    .league-a-title { border-color: #c62828; color: #c62828; }
    .league-b-title { border-color: #1565c0; color: #1565c0; }

    .team-grid {
        display: grid; grid-template-columns: repeat(auto-fill, minmax(320px, 1fr)); gap: 20px;
    }
    .team-card {
        background: #fff; border-radius: 10px; overflow: hidden;
        box-shadow: 0 4px 10px rgba(0,0,0,0.05); border: 1px solid #eee;
        transition: transform 0.2s;
    }
    .team-card:hover { transform: translateY(-3px); box-shadow: 0 8px 20px rgba(0,0,0,0.1); }
    
    .team-header {
        padding: 15px; background: #f8f9fa; border-bottom: 1px solid #eee;
        display: flex; align-items: center; justify-content: space-between;
    }
    .team-name-area { display: flex; align-items: center; gap: 10px; }
    .team-logo { width: 40px; height: 40px; object-fit: contain; background: #fff; border-radius: 50%; padding: 2px; border: 1px solid #ddd; }
    .team-name { font-weight: bold; font-size: 1.1em; color: #333; margin: 0; }
    
    .team-body { padding: 15px; }
    
    .player-list { list-style: none; padding: 0; margin: 0; }
    .player-item {
        display: flex; justify-content: space-between; align-items: center;
        padding: 8px 0; border-bottom: 1px dashed #eee; font-size: 0.9em;
    }
    .player-item:last-child { border-bottom: none; }
    
    /* é¸æ‰‹åç·¨é›†ç”¨ã®å…¥åŠ›ãƒ•ã‚©ãƒ¼ãƒ ã‚¹ã‚¿ã‚¤ãƒ« */
    .player-name-input {
        border: 1px solid transparent;
        background: transparent;
        font-size: 1em;
        color: #333;
        width: 100%;
        padding: 2px 5px;
        border-radius: 4px;
        transition: 0.2s;
    }
    .player-name-input:hover { border-color: #ddd; background: #fdfdfd; }
    .player-name-input:focus { border-color: #007bff; background: #fff; outline: none; }
    .player-status-off input { color: #999; text-decoration: line-through; }

    /* ãƒªãƒ¼ã‚°å¤‰æ›´ãƒ•ã‚©ãƒ¼ãƒ  */
    .league-switcher { margin-top: 10px; padding-top: 10px; border-top: 1px solid #eee; text-align: right; }
    .league-select { padding: 5px; border-radius: 4px; border: 1px solid #ddd; font-size: 0.85em; }

    /* å°ã•ã„ãƒœã‚¿ãƒ³ */
    .btn-sm { padding: 4px 8px; font-size: 0.8em; width: auto; display: inline-block; margin-left: 5px; }
    
    /* ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ãƒãƒƒã‚¸ */
    .badge { padding: 3px 8px; border-radius: 10px; font-size: 0.75em; font-weight: bold; }
    .badge-active { background: #d4edda; color: #155724; }
    .badge-inactive { background: #f8d7da; color: #721c24; }
    
    /* ã‚¢ã‚¤ã‚³ãƒ³è‰² */
    .text-success { color: #28a745 !important; }
    .text-secondary { color: #6c757d !important; }
</style>

<div class="roster-container">
    <div class="page-header">
        <h2>ğŸ‘¥ ãƒãƒ¼ãƒ ãƒ»ãƒ­ã‚¹ã‚¿ãƒ¼ç®¡ç†</h2>
    </div>

    <div class="control-panel-grid">
        
        <div class="control-card">
            <div class="control-title">æ–°è¦ãƒãƒ¼ãƒ ç™»éŒ²</div>
            <form method="post" enctype="multipart/form-data">
                <input type="hidden" name="action" value="add_team">
                <div class="form-row">
                    <input type="text" name="team_name" class="form-control" placeholder="ãƒãƒ¼ãƒ å" required>
                </div>
                <div class="form-row">
                    <select name="league" class="form-control" required>
                        <option value="">ãƒªãƒ¼ã‚°é¸æŠ...</option>
                        <option value="Aãƒªãƒ¼ã‚°">Aãƒªãƒ¼ã‚°</option>
                        <option value="Bãƒªãƒ¼ã‚°">Bãƒªãƒ¼ã‚°</option>
                    </select>
                </div>
                <div class="form-row">
                    <label style="font-size:0.9em; color:#666;">ãƒãƒ¼ãƒ ãƒ­ã‚´ (ç”»åƒ)</label>
                    <input type="file" name="logo_image" class="form-control" accept="image/*">
                </div>
                
                <details style="margin-bottom: 15px;">
                    <summary style="cursor:pointer; color:#007bff; font-size:0.9em;">åˆæœŸãƒ¡ãƒ³ãƒãƒ¼ã‚’ä¸€æ‹¬ç™»éŒ² (10æ )</summary>
                    <div style="padding:10px; background:#f9f9f9; border-radius:5px; margin-top:5px; max-height: 200px; overflow-y: auto;">
                        {% for i in range(1, 11) %}
                        <input type="text" name="player_name_{{ i }}" class="form-control" placeholder="é¸æ‰‹å {{ i }}" style="margin-bottom:5px;">
                        {% endfor %}
                    </div>
                </details>

                <button type="submit" class="btn btn-primary">ãƒãƒ¼ãƒ ã‚’ä½œæˆ</button>
            </form>
        </div>

        <div class="control-card">
            <div class="control-title">æ–°è¦é¸æ‰‹ç™»éŒ² / ç§»ç±</div>
            
            <form method="post" style="margin-bottom:20px;">
                <input type="hidden" name="action" value="add_player">
                <div class="form-row">
                    <input type="text" name="player_name" class="form-control" placeholder="é¸æ‰‹å" required>
                </div>
                <div class="form-row">
                    <select name="team_id" class="form-control" required>
                        <option value="">æ‰€å±ãƒãƒ¼ãƒ é¸æŠ...</option>
                        {% for team in teams if team.is_active %}
                        <option value="{{ team.id }}">{{ team.name }}</option>
                        {% endfor %}
                    </select>
                </div>
                <button type="submit" class="btn btn-success">é¸æ‰‹ã‚’è¿½åŠ </button>
            </form>

            <hr style="border-top:1px dashed #ddd; margin: 20px 0;">

            <form method="post">
                <input type="hidden" name="action" value="transfer_player">
                <div class="form-row">
                    <select name="player_id" class="form-control" required>
                        <option value="">ç§»ç±ã™ã‚‹é¸æ‰‹ã‚’é¸æŠ...</option>
                        {% for team in teams %}
                            <optgroup label="{{ team.name }}">
                                {% for player in team.players if player.is_active %}
                                <option value="{{ player.id }}">{{ player.name }}</option>
                                {% endfor %}
                            </optgroup>
                        {% endfor %}
                    </select>
                </div>
                <div class="form-row">
                    <select name="new_team_id" class="form-control" required>
                        <option value="">ç§»ç±å…ˆãƒãƒ¼ãƒ ...</option>
                        {% for team in teams if team.is_active %}
                        <option value="{{ team.id }}">{{ team.name }}</option>
                        {% endfor %}
                    </select>
                </div>
                <button type="submit" class="btn btn-secondary">ç§»ç±ã‚’å®Ÿè¡Œ</button>
            </form>
        </div>

        <div class="control-card">
            <div class="control-title">ãƒªãƒ¼ã‚°ç·¨æˆ & ç®¡ç†è€…è¨­å®š</div>
            
            <div style="background:#fff3cd; padding:15px; border-radius:8px; border:1px solid #ffeeba; margin-bottom:20px;">
                <h5 style="margin-top:0; color:#856404; font-size:1em;">ğŸ”€ ãƒªãƒ¼ã‚°è‡ªå‹•æŒ¯ã‚Šåˆ†ã‘</h5>
                <p style="font-size:0.85em; color:#856404; margin-bottom:10px;">
                    æ´»å‹•ä¸­ã®å…¨ãƒãƒ¼ãƒ ã‚’ãƒ©ãƒ³ãƒ€ãƒ ã«ã‚·ãƒ£ãƒƒãƒ•ãƒ«ã—ã€Aãƒªãƒ¼ã‚°ãƒ»Bãƒªãƒ¼ã‚°ã«å‡ç­‰ã«æŒ¯ã‚Šåˆ†ã‘ã¾ã™ã€‚
                </p>
                <form method="post" onsubmit="return confirm('ã€è­¦å‘Šã€‘\nç¾åœ¨ã®ãƒªãƒ¼ã‚°ç·¨æˆãŒãƒªã‚»ãƒƒãƒˆã•ã‚Œã¾ã™ã€‚\næœ¬å½“ã«å…¨ãƒãƒ¼ãƒ ã‚’ã‚·ãƒ£ãƒƒãƒ•ãƒ«ã—ã¾ã™ã‹ï¼Ÿ');">
                    <input type="hidden" name="action" value="shuffle_leagues">
                    <input type="hidden" name="confirm_shuffle" value="yes">
                    <button type="submit" class="btn btn-warning">ãƒªãƒ¼ã‚°ã‚’ã‚·ãƒ£ãƒƒãƒ•ãƒ«å®Ÿè¡Œ</button>
                </form>
            </div>

            <form method="post">
                <input type="hidden" name="action" value="promote_user">
                <div class="form-row">
                    <input type="text" name="username_to_promote" class="form-control" placeholder="ç®¡ç†è€…ã«ã™ã‚‹ãƒ¦ãƒ¼ã‚¶ãƒ¼ID" list="user_list">
                    <datalist id="user_list">
                        {% for u in users %}
                        <option value="{{ u.username }}">
                        {% endfor %}
                    </datalist>
                </div>
                <button type="submit" class="btn btn-danger">ç®¡ç†è€…æ¨©é™ã‚’ä»˜ä¸</button>
            </form>
        </div>
    </div>

    {% for league_name in ['Aãƒªãƒ¼ã‚°', 'Bãƒªãƒ¼ã‚°', 'ãã®ä»–'] %}
        {% set league_teams = [] %}
        {% for t in teams %}
            {% if t.league == league_name or (league_name == 'ãã®ä»–' and t.league not in ['Aãƒªãƒ¼ã‚°', 'Bãƒªãƒ¼ã‚°']) %}
                {% if league_teams.append(t) %}{% endif %}
            {% endif %}
        {% endfor %}

        {% if league_teams %}
        <div class="league-section">
            <div class="league-title {% if league_name == 'Aãƒªãƒ¼ã‚°' %}league-a-title{% elif league_name == 'Bãƒªãƒ¼ã‚°' %}league-b-title{% endif %}">
                {{ league_name }}
            </div>
            
            <div class="team-grid">
                {% for team in league_teams %}
                <div class="team-card" style="{% if not team.is_active %}opacity:0.6; background:#f0f0f0;{% endif %}">
                    <div class="team-header">
                        <div class="team-name-area">
                            {% if team.logo_image %}
                            <img src="{{ team.logo_image }}" class="team-logo">
                            {% else %}
                            <div class="team-logo" style="display:flex;align-items:center;justify-content:center;font-size:0.6em;color:#ccc;">NoImg</div>
                            {% endif %}
                            <div>
                                <h4 class="team-name">{{ team.name }}</h4>
                                <span class="badge {% if team.is_active %}badge-active{% else %}badge-inactive{% endif %}">
                                    {{ 'Active' if team.is_active else 'Inactive' }}
                                </span>
                            </div>
                        </div>
                        
                        <details style="position:relative;">
                            <summary style="list-style:none; cursor:pointer;">âš™ï¸</summary>
                            <div style="position:absolute; right:0; top:20px; background:#fff; border:1px solid #ddd; padding:10px; border-radius:5px; width:200px; z-index:100; box-shadow:0 5px 10px rgba(0,0,0,0.1);">
                                <form method="post" enctype="multipart/form-data" style="margin-bottom:10px;">
                                    <input type="hidden" name="action" value="update_logo">
                                    <input type="hidden" name="team_id" value="{{ team.id }}">
                                    <label style="font-size:0.8em;">ãƒ­ã‚´å¤‰æ›´:</label>
                                    <input type="file" name="logo_image" style="font-size:0.8em;" onchange="this.form.submit()">
                                </form>
                                <form method="post" style="margin-bottom:5px;">
                                    <input type="hidden" name="action" value="toggle_team_active">
                                    <input type="hidden" name="team_id" value="{{ team.id }}">
                                    <button type="submit" class="btn btn-sm btn-secondary">{{ 'å»ƒéƒ¨ã«ã™ã‚‹' if team.is_active else 'æ´»å‹•å†é–‹' }}</button>
                                </form>
                                <form method="post" onsubmit="return confirm('æœ¬å½“ã«å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰: delete ã‚’å…¥åŠ›');">
                                    <input type="hidden" name="action" value="delete_team">
                                    <input type="hidden" name="team_id" value="{{ team.id }}">
                                    <input type="hidden" name="confirm_delete" value="delete">
                                    <button type="submit" class="btn btn-sm btn-danger">å®Œå…¨å‰Šé™¤</button>
                                </form>
                            </div>
                        </details>
                    </div>

                    <div class="team-body">
                        <ul class="player-list">
                            {% for player in team.players %}
                            <li class="player-item">
                                <form method="post" style="flex-grow: 1; margin-right: 10px;">
                                    <input type="hidden" name="action" value="update_player_name">
                                    <input type="hidden" name="player_id" value="{{ player.id }}">
                                    <div class="{% if not player.is_active %}player-status-off{% endif %}">
                                        <input type="text" name="new_name" value="{{ player.name }}" class="player-name-input" onchange="this.form.submit()" title="ã‚¯ãƒªãƒƒã‚¯ã—ã¦åå‰ã‚’ç·¨é›†">
                                    </div>
                                </form>

                                <div style="display: flex; align-items: center; gap: 5px;">
                                    <form method="post" style="display:inline;">
                                        <input type="hidden" name="action" value="toggle_player_active">
                                        <input type="hidden" name="player_id" value="{{ player.id }}">
                                        <button type="submit" style="background:none; border:none; cursor:pointer; padding: 0;" title="æ´»å‹•/å¼•é€€ åˆ‡æ›¿">
                                            {% if player.is_active %}
                                            <i class="fas fa-toggle-on text-success" style="font-size: 1.3em;"></i>
                                            {% else %}
                                            <i class="fas fa-toggle-off text-secondary" style="font-size: 1.3em;"></i>
                                            {% endif %}
                                        </button>
                                    </form>
                                    <form method="post" style="display:inline;" onsubmit="return confirm('å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ(delete)');">
                                        <input type="hidden" name="action" value="delete_player">
                                        <input type="hidden" name="player_id" value="{{ player.id }}">
                                        <input type="hidden" name="confirm_delete" value="delete">
                                        <button type="submit" style="background:none; border:none; cursor:pointer; color:#dc3545;" title="å‰Šé™¤">
                                            <i class="fas fa-trash-alt"></i>
                                        </button>
                                    </form>
                                </div>
                            </li>
                            {% else %}
                            <li style="color:#999; font-size:0.8em; text-align:center;">æ‰€å±é¸æ‰‹ãªã—</li>
                            {% endfor %}
                        </ul>

                        <div class="league-switcher">
                            <form method="post">
                                <input type="hidden" name="action" value="change_league">
                                <input type="hidden" name="team_id" value="{{ team.id }}">
                                <select name="new_league" class="league-select" onchange="this.form.submit()">
                                    <option value="Aãƒªãƒ¼ã‚°" {% if team.league == 'Aãƒªãƒ¼ã‚°' %}selected{% endif %}>Aãƒªãƒ¼ã‚°ã¸ç§»å‹•</option>
                                    <option value="Bãƒªãƒ¼ã‚°" {% if team.league == 'Bãƒªãƒ¼ã‚°' %}selected{% endif %}>Bãƒªãƒ¼ã‚°ã¸ç§»å‹•</option>
                                </select>
                            </form>
                        </div>
                    </div>
                </div>
                {% endfor %}
            </div>
        </div>
        {% endif %}
    {% endfor %}
</div>
{% endblock %}